<!DOCTYPE html>
<html lang="en-us">

  <head>
  <script type="text/javascript">
    var host = "grahamgilbert.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      graham gilbert &middot; Mac administration and assorted nerdity
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <!--link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico"-->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
  <link href='/stylesheets/all-c8369cf731585eb98eef0098877bca87.css' media='all' rel='stylesheet' type='text/css'>
  <link type="application/atom+xml" rel="alternate" href="https://grahamgilbert.com/atom.xml" title="graham gilbert" />
  <style>
  .clear{
    clear:both
  }
  .float-left {
    float:left;
    padding-right:25px;
    padding-bottom:25px;
  }

  .float-right {
    float:right;
    padding-left:25px;
    padding-bottom:25px;
  }
  </style>
</head>

  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          graham gilbert
        </a>
      </h1>
      <p class="lead">A Mac admin, automating the hell out of things in London.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/talks/">Talks</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
      </nav>
      <p>

      <a href="https://twitter.com/grahamgilbert"><img style="display:inline;" src="/images/social/twitter.png" /></a> <a href="https://github.com/grahamgilbert"><img style="display:inline;" src="/images/social/github.png" /></a> <a href="https://www.linkedin.com/in/grahamgilbert"><img style="display:inline;" src="/images/social/linkedin.png" /></a>
      </p>

    <p>
      <small>The opinions on this site are my own, and are not necessarily shared by my employer.</small>
    </p>

  </div>
</div>

    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2014/11/07/slides-and-notes-from-twisting-munki/">
        Slides and notes from Twisting Munki
      </a>
    </h1>

    <span class="post-date">07 Nov 2014</span>


    
  <p>Firstly, thanks if you came to my talk and putting up with me! You can get my slides and code from the <a href="https://github.com/grahamgilbert/mactech_2014">GitHub repository</a>.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2014/10/21/first-boot-pkg-updated-for-yosemite/">
        first-boot-pkg updated for Yosemite
      </a>
    </h1>

    <span class="post-date">21 Oct 2014</span>


    
  <p>It seems like Yosemite introduced an <a href="https://github.com/munki/createOSXinstallPkg#further-note-on-additional-packages-and-yosemite">undocumented change</a> that requires any packages that are added an OS X installer (e.g. Netinstall or createOSXinstallPkg) be distribution style packages, or you get a nasty failure acompanied by one of the most unhelpful error messages ever.</p>

<p>To fix this, <a href="https://github.com/grahamgilbert/first-boot-pkg">first-boot-pkg</a> now builds distribution style packages.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2014/08/24/london-apple-admins/">
        London Apple Admins
      </a>
    </h1>

    <span class="post-date">24 Aug 2014</span>


    
  <p>I’m delighted to say that the first (first meet that isn’t “let’s go to the pub and get drunk”, anyway!) <a href="http://www.londonappleadmins.org.uk">London Apple Admins</a> meetup is happening on the 3rd September at <a href="http://theredherring.co.uk/">The Red Herring in St Pauls</a>. I’d like to take all of the credit for organising it, but it was down to the hard work of <a href="http://macmule.com">Ben Toms</a>. The theme this time is “this is what I’m working on at the moment”, so I’ll be talking about my new favourite toy, <a href="https://www.docker.com">Docker</a>.</p>

<p>If you’ll be in or around London on the 3rd September, <a href="https://www.eventbrite.com/e/london-apple-admins-sept-2014-tickets-12545591201">please get yourself a ticket</a> (they’re free) and come and have a beer or two whilst listening to some awesome talks by London based Mac Admins.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2014/07/27/personal-automation-munki-part-2/">
        Personal Automation: Munki (Part 2)
      </a>
    </h1>

    <span class="post-date">27 Jul 2014</span>


    
  <p>The first step to getting any Mac set up is to get some software onto it. I’m not going to cover how to set up <a href="https://code.google.com/p/munki/wiki/GettingStartedWithMunki">Munki</a> or <a href="https://github.com/autopkg/autopkg/wiki/Getting-Started">AutoPkg</a> - there are lots of other places for that information.</p>

<p>As a sysadmin, I’m forever testing things. Rather than destroy my own machine, I like to do this in Virtual Machines. My preferred virtualisation solution is VMware Fusion, but unfortunately it’s not very easy to deploy out of the box. You need to do a little bit of work to get it into a package that you can import into Munki, but fortunately the process is <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=2058680">well documented on VMware’s site</a>.</p>

<p>The next piece of ‘non standard’ software I need is <a href="http://brew.sh">Homebrew</a>. The installation method listed on their site is to run a terminal command as the current user. The first part of this is obviously fine - Munki has several methods to run scripts (payload free packages, nopkg), but it runs everything as root. Fortunately, as I’m deploying my own machine, I can make some assumptions about where Homebrew will be installed. The first assumption I can make is that there will only be one user on the machine, and the second is that I’m going to be logged in most of the time (as my laptop is encrypted, it’s either off or logged in).</p>

<p>I’m going to utilise a <code>nopkg</code> pkginfo file to perform the installation. The first part of our script to install Homebrew is to make sure that a user (me!) is logged in. Homebrew doesn’t like being owned by root, so first we need to make sure that there is a user logged in.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#!/bin/bash</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">CURRENT_USER</span><span class="o">=</span><span class="sb">`</span>/bin/ls -l /dev/console <span class="p">|</span> /usr/bin/awk <span class="s1">&#39;&#x7b; print $3 &#x7d;&#39;</span><span class="sb">`</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$CURRENT_USER&quot;</span> <span class="o">==</span> <span class="s1">&#39;root&#39;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># this can&#39;t run at the login window, we need the current user</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nb">exit </span>1
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">fi</span></div></div></pre></div></figure>

<p>So now we know that there’s a user logged in, and who that user is. Time to install Homebrew as the current user.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p /usr/local
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p /usr/local/homebrew
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p /usr/local/bin
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">chown <span class="nv">$CURRENT_USER</span>:_developer /usr/local/homebrew
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">chown <span class="nv">$CURRENT_USER</span>:_developer /usr/local/bin
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#download and install homebrew</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">su <span class="nv">$CURRENT_USER</span> -c <span class="s2">&quot;/bin/bash -o pipefail -c &#39;/usr/bin/curl -skSfL https://github.com/mxcl/homebrew/tarball/master | (cd /usr/local ; /usr/bin/tar xz -m --strip 1 -C homebrew; ln -s /usr/local/homebrew/bin/brew /usr/local/bin/brew)&#39;&quot;</span></div></div></pre></div></figure>

<p>As we’re using a <code>nopkg</code> with Munki rather than a payload free package, we’ve not left any receipts, so Munki doesn’t know if Homebrew is installed. We’re going to use an installs array to tell Munki what to look for when determining whether Homebrew is installed or not.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;key&gt;</span>installs<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;array&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">		<span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>path<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span>/usr/local/bin/brew<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>type<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span>file<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">		<span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;/array&gt;</span></div></div></pre></div></figure>

<p>You might be crying “but Homebrew needs the Xcode Command Line Tools installed!” - and you’d be 100% correct. You have the option of importing the downloaded package into Munki, but I have adapted <a href="https://github.com/timsutton/osx-vm-templates/blob/master/scripts/xcode-cli-tools.sh">Tim Sutton’s script</a> into a <code>nopkg</code>. To find out what’s installed, I ran <a href="http://www.fernlightning.com/doku.php?id=software%3afseventer%3astart">fseventer</a> and chose a random file to act as my installs array. I’ve posted the pkginfos for both the <a href="https://github.com/grahamgilbert/macscripts/blob/master/Munki/pkginfos/Xcode/XcodeCLITools-2014.07.15.plist">Xcode CLI tools</a> and all of the <a href="https://github.com/grahamgilbert/macscripts/tree/master/Munki/pkginfos/Homebrew">Homebrew installs</a> on Github.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2014/07/26/personal-automation-part-1/">
        Personal Automation (Part 1)
      </a>
    </h1>

    <span class="post-date">26 Jul 2014</span>


    
  <p><a href="http://grahamgilbert.com/blog/2014/04/04/updating-boxen/">Earlier this year</a>, I professed my love of Boxen - the personal automation solution based on Puppet released by Github. Indeed, it served me well for quite some time, but I began to find myself spending more time fixing Boxen than actually getting things done. As Boxen was designed for internal use at Github, it set some things up how they liked them - which wasn’t necesarily how I liked them. Sysadmins have similar needs to developers, but not exactly the same.</p>

<p>Then I updated Boxen. All of my modules were out of date, so I spent a good couple of hours updating all of them so they worked again. Ugh.</p>

<p>So I started looking at moving to my own solution. One of my major irritations when using Boxen was that it didn’t really handle updating your apps - you got whatever version the module author decided to install and then you had to hope that there was an updatng mechanism built in. I’ve said before that there is no better method of getting software onto your Mac then Munki, so the first decison was straightforward. The rest took a little thought.</p>

<h2 id="the-six-ps">The six P’s</h2>

<p>My first requirement was that I shouldn’t need to run anything to get my configuration to apply. Boxen requires that you run the <code>boxen</code> command periodically across each of your Macs to get the configuration applied. This wasn’t always practical. I needed something that would run in the background and keep itself up to date.</p>

<p>As I said before, I really disliked how Boxen installs software. Munki does a much better job, and AutoPkg makes it trivial to make sure you have the latest software version. Being a sysadmin, I need more than simple drag and drop apps and packages though - I make extensive use of <a href="http://brew.sh">Homebrew</a> to install command line tools like <a href="http://packer.io">Packer</a>, so I needed to come up with a way of installing these with Munki.</p>

<p>However, Munki isn’t the best tool for managing my configuration. I’ve been using Puppet to manage the Macs  I look after for nearly three years now, and I wanted to base my system on it as I’ve already done a lot of the work with making OS X specific modules. I also wanted to use the modules made for Boxen as much as possible (some made too many assumptions about where they were running, so couldn’t be re-used.</p>

<p>So to recap:</p>

<ul>
  <li>Munki for software deployment.</li>
  <li>Puppet must run in the background periodically</li>
  <li>The configuration must update itself - I don’t want to have to sync code across machines.</li>
  <li>Where possible, re-use existing Puppet modules</li>
</ul>

<p>Over the next few posts, I’ll go over the different parts of this solution, how I put it together and how you might be able to use this.</p>


  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page10">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page8">Newer</a>
    
  
</div>

    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27233739-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
