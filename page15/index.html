<!DOCTYPE html>
<html lang="en-us">

  <head>
  <script type="text/javascript">
    var host = "grahamgilbert.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      graham gilbert &middot; Mac administration and assorted nerdity
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <!--link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico"-->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
  <link href='/stylesheets/all-c8369cf731585eb98eef0098877bca87.css' media='all' rel='stylesheet' type='text/css'>
  <link type="application/atom+xml" rel="alternate" href="https://grahamgilbert.com/atom.xml" title="graham gilbert" />
  <style>
  .clear{
    clear:both
  }
  .float-left {
    float:left;
    padding-right:25px;
    padding-bottom:25px;
  }

  .float-right {
    float:right;
    padding-left:25px;
    padding-bottom:25px;
  }
  </style>
</head>

  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          graham gilbert
        </a>
      </h1>
      <p class="lead">A Mac admin, automating the hell out of things.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/talks/">Talks</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
      </nav>
      <p>

      <a href="https://twitter.com/grahamgilbert"><img style="display:inline;" src="/images/social/twitter.png" /></a> <a href="https://github.com/grahamgilbert"><img style="display:inline;" src="/images/social/github.png" /></a> <a href="https://www.linkedin.com/in/grahamgilbert"><img style="display:inline;" src="/images/social/linkedin.png" /></a>
      </p>

    <p>
      <small>The opinions on this site are my own, and are not necessarily shared by my employer.</small>
    </p>

  </div>
</div>

    <div class="content container">
      <div class="posts">
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2013/04/07/one-bootstrap-package-to-rule-them-all/">
        One bootstrap package to rule them all
      </a>
    </h1>

    <span class="post-date">07 Apr 2013</span>


    
  <p>At work, we’ve recently changed how we build our bootstrap package to having the main code that connects a Mac to our Puppet infrastructure pulled down from GitHub when the client boots up for the first time.</p>

<h2 id="why">Why?</h2>

<p>This might sound like madness to you. Why would anyone want to do this? We had two main issues to solve:</p>

<ul>
  <li>I got sick of rebuilding our images every time our bootstrap script changed.</li>
  <li>Our engineers got sick of downloading the latest version of our package every time they thin / no-imaged a Mac.</li>
</ul>

<p>Why would our script change so much? In our case, it is to install the latest versions of Puppet and Facter. This isn’t strictly necessary, as we update Puppet and Facter with Munki, but occasionally there will be something in our Puppet config that requires a specific version - for example, when we started configuring usernames on 10.8 Macs with Puppet, the <code>salt</code> parameter was introduced. This required Puppet 3.0.2-ish or higher - which meant that any NetRestore image or old package that contained a version of Puppet lower than this would fail, and the engineer on site was in for a world of pain.</p>

<h2 id="ok-im-convinced">Ok, I’m convinced.</h2>

<p>I’ve put an <a href="https://github.com/grahamgilbert/macscripts/tree/master/Puppet-Bootstrap">example up on GitHub</a>. This is a sanitised version of the bootstrap script we use at pebble.it. All we do in the script that gets deployed to the client is set the address of our Puppet server and then pull the rest of the script from GitHub - if you don’t need to set any variables, you could do all of the work in the remote script.</p>

<p>So this can be used with all of the deployment methods we use at pebble.it (<a href="https://code.google.com/p/instadmg/">imaging</a>, <a href="http://managingosx.wordpress.com/2012/07/25/son-of-installlion-pkg/">createOSXinstallPkg</a> and no imaging), we do the actual work in a script that is triggered by a launch daemon, so we can be sure we’re a) performing the work in a full OS X environment (we need Python to be available for our script) and that we’re running it on the boot volume of the client Mac (we need the serial number, and this could be installed via Target Disk Mode when no-imaging.</p>

<p>So when the bootstrap script needs to be updated, rather than rebuilding the package and distributing it to engineers and baking it into images, the workflow becomes:</p>

<ol>
  <li>Update script, push to GitHub.</li>
  <li>Restore image with <a href="https://github.com/grahamgilbert/macscripts/tree/master/Puppet-Bootstrap">puppet_bootstrap.pkg</a> baked in or install the package manually.</li>
  <li>Mac boots, downloads the latest version of <a href="https://github.com/grahamgilbert/macscripts/tree/master/Puppet-Install"><code>install_puppet.py</code></a>.</li>
  <li><code>install_puppet.py</code> downloads and installs the correct versions of Puppet and Facter and configures Puppet.</li>
  <li>Puppet downloads, installs and configures Munki along with all of the other configuration.</li>
  <li>PROFIT</li>
</ol>

<p>This clearly isn’t required or suitable for all types of script - but if you have a package that is frequently updated and you have staff installing it by hand, this is a relatively simple way to make sure they’ve got the latest version at all times.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2013/04/02/facter-101/">
        Facter 101
      </a>
    </h1>

    <span class="post-date">02 Apr 2013</span>


    
    <p>Facter is what gives Puppet it’s brains. It collects information about the computer it is run on and then passes it to the Puppet Master for use in manifests and can optionally be stored. I know, it doesn’t sound like the most earth shattering revelation of all time, but stop for a moment. Every time your current scripts need to taget a specific OS version or a machine with a certain bit of hardware, you need to code it directly into the script. If the method of extracting that information changes, you need to modify every single script that uses that method. With Facter, you’re editing one file, which is always up to date on the client. Anyway, that’s enough waffle from me. Let’s get started.
  <p><a href="/blog/2013/04/02/facter-101/">Read more →</a></p>
  
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2013/03/05/getting-started-with-puppet-on-os-x-part-4/">
        Getting Started With Puppet on OS X (Part 4)
      </a>
    </h1>

    <span class="post-date">05 Mar 2013</span>


    
    <p>We’ve made quite a bit of progress with our Puppet install. We’ve already made Puppet do something useful with setting up an admin user, but let’s get back to being lazy - let’s get someone else to write the code.</p>

<p>Before reading this post, you really need to read <a href="http://grahamgilbert.com/blog/2013/01/25/getting-started-with-puppet-part-1/">part 1</a>, <a href="http://grahamgilbert.com/blog/2013/01/27/getting-started-with-puppet-on-os-x-part-2/">part 2</a> and <a href="http://grahamgilbert.com/blog/2013/02/24/getting-started-with-puppet-on-os-x-part-3/">part 3</a> of the series.</p>

<p>Modules are little pre-built bits of Puppet code. They’re a good example of Puppet’s philosophy of convention over configuration - Puppet will assume your modules follow a set pattern. We’ll be using two of the available folders in modules today: files and manifests. Files are static files that Puppet will copy over to our client machine, and manifests will contain the Puppet code we’ve previously been putting into <code>/etc/puppet/manifests/site.pp</code> - whilst it’s been easy to put code into this file, it can become unwieldy when you have a few nodes to manage.</p>

<p>There are also loads of pre-built modules on the <a href="http://forge.puppetlabs.com/">Puppet Forge</a> - it’s one of these modules we’ll be using today.
  <p><a href="/blog/2013/03/05/getting-started-with-puppet-on-os-x-part-4/">Read more →</a></p>
  
  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2013/02/24/getting-started-with-puppet-on-os-x-part-3/">
        Getting Started With Puppet on OS X (Part 3)
      </a>
    </h1>

    <span class="post-date">24 Feb 2013</span>


    
  <p>In this post, we’ll do something pretty much all Mac admins will need to do - set up their admin user. Bust first, a little housekeeping.</p>

<p>Before reading this post, you really need to read <a href="http://grahamgilbert.com/blog/2013/01/25/getting-started-with-puppet-part-1/">part 1</a>, <a href="http://grahamgilbert.com/blog/2013/01/27/getting-started-with-puppet-on-os-x-part-2/">part 2</a> and most importantly my post on <a href="http://grahamgilbert.com/blog/2013/02/13/building-a-test-puppet-master-with-vagrant/">building a Puppet Master with Vagrant</a>. The Puppet Labs provided VM won’t cut it here, we need the latest version of Puppet on our Master. If you are using the same Mac / OS X VM that was previously hooked up to the Puppet Master VM, you will need to run the following command on the client - don’t worry, it will get new certificates from your very own Puppet Master:</p>

<pre><code>sudo rm -rf /var/lib/puppet/ssl
</code></pre>

<p>Make sure your test Mac is pointing to the right server - unless you’ve changed your Vagrantfile, your Puppet Master’s IP address will be 192.168.33.10 - you will need to change your test Mac’s /etc/hosts file to reflect this change.</p>

<p><strong>Updates from the previous post:</strong> Since the last post was published, Puppet version 3.1 has been released - the main bonus to Mac users is that the Puppet user and group are now created, so the manual Puppet run command is a little shorter. What was this:</p>

<pre><code>sudo puppet agent --test --group 0
</code></pre>

<p>Can now be shortened to:</p>

<pre><code>sudo puppet agent --test
</code></pre>

<p>As the Puppet user and group now exist, you no longer need to run Puppet as root. This creates another issue (the Puppet user is visible at the login screen despite it not being able to log in), but we’ll get around that in this article. Regardless, you want to install <a href="http://downloads.puppetlabs.com/mac/">Puppet 3.1</a>. Back to the main event.</p>

<p>First thing’s first, create your admin user. I’ve called mine “Local Administrator”, with a short name of “ladmin” and the very imaginative passord of “password”. Next open up a Terminal window on your puppetclient Mac and issue the following command:</p>

<pre><code>sudo puppet resource user ladmin
</code></pre>

<p>You’ll see output similar to this:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">site.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">user</span> <span class="p">&#x7b;</span> <span class="s1">&#39;ladmin&#39;</span><span class="p">:</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="k">ensure</span>     <span class="o">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">comment</span>    <span class="o">=&gt;</span> <span class="s1">&#39;Local Admin&#39;</span><span class="p">,</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">gid</span>        <span class="o">=&gt;</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">groups</span>     <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;_appserveradm&#39;</span><span class="p">,</span> <span class="s1">&#39;_appserverusr&#39;</span><span class="p">,</span> <span class="s1">&#39;_lpadmin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="o">]</span><span class="p">,</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">home</span>       <span class="o">=&gt;</span> <span class="s1">&#39;/Users/ladmin&#39;</span><span class="p">,</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">iterations</span> <span class="o">=&gt;</span> <span class="s1">&#39;21881&#39;</span><span class="p">,</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">password</span>   <span class="o">=&gt;</span> <span class="s1">&#39;401e3aa796b3bfff2c8e929a003b727be1bd548aa0f0b0e131f0d11f3953162be210200a70872734a28be747a933e12e2458ffdcc60d209eab9e006a9f4042dc883148070e6e8ad05f4a5e5d44bd0ddfc9494482f0d16c9d5eb1de086183db1b89df9982d2856eeed431d65e03ff99177c3185aa61bc926b1a0020c49621ddd8&#39;</span><span class="p">,</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">salt</span>       <span class="o">=&gt;</span> <span class="s1">&#39;0c3cd42b97d0b0df45542fcb5961a2920f2fd6204aa151bf08d762d9dd44fd0c&#39;</span><span class="p">,</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">shell</span>      <span class="o">=&gt;</span> <span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="n">uid</span>        <span class="o">=&gt;</span> <span class="s1">&#39;502&#39;</span><span class="p">,</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>That looks suspiciously like Puppet code. Let’s try it.</p>

<p>With the Vagrant based Puppet Master, the manifests file that previously lived at /etc/puppet/manifests is now located on your Mac at puppet/manifests (as is the modules folder, Vagrant takes care of linking it to the right place on the VM). Open up puppet/manifests/sites.pp in your favourite text editor (for the love of all that’s holy, please don’t use TextEdit. Try TextWrangler, or my current favourite <a href="http://www.chocolatapp.com/">Chocolat</a>).</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">site.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">node</span> <span class="n">puppetclient</span> <span class="p">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="n">user</span> <span class="p">&#x7b;</span> <span class="s1">&#39;ladmin&#39;</span><span class="p">:</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="k">ensure</span>     <span class="o">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">comment</span>    <span class="o">=&gt;</span> <span class="s1">&#39;Local Admin&#39;</span><span class="p">,</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">gid</span>    <span class="o">=&gt;</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">groups</span>     <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;_appserveradm&#39;</span><span class="p">,</span> <span class="s1">&#39;_appserverusr&#39;</span><span class="p">,</span> <span class="s1">&#39;_lpadmin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="o">]</span><span class="p">,</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">home</span>       <span class="o">=&gt;</span> <span class="s1">&#39;/Users/ladmin&#39;</span><span class="p">,</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">iterations</span> <span class="o">=&gt;</span> <span class="s1">&#39;21881&#39;</span><span class="p">,</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">password</span>   <span class="o">=&gt;</span> <span class="s1">&#39;401e3aa796b3bfff2c8e929a003b727be1bd548aa0f0b0e131f0d11f3953162be210200a70872734a28be747a933e12e2458ffdcc60d209eab9e006a9f4042dc883148070e6e8ad05f4a5e5d44bd0ddfc9494482f0d16c9d5eb1de086183db1b89df9982d2856eeed431d65e03ff99177c3185aa61bc926b1a0020c49621ddd8&#39;</span><span class="p">,</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">salt</span>       <span class="o">=&gt;</span> <span class="s1">&#39;0c3cd42b97d0b0df45542fcb5961a2920f2fd6204aa151bf08d762d9dd44fd0c&#39;</span><span class="p">,</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">shell</span>      <span class="o">=&gt;</span> <span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">uid</span>        <span class="o">=&gt;</span> <span class="s1">&#39;502&#39;</span><span class="p">,</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="p">&#x7d;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>Save it, and then back on your client perform a Puppet run:</p>

<pre><code>sudo puppet agent --test
</code></pre>

<p>Of course nothing has changed - that’s because your client’s configuration is how you have described it in site.pp. Try changing ladmin’s password in system preferences, then perform another Puppet run. You’ll see Puppet change the password right back.</p>

<p>Now we’ve got our Local Admin user working, it might be nice to hide it away from inquisitive users. The first step is to change our Local Admin’s UID to something lower than 500 - I like 404 (nerd joke), and then for good measure, we’ll move the home folder out of /Users and into /var.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">site.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">node</span> <span class="n">puppetclient</span> <span class="p">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="n">user</span> <span class="p">&#x7b;</span> <span class="s1">&#39;ladmin&#39;</span><span class="p">:</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="k">ensure</span>     <span class="o">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">comment</span>    <span class="o">=&gt;</span> <span class="s1">&#39;Local Admin&#39;</span><span class="p">,</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">gid</span>        <span class="o">=&gt;</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">groups</span>     <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;_appserveradm&#39;</span><span class="p">,</span> <span class="s1">&#39;_appserverusr&#39;</span><span class="p">,</span> <span class="s1">&#39;_lpadmin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="o">]</span><span class="p">,</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">home</span>       <span class="o">=&gt;</span> <span class="s1">&#39;/var/ladmin&#39;</span><span class="p">,</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">iterations</span> <span class="o">=&gt;</span> <span class="s1">&#39;21881&#39;</span><span class="p">,</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">password</span>   <span class="o">=&gt;</span> <span class="s1">&#39;401e3aa796b3bfff2c8e929a003b727be1bd548aa0f0b0e131f0d11f3953162be210200a70872734a28be747a933e12e2458ffdcc60d209eab9e006a9f4042dc883148070e6e8ad05f4a5e5d44bd0ddfc9494482f0d16c9d5eb1de086183db1b89df9982d2856eeed431d65e03ff99177c3185aa61bc926b1a0020c49621ddd8&#39;</span><span class="p">,</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">salt</span>       <span class="o">=&gt;</span> <span class="s1">&#39;0c3cd42b97d0b0df45542fcb5961a2920f2fd6204aa151bf08d762d9dd44fd0c&#39;</span><span class="p">,</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">shell</span>      <span class="o">=&gt;</span> <span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">uid</span>        <span class="o">=&gt;</span> <span class="s1">&#39;404&#39;</span><span class="p">,</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="p">&#x7d;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>That gets the home folder moved, now to actually hide the home folder. Add this just before the closing } (curly bracket) in your site.pp:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">site.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">exec</span> <span class="p">&#x7b;</span><span class="s1">&#39;Hide sub-500 users&#39;</span><span class="p">:</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/defaults write /Library/Preferences/com.apple.loginwindow Hide500Users -bool TRUE&quot;</span><span class="p">,</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>When you perform a Puppet run, you’ll notice that your command is run every time, regardless of whether it needs to. We only really need to run that when we change our Local Admin user. To do that, we’ll change two lines. When the Admin User changes, we’ll send a signal to the exec, and we’ll change the exec to only run when it is told to.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">site.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">node</span> <span class="n">puppetclient</span> <span class="p">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="n">user</span> <span class="p">&#x7b;</span> <span class="s1">&#39;ladmin&#39;</span><span class="p">:</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="k">ensure</span>     <span class="o">=&gt;</span> <span class="s1">&#39;present&#39;</span><span class="p">,</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">comment</span>    <span class="o">=&gt;</span> <span class="s1">&#39;Local Admin&#39;</span><span class="p">,</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">		<span class="n">gid</span>        <span class="o">=&gt;</span> <span class="s1">&#39;20&#39;</span><span class="p">,</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">groups</span>     <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;_appserveradm&#39;</span><span class="p">,</span> <span class="s1">&#39;_appserverusr&#39;</span><span class="p">,</span> <span class="s1">&#39;_lpadmin&#39;</span><span class="p">,</span> <span class="s1">&#39;admin&#39;</span><span class="o">]</span><span class="p">,</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">home</span>       <span class="o">=&gt;</span> <span class="s1">&#39;/var/ladmin&#39;</span><span class="p">,</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">iterations</span> <span class="o">=&gt;</span> <span class="s1">&#39;21881&#39;</span><span class="p">,</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">password</span>   <span class="o">=&gt;</span> <span class="s1">&#39;401e3aa796b3bfff2c8e929a003b727be1bd548aa0f0b0e131f0d11f3953162be210200a70872734a28be747a933e12e2458ffdcc60d209eab9e006a9f4042dc883148070e6e8ad05f4a5e5d44bd0ddfc9494482f0d16c9d5eb1de086183db1b89df9982d2856eeed431d65e03ff99177c3185aa61bc926b1a0020c49621ddd8&#39;</span><span class="p">,</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">salt</span>       <span class="o">=&gt;</span> <span class="s1">&#39;0c3cd42b97d0b0df45542fcb5961a2920f2fd6204aa151bf08d762d9dd44fd0c&#39;</span><span class="p">,</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">shell</span>      <span class="o">=&gt;</span> <span class="s1">&#39;/bin/bash&#39;</span><span class="p">,</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">uid</span>        <span class="o">=&gt;</span> <span class="s1">&#39;404&#39;</span><span class="p">,</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">  		<span class="n">notify</span>     <span class="o">=&gt;</span> <span class="no">Exec</span><span class="o">[</span><span class="s1">&#39;Hide sub-500 users&#39;</span><span class="o">]</span><span class="p">,</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="p">&#x7d;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">	    <span class="nb">exec</span> <span class="p">&#x7b;</span><span class="s1">&#39;Hide sub-500 users&#39;</span><span class="p">:</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">&quot;/usr/bin/defaults write /Library/Preferences/com.apple.loginwindow Hide500Users -bool TRUE&quot;</span><span class="p">,</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">refreshonly</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">,</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">&#x7d;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>Save it, and perform a Puppet run on your client.You’ll notice that the defaults command is now only run when Puppet needs to modify the user.</p>

<p>Next time, we’ll be taking a look at Modules - pre-built bits of Puppet code that you can plug into your workflow to save you re-inventing the wheel.</p>


  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="/blog/2013/02/13/building-a-test-puppet-master-with-vagrant/">
        Building a test Puppet Master with Vagrant
      </a>
    </h1>

    <span class="post-date">13 Feb 2013</span>


    
  <p>Puppet is awesome. Until you deploy some code that worked locally, but for some reason didn’t when you put it onto your Puppet Master. Whoops.</p>

<p>So, you need a testing setup. But Puppet can take a while to keep configuring. Which is where <a href="http://www.vagrantup.com">Vagrant</a> comes in. It it a tool which allows you to build virtual machines automatically (currently only with VirtualBox, but VMWare Fusion support is coming very soon). And the best part (for me, anyway) is that it uses Puppet to configure the VM (Puppet to configure your Puppet Master? All too meta for this time of the morning).</p>

<p>Anyway, that’s enough waffle - the Vagrant configuration is up on my <a href="https://github.com/grahamgilbert/vagrant-puppetmaster">GitHub</a>.</p>

<p>If you are following along with my series on getting started with Puppet on OS X, you can replace the Puppet Labs provided VM with this setup (which would be a good idea, as the Enterprise version is a few versions behind the Open Source version, missing some features when managing Macs).</p>

<p>This testing setup includes:</p>

<ul>
  <li>A Puppet Master running using the built in web server (fine for testing, not enough poke for a production server)</li>
  <li>Puppet Dashboard (we all love a GUI, right?)</li>
  <li>PuppetDB (this will store data about your nodes, and then hooks into the Dashboard to display it)</li>
</ul>

<p>To get up and running quickly, you will need:</p>

<ul>
  <li><a href="https://www.virtualbox.org/wiki/Downloads">VirtualBox</a></li>
  <li><a href="http://downloads.vagrantup.com/">Vagrant</a></li>
</ul>

<p>Once those are installed, cd into the directory where you keep your code (mine lives in ~/Documents/Code), clone the repo and then tell Vagrant to bring the VM up.</p>

<pre><code>cd ~/Documents/Code
git clone https://github.com/grahamgilbert/vagrant-puppetmaster.git
cd vagrant-puppetmaster
vagrant up
</code></pre>

<p>If you don’t have the base box Ubuntu box downloaded, Vagrant will pull it down for you and cache the clean VM for you. It will then make a copy, run the script that installs the latest version of Puppet, then run through the Puppet code that will configure the VM to be a Puppet Master for you. Once the VM is running, you can place your modules and manifests in <code>puppet/modules</code> and <code>puppet/manifests</code>, respectively. The dashboard is accessible at <a href="http://192.168.33.10:3000">http://192.168.33.10:3000</a>.</p>

<p><strong>This VM is not suitable for production.</strong> I’ve made several tweaks to the configuration that makes it easier to test your code, but would be a security risk if used on a production server. <strong>Only use this configuration for testing.</strong> We’re also installing everything onto one VM - you probably want to separate this out into at least two boxes in production, maybe even three if you have a large deployment. Like I said, the idea here is to quickly set up a testing environment that behaves like our production environment.</p>


  </div>
  
</div>

<div class="pagination">
  
    <a class="pagination-item older" href="/page16">Older</a>
  
  
    
      <a class="pagination-item newer" href="/page14">Newer</a>
    
  
</div>

    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27233739-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
