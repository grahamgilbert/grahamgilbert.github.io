<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Kerio Connect vs Web Services in Lion Server &#8211; graham gilbert dot com</title>
<meta name="description" content="The problem

Lion Server takes over every ethernet interface when you enable any web services (Web, Wiki, Profile Manager, basically anything!). This leaves us with two options: putting Kerio on a non-standard port and getting the users to type that in every time, or completely disabling apache and not using any of the good stuff that came with Lion Server. Or, we could work out a way to redirect users to the right port number when they hit mail.example.com

Enter Reverse Proxy. This takes the request for the mail.example.com virtual host, and redirects it to our custom HTTPS port (8843).

How to do it

The files you need are on my GitHub. Replace mail.example.com with the FQDN of your mail server.


  Set up your lion server first. Configure SSL certificates, OD and web services the way you like it.
  Export your private key for the signed SSL certificate from the keychain.
  Install Kerio Connect. Import the private key and your signed certificate.
  Set Kerio to use only port 8800 for HTTP and 8843 for HTTP and HTTPS, respectively.
  Set Kerio to bind it’s services to All Interfaces rather than a specific IP address. (I’ve found that services won’t start when it’s listening on all IPs, but will when it can listen to all - don’t ask me why!)
  In Server.app, configure mail.example.com in Web. Set it to use port 443, set the root folder to whatever you want (it won’t be used).
  In Hardware, set the virtual host you just created to use the right ssl cert.
  In terminal: cd /path/to/the/files/you/downloaded
  In terminal again: sudo cp httpd_kerio.conf /etc/apache2/httpd_kerio.conf
  And again: sudo cp webapps/com.grahamglbert.kerio.plist /etc/apache2/webapps/com.grahamglbert.kerio.plist
  One last time: sudo webappctl start com.grahamgilbert.kerio mail.example.com


What’s happening

By default, when you specify a vhost to use ssl in lion server, any requests to port 80 are redirected to 443. Once it’s wrapped in ssl, it’s redirected transparently to 8843, so the user is sent to the webmail login.

The plist file is the core of the webapp mechanism that was introduced with lion server. Within that all we’re doing is importing the httpd_kerio.conf file (which just has a standard apache reverse proxy directive) and telling the app to always use ssl. The webappctl command is simply telling the webapp mechanism to load our plist and start it on the mail.example.com vhost.

Known Issues

Entourage

Entourage accounts will need to be reconfigured with the Kerio setup tool. They don’t seem to like communicating with the server over port 443 when the reverse proxy is running - they will have issues sending email.

Kerio Services

The services in Kerio Admin will need to be set to run on All Interfaces rather than a set IP address, as they won’t start on a specific address (it is unknown whether this is because of the reverse proxy / webapp process or if this is a general Lion issue). If the service has stopped, the webapp will need to be restarted:

sudo webappctl stop com.grahamgilbert.kerio mail.example.com
sudo webappctl start com.grahamgilbert.kerio mail.example.com


">
<meta name="keywords" content="10.7, kerio connect, lion, server, web, webappctl">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Kerio Connect vs Web Services in Lion Server">
<meta name="twitter:description" content="The problem

Lion Server takes over every ethernet interface when you enable any web services (Web, Wiki, Profile Manager, basically anything!). This leaves us with two options: putting Kerio on a non-standard port and getting the users to type that in every time, or completely disabling apache and not using any of the good stuff that came with Lion Server. Or, we could work out a way to redirect users to the right port number when they hit mail.example.com

Enter Reverse Proxy. This takes the request for the mail.example.com virtual host, and redirects it to our custom HTTPS port (8843).

How to do it

The files you need are on my GitHub. Replace mail.example.com with the FQDN of your mail server.


  Set up your lion server first. Configure SSL certificates, OD and web services the way you like it.
  Export your private key for the signed SSL certificate from the keychain.
  Install Kerio Connect. Import the private key and your signed certificate.
  Set Kerio to use only port 8800 for HTTP and 8843 for HTTP and HTTPS, respectively.
  Set Kerio to bind it’s services to All Interfaces rather than a specific IP address. (I’ve found that services won’t start when it’s listening on all IPs, but will when it can listen to all - don’t ask me why!)
  In Server.app, configure mail.example.com in Web. Set it to use port 443, set the root folder to whatever you want (it won’t be used).
  In Hardware, set the virtual host you just created to use the right ssl cert.
  In terminal: cd /path/to/the/files/you/downloaded
  In terminal again: sudo cp httpd_kerio.conf /etc/apache2/httpd_kerio.conf
  And again: sudo cp webapps/com.grahamglbert.kerio.plist /etc/apache2/webapps/com.grahamglbert.kerio.plist
  One last time: sudo webappctl start com.grahamgilbert.kerio mail.example.com


What’s happening

By default, when you specify a vhost to use ssl in lion server, any requests to port 80 are redirected to 443. Once it’s wrapped in ssl, it’s redirected transparently to 8843, so the user is sent to the webmail login.

The plist file is the core of the webapp mechanism that was introduced with lion server. Within that all we’re doing is importing the httpd_kerio.conf file (which just has a standard apache reverse proxy directive) and telling the app to always use ssl. The webappctl command is simply telling the webapp mechanism to load our plist and start it on the mail.example.com vhost.

Known Issues

Entourage

Entourage accounts will need to be reconfigured with the Kerio setup tool. They don’t seem to like communicating with the server over port 443 when the reverse proxy is running - they will have issues sending email.

Kerio Services

The services in Kerio Admin will need to be set to run on All Interfaces rather than a set IP address, as they won’t start on a specific address (it is unknown whether this is because of the reverse proxy / webapp process or if this is a general Lion issue). If the service has stopped, the webapp will need to be restarted:

sudo webappctl stop com.grahamgilbert.kerio mail.example.com
sudo webappctl start com.grahamgilbert.kerio mail.example.com


">
<meta name="twitter:site" content="@grahamgilbert">
<meta name="twitter:creator" content="@grahamgilbert">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://grahamgilbert.com/images/about.jpg">

<!-- Open Graph -->
<meta property="og:locale" content="en_GB">
<meta property="og:type" content="article">
<meta property="og:title" content="Kerio Connect vs Web Services in Lion Server">
<meta property="og:description" content="The problem

Lion Server takes over every ethernet interface when you enable any web services (Web, Wiki, Profile Manager, basically anything!). This leaves us with two options: putting Kerio on a non-standard port and getting the users to type that in every time, or completely disabling apache and not using any of the good stuff that came with Lion Server. Or, we could work out a way to redirect users to the right port number when they hit mail.example.com

Enter Reverse Proxy. This takes the request for the mail.example.com virtual host, and redirects it to our custom HTTPS port (8843).

How to do it

The files you need are on my GitHub. Replace mail.example.com with the FQDN of your mail server.


  Set up your lion server first. Configure SSL certificates, OD and web services the way you like it.
  Export your private key for the signed SSL certificate from the keychain.
  Install Kerio Connect. Import the private key and your signed certificate.
  Set Kerio to use only port 8800 for HTTP and 8843 for HTTP and HTTPS, respectively.
  Set Kerio to bind it’s services to All Interfaces rather than a specific IP address. (I’ve found that services won’t start when it’s listening on all IPs, but will when it can listen to all - don’t ask me why!)
  In Server.app, configure mail.example.com in Web. Set it to use port 443, set the root folder to whatever you want (it won’t be used).
  In Hardware, set the virtual host you just created to use the right ssl cert.
  In terminal: cd /path/to/the/files/you/downloaded
  In terminal again: sudo cp httpd_kerio.conf /etc/apache2/httpd_kerio.conf
  And again: sudo cp webapps/com.grahamglbert.kerio.plist /etc/apache2/webapps/com.grahamglbert.kerio.plist
  One last time: sudo webappctl start com.grahamgilbert.kerio mail.example.com


What’s happening

By default, when you specify a vhost to use ssl in lion server, any requests to port 80 are redirected to 443. Once it’s wrapped in ssl, it’s redirected transparently to 8843, so the user is sent to the webmail login.

The plist file is the core of the webapp mechanism that was introduced with lion server. Within that all we’re doing is importing the httpd_kerio.conf file (which just has a standard apache reverse proxy directive) and telling the app to always use ssl. The webappctl command is simply telling the webapp mechanism to load our plist and start it on the mail.example.com vhost.

Known Issues

Entourage

Entourage accounts will need to be reconfigured with the Kerio setup tool. They don’t seem to like communicating with the server over port 443 when the reverse proxy is running - they will have issues sending email.

Kerio Services

The services in Kerio Admin will need to be set to run on All Interfaces rather than a set IP address, as they won’t start on a specific address (it is unknown whether this is because of the reverse proxy / webapp process or if this is a general Lion issue). If the service has stopped, the webapp will need to be restarted:

sudo webappctl stop com.grahamgilbert.kerio mail.example.com
sudo webappctl start com.grahamgilbert.kerio mail.example.com


">
<meta property="og:url" content="http://grahamgilbert.com/blog/2011/11/22/kerio-connect-vs-web-services-in-lion-server/">
<meta property="og:site_name" content="graham gilbert dot com">

<meta property="og:image" content="http://grahamgilbert.com/images/about.jpg">





<link rel="canonical" href="http://grahamgilbert.com/blog/2011/11/22/kerio-connect-vs-web-services-in-lion-server/">
<link href="http://grahamgilbert.com/atom.xml" type="application/atom+xml" rel="alternate" title="graham gilbert dot com Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://grahamgilbert.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://grahamgilbert.com/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://grahamgilbert.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://grahamgilbert.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<link href='/stylesheets/all-e0260dc5ae0daef003df9eded89731d4.css' media='all' rel='stylesheet' type='text/css'>
<style>
article a {
    text-decoration: underline;
}
</style>
</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<input type="text" class="st-default-search-input" style="width: 150px;">
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/" >Home</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/about/" >About</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/talks/" >Talks</a></li>
				
				    
				        
				        
				    <li><a href="http://twitter.com/grahamgilbert" target="_blank">Twitter</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/posts/" >Archives</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    <div itemscope itemtype="http://schema.org/Person">

	<img src="http://grahamgilbert.com/images/about.jpg" class="bio-photo" alt="Graham Gilbert bio photo">


  <h3 itemprop="name">Graham Gilbert</h3>
  <p>A Mac admin, automating the hell out of things in London.<br /><br />The opinions on this site are my own, and are not necessarily shared by my employer.</p>
  <a href="http://twitter.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  <a href="http://linkedin.com/in/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
  
  
  
  <a href="http://github.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>
  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://grahamgilbert.com/blog/2011/11/22/kerio-connect-vs-web-services-in-lion-server/" rel="bookmark" title="Kerio Connect vs Web Services in Lion Server">Kerio Connect vs Web Services in Lion Server</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <h3 id="the-problem">The problem</h3>

<p>Lion Server takes over every ethernet interface when you enable any web services (Web, Wiki, Profile Manager, basically anything!). This leaves us with two options: putting Kerio on a non-standard port and getting the users to type that in every time, or completely disabling apache and not using any of the good stuff that came with Lion Server. Or, we could work out a way to redirect users to the right port number when they hit mail.example.com</p>

<p>Enter Reverse Proxy. This takes the request for the mail.example.com virtual host, and redirects it to our custom HTTPS port (8843).</p>

<h3 id="how-to-do-it">How to do it</h3>

<p>The files you need are on my <a href="https://github.com/grahamgilbert/Lion_Kerio">GitHub</a>. Replace mail.example.com with the FQDN of your mail server.</p>

<ol>
  <li>Set up your lion server first. Configure SSL certificates, OD and web services the way you like it.</li>
  <li>Export your private key for the signed SSL certificate from the keychain.</li>
  <li>Install Kerio Connect. Import the private key and your signed certificate.</li>
  <li>Set Kerio to use only port 8800 for HTTP and 8843 for HTTP and HTTPS, respectively.</li>
  <li>Set Kerio to bind it’s services to All Interfaces rather than a specific IP address. (I’ve found that services won’t start when it’s listening on all IPs, but will when it can listen to all - don’t ask me why!)</li>
  <li>In Server.app, configure mail.example.com in Web. Set it to use port 443, set the root folder to whatever you want (it won’t be used).</li>
  <li>In Hardware, set the virtual host you just created to use the right ssl cert.</li>
  <li>In terminal: <code>cd /path/to/the/files/you/downloaded</code></li>
  <li>In terminal again: <code>sudo cp httpd_kerio.conf /etc/apache2/httpd_kerio.conf</code></li>
  <li>And again: <code>sudo cp webapps/com.grahamglbert.kerio.plist /etc/apache2/webapps/com.grahamglbert.kerio.plist</code></li>
  <li>One last time: <code>sudo webappctl start com.grahamgilbert.kerio mail.example.com</code></li>
</ol>

<h3 id="whats-happening">What’s happening</h3>

<p>By default, when you specify a vhost to use ssl in lion server, any requests to port 80 are redirected to 443. Once it’s wrapped in ssl, it’s redirected transparently to 8843, so the user is sent to the webmail login.</p>

<p>The plist file is the core of the webapp mechanism that was introduced with lion server. Within that all we’re doing is importing the httpd_kerio.conf file (which just has a standard apache reverse proxy directive) and telling the app to always use ssl. The webappctl command is simply telling the webapp mechanism to load our plist and start it on the mail.example.com vhost.</p>

<h3 id="known-issues">Known Issues</h3>

<h4 id="entourage">Entourage</h4>

<p>Entourage accounts will need to be reconfigured with the Kerio setup tool. They don’t seem to like communicating with the server over port 443 when the reverse proxy is running - they will have issues sending email.</p>

<h4 id="kerio-services">Kerio Services</h4>

<p>The services in Kerio Admin will need to be set to run on All Interfaces rather than a set IP address, as they won’t start on a specific address (it is unknown whether this is because of the reverse proxy / webapp process or if this is a general Lion issue). If the service has stopped, the webapp will need to be restarted:</p>

<pre><code>sudo webappctl stop com.grahamgilbert.kerio mail.example.com
sudo webappctl start com.grahamgilbert.kerio mail.example.com
</code></pre>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://grahamgilbert.com/blog/2011/11/22/kerio-connect-vs-web-services-in-lion-server/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://grahamgilbert.com/blog/2011/11/22/kerio-connect-vs-web-services-in-lion-server/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://grahamgilbert.com/blog/2011/11/22/kerio-connect-vs-web-services-in-lion-server/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>Kerio Connect vs Web Services in Lion Server</strong> was published on <time datetime="2011-11-22T21:17:27+00:00">November 22, 2011</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://grahamgilbert.com/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://grahamgilbert.com/blog/2016/02/10/macad-uk-2016-puppet-on-os-x/" title="MacAD.UK 2016&#58; Puppet on OS X">MacAD.UK 2016&#58; Puppet on OS X</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/" title="Dynamic first boot scripts with Imagr and Flask&#58; Part 4">Dynamic first boot scripts with Imagr and Flask&#58; Part 4</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2016/01/14/imagr-1-0-0-released/" title="Imagr 1.0.0 Released">Imagr 1.0.0 Released</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    <span>&copy; 2016 Graham Gilbert.</span>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://grahamgilbert.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://grahamgilbert.com/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-27233739-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','sFQe2UApMaKvCdHMFL6r','2.0.0');
</script>
          


  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'grahamgilbert'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</body>
</html>
