<div class="post">
  <h1 class="post-title">Personal Automation: Munki (Part 2)</h1>
  <span class="post-date">27 Jul 2014</span>
  <p>The first step to getting any Mac set up is to get some software onto it. I’m not going to cover how to set up <a href="https://code.google.com/p/munki/wiki/GettingStartedWithMunki">Munki</a> or <a href="https://github.com/autopkg/autopkg/wiki/Getting-Started">AutoPkg</a> - there are lots of other places for that information.</p>

<p>As a sysadmin, I’m forever testing things. Rather than destroy my own machine, I like to do this in Virtual Machines. My preferred virtualisation solution is VMware Fusion, but unfortunately it’s not very easy to deploy out of the box. You need to do a little bit of work to get it into a package that you can import into Munki, but fortunately the process is <a href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=2058680">well documented on VMware’s site</a>.</p>

<p>The next piece of ‘non standard’ software I need is <a href="http://brew.sh">Homebrew</a>. The installation method listed on their site is to run a terminal command as the current user. The first part of this is obviously fine - Munki has several methods to run scripts (payload free packages, nopkg), but it runs everything as root. Fortunately, as I’m deploying my own machine, I can make some assumptions about where Homebrew will be installed. The first assumption I can make is that there will only be one user on the machine, and the second is that I’m going to be logged in most of the time (as my laptop is encrypted, it’s either off or logged in).</p>

<p>I’m going to utilise a <code>nopkg</code> pkginfo file to perform the installation. The first part of our script to install Homebrew is to make sure that a user (me!) is logged in. Homebrew doesn’t like being owned by root, so first we need to make sure that there is a user logged in.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#!/bin/bash</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">CURRENT_USER</span><span class="o">=</span><span class="sb">`</span>/bin/ls -l /dev/console <span class="p">|</span> /usr/bin/awk <span class="s1">&#39;&#x7b; print $3 &#x7d;&#39;</span><span class="sb">`</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$CURRENT_USER&quot;</span> <span class="o">==</span> <span class="s1">&#39;root&#39;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># this can&#39;t run at the login window, we need the current user</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nb">exit </span>1
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">fi</span></div></div></pre></div></figure>

<p>So now we know that there’s a user logged in, and who that user is. Time to install Homebrew as the current user.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p /usr/local
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p /usr/local/homebrew
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">mkdir -p /usr/local/bin
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">chown <span class="nv">$CURRENT_USER</span>:_developer /usr/local/homebrew
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">chown <span class="nv">$CURRENT_USER</span>:_developer /usr/local/bin
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#download and install homebrew</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">su <span class="nv">$CURRENT_USER</span> -c <span class="s2">&quot;/bin/bash -o pipefail -c &#39;/usr/bin/curl -skSfL https://github.com/mxcl/homebrew/tarball/master | (cd /usr/local ; /usr/bin/tar xz -m --strip 1 -C homebrew; ln -s /usr/local/homebrew/bin/brew /usr/local/bin/brew)&#39;&quot;</span></div></div></pre></div></figure>

<p>As we’re using a <code>nopkg</code> with Munki rather than a payload free package, we’ve not left any receipts, so Munki doesn’t know if Homebrew is installed. We’re going to use an installs array to tell Munki what to look for when determining whether Homebrew is installed or not.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;key&gt;</span>installs<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;array&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">		<span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>path<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span>/usr/local/bin/brew<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>type<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span>file<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">		<span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;/array&gt;</span></div></div></pre></div></figure>

<p>You might be crying “but Homebrew needs the Xcode Command Line Tools installed!” - and you’d be 100% correct. You have the option of importing the downloaded package into Munki, but I have adapted <a href="https://github.com/timsutton/osx-vm-templates/blob/master/scripts/xcode-cli-tools.sh">Tim Sutton’s script</a> into a <code>nopkg</code>. To find out what’s installed, I ran <a href="http://www.fernlightning.com/doku.php?id=software%3afseventer%3astart">fseventer</a> and chose a random file to act as my installs array. I’ve posted the pkginfos for both the <a href="https://github.com/grahamgilbert/macscripts/blob/master/Munki/pkginfos/Xcode/XcodeCLITools-2014.07.15.plist">Xcode CLI tools</a> and all of the <a href="https://github.com/grahamgilbert/macscripts/tree/master/Munki/pkginfos/Homebrew">Homebrew installs</a> on Github.</p>

</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//grahamgilbert.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2017/01/19/pocket-mac-admins-guide-to-london/">
            Pocket Mac admin's guide to London
            <small>19 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2017/01/11/imagr-with-target-disk-mode/">
            Imagr with target disk mode
            <small>11 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/12/15/enable-sip-with-munki/">
            Enable SIP with Munki
            <small>15 Dec 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>
