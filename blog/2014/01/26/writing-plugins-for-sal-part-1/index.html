<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Writing plugins for Sal: Part 1 &#8211; graham gilbert dot com</title>
<meta name="description" content="Writing a plugin for Sal isn’t hard. In fact, I’d go so far as to say it’s easy. We’re going to make a plugin that will flag up any machines that aren’t compatible with Mavericks, by using Tim Sutton’s script. To start off with, you’re going to need to get that script onto your Macs at /usr/local/munki/conditions. I’d personally use Puppet for that, but if you’re a purely Munki shop, you’ll be using a package. And handily, I’ve made one.



The convention I’d like everyone to follow is to drop your plugins into the plugins directory, in a subdirectory named after yourself - mine are going in plugins/grahamgilbert. The plugin we’re making today is going in plugins/grahamgilbert/mavcompatibility.

Metadata

The first piece you’ll need is a .yapsy-plugin file. This contains the metadata for your plugin. It’s all pretty self explanatory. This is plugins/grahamgilbert/mavcompatibility/mavcompatibility.yapsy-plugin.

[Core]
Name = MavCompatibility
Module = mavcompatibility
 [Documentation]
Author = Graham Gilbert
Version = 0.1
Website = http://grahamgilbert.com
Description = Displays macs that aren't compatible with 10.9.

Now for the meat

Onto the actual plugin. Your plugin is going to be sent at least two pieces of information, possibly three.


  page: This will be the page the plugin is going to be shown on. This will either be front, bu_dashboard or group_dashboard. You will need this information later on.
  machines: This a collection of machines you are going to need to work on. Depending on the page, this might be all of them, or just a subset from a Business Unit or Machine Group.
  theid: If you are displaying your plugin on either a Business Unit page or a Machine Group page, this is the unique ID of that Business Unit or Machine Group.


And in return, your plugin is expected to return two things:


  Some HTML: You plugin needs to return it’s output.
  The width of the output: Sal uses Bootstrap, and it uses a grid system. So Sal can wrap lines properly, you need to tell Sal how many columns your plugin needs. This should be an integer.


That’s the 50,000 ft view of a Sal plugin, let’s make one. The main thing to remember is that Sal is written in Django, so if you have any problems, looking at their documentation will help. You can also enable debug logging on your Sal install by uncommenting lines 24 and 25 in server/views.py (turn it off when you’re done though, it is VERY verbose).

First off, a little about how Sal stores the data you send it. Sal stores Munki’s conditions in the Condition table, and for each one, the name and it’s data is stored (this is the same for Facts). Munki’s conditions can consist of a variety of data types (strings, dates, arrays), so Sal will flatten any arrays it is given into a comma separated list. Each machine will have multiple Conditions and Facts associated with it.

When displaying the plugin, Sal will look for a function called show_widget, passing the information mentioned previously. Don’t worry too much about the templates, we’ll cover them later.

grahamgilbert/mavcompatibility/mavcompatibility.pyfrom yapsy.IPlugin import IPlugin
from yapsy.PluginManager import PluginManager
from django.template import loader, Context
from django.db.models import Count
from server.models import *
 class MavCompatibility(IPlugin):
    def show_widget(self, page, machines=None, theid=None):
         if page == &#39;front&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/front.html&#39;)
         if page == &#39;bu_dashboard&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/id.html&#39;)
         if page == &#39;group_dashboard&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/id.html&#39;)
          not_compatible = machines.filter(condition__condition_name=&#39;supported_major_os_upgrades&#39;).exclude(condition__condition_name=&#39;supported_major_os_upgrades&#39;, condition__condition_data__contains=&#39;10.9&#39;).count()
         c = Context(&#x7b;
            &#39;title&#39;: &#39;10.9 Compatibility&#39;,
            &#39;not_compatible&#39;: not_compatible,
            &#39;page&#39;: page,
            &#39;theid&#39;: theid
        &#x7d;)
        return t.render(c), 3

Skip to line 20 - this is where the real work starts. All we’re doing is taking the machines we were passed and first off finding the machines that have the condition we’re looking for. We then want to remove those that contain 10.9 in that data.

Templates

Then it’s just a case of passing those variables to our template. As we aren’t linking our buttons to anything for now, both of our templates will be the same, but we will still make two separate ones as we’re going to need them next time.

grahamgilbert/mavcompatibility/templates/front.html&lt;div class=&quot;span3&quot;&gt;
    &lt;legend&gt;&#x7b;&#x7b; title &#x7d;&#x7d;&lt;/legend&gt;
        &lt;a href=&quot;#&quot; class=&quot;btn btn-danger&quot;&gt;
            &lt;span class=&quot;bigger&quot;&gt; &#x7b;&#x7b; not_compatible &#x7d;&#x7d; &lt;/span&gt;&lt;br /&gt;
            Not Compatible
        &lt;/a&gt;
&lt;/div&gt;

Make a file in templates called id.html with the same content for now - we’ll make them different in part two.

We return our plugin on line 28 of mavcompatibility.py. First we render the appropriate template, passing it our data, and we return how wide our plugin is - in this case it will take up three columns.

That’s it for a basic plugin - we’ve taken a bunch of machines, filtered them based on a Munki condition, and we’ve returned the data. But this obviously is lacking - the button doesn’t do anything and we still see a big fat zero when all of our machines are 10.9 capable. Anyway, you can get the code so far in my sal-plugins repository.

Tune in to part two for the thrilling conclusion!

">
<meta name="keywords" content="">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Writing plugins for Sal: Part 1">
<meta name="twitter:description" content="Writing a plugin for Sal isn’t hard. In fact, I’d go so far as to say it’s easy. We’re going to make a plugin that will flag up any machines that aren’t compatible with Mavericks, by using Tim Sutton’s script. To start off with, you’re going to need to get that script onto your Macs at /usr/local/munki/conditions. I’d personally use Puppet for that, but if you’re a purely Munki shop, you’ll be using a package. And handily, I’ve made one.



The convention I’d like everyone to follow is to drop your plugins into the plugins directory, in a subdirectory named after yourself - mine are going in plugins/grahamgilbert. The plugin we’re making today is going in plugins/grahamgilbert/mavcompatibility.

Metadata

The first piece you’ll need is a .yapsy-plugin file. This contains the metadata for your plugin. It’s all pretty self explanatory. This is plugins/grahamgilbert/mavcompatibility/mavcompatibility.yapsy-plugin.

[Core]
Name = MavCompatibility
Module = mavcompatibility
 [Documentation]
Author = Graham Gilbert
Version = 0.1
Website = http://grahamgilbert.com
Description = Displays macs that aren't compatible with 10.9.

Now for the meat

Onto the actual plugin. Your plugin is going to be sent at least two pieces of information, possibly three.


  page: This will be the page the plugin is going to be shown on. This will either be front, bu_dashboard or group_dashboard. You will need this information later on.
  machines: This a collection of machines you are going to need to work on. Depending on the page, this might be all of them, or just a subset from a Business Unit or Machine Group.
  theid: If you are displaying your plugin on either a Business Unit page or a Machine Group page, this is the unique ID of that Business Unit or Machine Group.


And in return, your plugin is expected to return two things:


  Some HTML: You plugin needs to return it’s output.
  The width of the output: Sal uses Bootstrap, and it uses a grid system. So Sal can wrap lines properly, you need to tell Sal how many columns your plugin needs. This should be an integer.


That’s the 50,000 ft view of a Sal plugin, let’s make one. The main thing to remember is that Sal is written in Django, so if you have any problems, looking at their documentation will help. You can also enable debug logging on your Sal install by uncommenting lines 24 and 25 in server/views.py (turn it off when you’re done though, it is VERY verbose).

First off, a little about how Sal stores the data you send it. Sal stores Munki’s conditions in the Condition table, and for each one, the name and it’s data is stored (this is the same for Facts). Munki’s conditions can consist of a variety of data types (strings, dates, arrays), so Sal will flatten any arrays it is given into a comma separated list. Each machine will have multiple Conditions and Facts associated with it.

When displaying the plugin, Sal will look for a function called show_widget, passing the information mentioned previously. Don’t worry too much about the templates, we’ll cover them later.

grahamgilbert/mavcompatibility/mavcompatibility.pyfrom yapsy.IPlugin import IPlugin
from yapsy.PluginManager import PluginManager
from django.template import loader, Context
from django.db.models import Count
from server.models import *
 class MavCompatibility(IPlugin):
    def show_widget(self, page, machines=None, theid=None):
         if page == &#39;front&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/front.html&#39;)
         if page == &#39;bu_dashboard&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/id.html&#39;)
         if page == &#39;group_dashboard&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/id.html&#39;)
          not_compatible = machines.filter(condition__condition_name=&#39;supported_major_os_upgrades&#39;).exclude(condition__condition_name=&#39;supported_major_os_upgrades&#39;, condition__condition_data__contains=&#39;10.9&#39;).count()
         c = Context(&#x7b;
            &#39;title&#39;: &#39;10.9 Compatibility&#39;,
            &#39;not_compatible&#39;: not_compatible,
            &#39;page&#39;: page,
            &#39;theid&#39;: theid
        &#x7d;)
        return t.render(c), 3

Skip to line 20 - this is where the real work starts. All we’re doing is taking the machines we were passed and first off finding the machines that have the condition we’re looking for. We then want to remove those that contain 10.9 in that data.

Templates

Then it’s just a case of passing those variables to our template. As we aren’t linking our buttons to anything for now, both of our templates will be the same, but we will still make two separate ones as we’re going to need them next time.

grahamgilbert/mavcompatibility/templates/front.html&lt;div class=&quot;span3&quot;&gt;
    &lt;legend&gt;&#x7b;&#x7b; title &#x7d;&#x7d;&lt;/legend&gt;
        &lt;a href=&quot;#&quot; class=&quot;btn btn-danger&quot;&gt;
            &lt;span class=&quot;bigger&quot;&gt; &#x7b;&#x7b; not_compatible &#x7d;&#x7d; &lt;/span&gt;&lt;br /&gt;
            Not Compatible
        &lt;/a&gt;
&lt;/div&gt;

Make a file in templates called id.html with the same content for now - we’ll make them different in part two.

We return our plugin on line 28 of mavcompatibility.py. First we render the appropriate template, passing it our data, and we return how wide our plugin is - in this case it will take up three columns.

That’s it for a basic plugin - we’ve taken a bunch of machines, filtered them based on a Munki condition, and we’ve returned the data. But this obviously is lacking - the button doesn’t do anything and we still see a big fat zero when all of our machines are 10.9 capable. Anyway, you can get the code so far in my sal-plugins repository.

Tune in to part two for the thrilling conclusion!

">
<meta name="twitter:site" content="@grahamgilbert">
<meta name="twitter:creator" content="@grahamgilbert">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://grahamgilbert.com/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_GB">
<meta property="og:type" content="article">
<meta property="og:title" content="Writing plugins for Sal: Part 1">
<meta property="og:description" content="Writing a plugin for Sal isn’t hard. In fact, I’d go so far as to say it’s easy. We’re going to make a plugin that will flag up any machines that aren’t compatible with Mavericks, by using Tim Sutton’s script. To start off with, you’re going to need to get that script onto your Macs at /usr/local/munki/conditions. I’d personally use Puppet for that, but if you’re a purely Munki shop, you’ll be using a package. And handily, I’ve made one.



The convention I’d like everyone to follow is to drop your plugins into the plugins directory, in a subdirectory named after yourself - mine are going in plugins/grahamgilbert. The plugin we’re making today is going in plugins/grahamgilbert/mavcompatibility.

Metadata

The first piece you’ll need is a .yapsy-plugin file. This contains the metadata for your plugin. It’s all pretty self explanatory. This is plugins/grahamgilbert/mavcompatibility/mavcompatibility.yapsy-plugin.

[Core]
Name = MavCompatibility
Module = mavcompatibility
 [Documentation]
Author = Graham Gilbert
Version = 0.1
Website = http://grahamgilbert.com
Description = Displays macs that aren't compatible with 10.9.

Now for the meat

Onto the actual plugin. Your plugin is going to be sent at least two pieces of information, possibly three.


  page: This will be the page the plugin is going to be shown on. This will either be front, bu_dashboard or group_dashboard. You will need this information later on.
  machines: This a collection of machines you are going to need to work on. Depending on the page, this might be all of them, or just a subset from a Business Unit or Machine Group.
  theid: If you are displaying your plugin on either a Business Unit page or a Machine Group page, this is the unique ID of that Business Unit or Machine Group.


And in return, your plugin is expected to return two things:


  Some HTML: You plugin needs to return it’s output.
  The width of the output: Sal uses Bootstrap, and it uses a grid system. So Sal can wrap lines properly, you need to tell Sal how many columns your plugin needs. This should be an integer.


That’s the 50,000 ft view of a Sal plugin, let’s make one. The main thing to remember is that Sal is written in Django, so if you have any problems, looking at their documentation will help. You can also enable debug logging on your Sal install by uncommenting lines 24 and 25 in server/views.py (turn it off when you’re done though, it is VERY verbose).

First off, a little about how Sal stores the data you send it. Sal stores Munki’s conditions in the Condition table, and for each one, the name and it’s data is stored (this is the same for Facts). Munki’s conditions can consist of a variety of data types (strings, dates, arrays), so Sal will flatten any arrays it is given into a comma separated list. Each machine will have multiple Conditions and Facts associated with it.

When displaying the plugin, Sal will look for a function called show_widget, passing the information mentioned previously. Don’t worry too much about the templates, we’ll cover them later.

grahamgilbert/mavcompatibility/mavcompatibility.pyfrom yapsy.IPlugin import IPlugin
from yapsy.PluginManager import PluginManager
from django.template import loader, Context
from django.db.models import Count
from server.models import *
 class MavCompatibility(IPlugin):
    def show_widget(self, page, machines=None, theid=None):
         if page == &#39;front&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/front.html&#39;)
         if page == &#39;bu_dashboard&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/id.html&#39;)
         if page == &#39;group_dashboard&#39;:
            t = loader.get_template(&#39;grahamgilbert/mavcompatibility/templates/id.html&#39;)
          not_compatible = machines.filter(condition__condition_name=&#39;supported_major_os_upgrades&#39;).exclude(condition__condition_name=&#39;supported_major_os_upgrades&#39;, condition__condition_data__contains=&#39;10.9&#39;).count()
         c = Context(&#x7b;
            &#39;title&#39;: &#39;10.9 Compatibility&#39;,
            &#39;not_compatible&#39;: not_compatible,
            &#39;page&#39;: page,
            &#39;theid&#39;: theid
        &#x7d;)
        return t.render(c), 3

Skip to line 20 - this is where the real work starts. All we’re doing is taking the machines we were passed and first off finding the machines that have the condition we’re looking for. We then want to remove those that contain 10.9 in that data.

Templates

Then it’s just a case of passing those variables to our template. As we aren’t linking our buttons to anything for now, both of our templates will be the same, but we will still make two separate ones as we’re going to need them next time.

grahamgilbert/mavcompatibility/templates/front.html&lt;div class=&quot;span3&quot;&gt;
    &lt;legend&gt;&#x7b;&#x7b; title &#x7d;&#x7d;&lt;/legend&gt;
        &lt;a href=&quot;#&quot; class=&quot;btn btn-danger&quot;&gt;
            &lt;span class=&quot;bigger&quot;&gt; &#x7b;&#x7b; not_compatible &#x7d;&#x7d; &lt;/span&gt;&lt;br /&gt;
            Not Compatible
        &lt;/a&gt;
&lt;/div&gt;

Make a file in templates called id.html with the same content for now - we’ll make them different in part two.

We return our plugin on line 28 of mavcompatibility.py. First we render the appropriate template, passing it our data, and we return how wide our plugin is - in this case it will take up three columns.

That’s it for a basic plugin - we’ve taken a bunch of machines, filtered them based on a Munki condition, and we’ve returned the data. But this obviously is lacking - the button doesn’t do anything and we still see a big fat zero when all of our machines are 10.9 capable. Anyway, you can get the code so far in my sal-plugins repository.

Tune in to part two for the thrilling conclusion!

">
<meta property="og:url" content="http://grahamgilbert.com/blog/2014/01/26/writing-plugins-for-sal-part-1/">
<meta property="og:site_name" content="graham gilbert dot com">

<meta property="og:image" content="http://grahamgilbert.com/images/default-thumb.png">





<link rel="canonical" href="http://grahamgilbert.com/blog/2014/01/26/writing-plugins-for-sal-part-1/">
<link href="http://grahamgilbert.com/atom.xml" type="application/atom+xml" rel="alternate" title="graham gilbert dot com Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://grahamgilbert.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://grahamgilbert.com/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://grahamgilbert.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://grahamgilbert.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://grahamgilbert.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://grahamgilbert.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://grahamgilbert.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://grahamgilbert.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://grahamgilbert.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://grahamgilbert.com/images/apple-touch-icon-144x144-precomposed.png">
<link href='/stylesheets/all-476e6a9e20e90d95691860a993d65b96.css' media='all' rel='stylesheet' type='text/css'>
</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://grahamgilbert.com/">graham gilbert dot com</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/about/" >About</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/talks/" >Talks</a></li>
				
				    
				        
				        
				    <li><a href="http://twitter.com/grahamgilbert" target="_blank">Twitter</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/posts/" >Archives</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    <div itemscope itemtype="http://schema.org/Person">


	<img src="http://grahamgilbert.com/images/about.jpg" class="bio-photo" alt="Graham Gilbert bio photo">


  <h3 itemprop="name">Graham Gilbert</h3>
  <p>A Mac admin, automating the hell out of things in London.<br /><br />The opinions on this site are my own, and are not necessarily shared by my employer.</p>
  <a href="http://twitter.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  <a href="http://linkedin.com/in/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
  
  
  
  <a href="http://github.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>
  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://grahamgilbert.com/blog/2014/01/26/writing-plugins-for-sal-part-1/" rel="bookmark" title="Writing plugins for Sal: Part 1">Writing plugins for Sal: Part 1</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>Writing a plugin for Sal isn’t hard. In fact, I’d go so far as to say it’s easy. We’re going to make a plugin that will flag up any machines that aren’t compatible with Mavericks, by using <a href="https://github.com/timsutton/munki-conditions/blob/master/supported_major_os_upgrades">Tim Sutton’s script</a>. To start off with, you’re going to need to get that script onto your Macs at <code>/usr/local/munki/conditions</code>. I’d personally use Puppet for that, but if you’re a purely Munki shop, you’ll be using a package. <a href="https://github.com/grahamgilbert/macscripts/raw/master/Munki/Condtion%20Packages/supported_major_os_upgrades/supported_major_os_upgrades.pkg">And handily, I’ve made one</a>.</p>

<p><img class="center" src="/images/posts/2014-01-26/mavcompatibility.png" width="297" height="131" /></p>

<p>The convention I’d like everyone to follow is to drop your plugins into the <code>plugins</code> directory, in a subdirectory named after yourself - mine are going in <code>plugins/grahamgilbert</code>. The plugin we’re making today is going in <code>plugins/grahamgilbert/mavcompatibility</code>.</p>

<h2 id="metadata">Metadata</h2>

<p>The first piece you’ll need is a <code>.yapsy-plugin</code> file. This contains the metadata for your plugin. It’s all pretty self explanatory. This is <code>plugins/grahamgilbert/mavcompatibility/mavcompatibility.yapsy-plugin</code>.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">[Core]
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">Name = MavCompatibility
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">Module = mavcompatibility
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">[Documentation]
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">Author = Graham Gilbert
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">Version = 0.1
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">Website = http://grahamgilbert.com
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">Description = Displays macs that aren't compatible with 10.9.</div></div></pre></div></figure>

<h2 id="now-for-the-meat">Now for the meat</h2>

<p>Onto the actual plugin. Your plugin is going to be sent at least two pieces of information, possibly three.</p>

<ul>
  <li><code>page</code>: This will be the page the plugin is going to be shown on. This will either be <code>front</code>, <code>bu_dashboard</code> or <code>group_dashboard</code>. You will need this information later on.</li>
  <li><code>machines</code>: This a collection of machines you are going to need to work on. Depending on the page, this might be all of them, or just a subset from a Business Unit or Machine Group.</li>
  <li><code>theid</code>: If you are displaying your plugin on either a Business Unit page or a Machine Group page, this is the unique ID of that Business Unit or Machine Group.</li>
</ul>

<p>And in return, your plugin is expected to return two things:</p>

<ul>
  <li>Some HTML: You plugin needs to return it’s output.</li>
  <li>The width of the output: Sal uses <a href="http://getbootstrap.com/2.3.2/">Bootstrap</a>, and it uses a grid system. So Sal can wrap lines properly, you need to tell Sal how many columns your plugin needs. This should be an integer.</li>
</ul>

<p>That’s the 50,000 ft view of a Sal plugin, let’s make one. The main thing to remember is that Sal is written in Django, so if you have any problems, looking at <a href="https://docs.djangoproject.com/en/1.5/">their documentation</a> will help. You can also enable debug logging on your Sal install by uncommenting lines 24 and 25 in <code>server/views.py</code> (turn it off when you’re done though, it is VERY verbose).</p>

<p>First off, a little about how Sal stores the data you send it. Sal stores Munki’s conditions in the Condition table, and for each one, the name and it’s data is stored (this is the same for Facts). Munki’s conditions can consist of a variety of data types (strings, dates, arrays), so Sal will flatten any arrays it is given into a comma separated list. Each machine will have multiple Conditions and Facts associated with it.</p>

<p>When displaying the plugin, Sal will look for a function called show_widget, passing the information mentioned previously. Don’t worry too much about the templates, we’ll cover them later.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">grahamgilbert/mavcompatibility/mavcompatibility.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">yapsy.IPlugin</span> <span class="kn">import</span> <span class="n">IPlugin</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">yapsy.PluginManager</span> <span class="kn">import</span> <span class="n">PluginManager</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">django.template</span> <span class="kn">import</span> <span class="n">loader</span><span class="p">,</span> <span class="n">Context</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">django.db.models</span> <span class="kn">import</span> <span class="n">Count</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">server.models</span> <span class="kn">import</span> <span class="o">*</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">class</span> <span class="nc">MavCompatibility</span><span class="p">(</span><span class="n">IPlugin</span><span class="p">):</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">show_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="n">machines</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">theid</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="n">page</span> <span class="o">==</span> <span class="s">&#39;front&#39;</span><span class="p">:</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;grahamgilbert/mavcompatibility/templates/front.html&#39;</span><span class="p">)</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="n">page</span> <span class="o">==</span> <span class="s">&#39;bu_dashboard&#39;</span><span class="p">:</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;grahamgilbert/mavcompatibility/templates/id.html&#39;</span><span class="p">)</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="n">page</span> <span class="o">==</span> <span class="s">&#39;group_dashboard&#39;</span><span class="p">:</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">t</span> <span class="o">=</span> <span class="n">loader</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="s">&#39;grahamgilbert/mavcompatibility/templates/id.html&#39;</span><span class="p">)</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">not_compatible</span> <span class="o">=</span> <span class="n">machines</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">condition__condition_name</span><span class="o">=</span><span class="s">&#39;supported_major_os_upgrades&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">condition__condition_name</span><span class="o">=</span><span class="s">&#39;supported_major_os_upgrades&#39;</span><span class="p">,</span> <span class="n">condition__condition_data__contains</span><span class="o">=</span><span class="s">&#39;10.9&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">c</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(&#x7b;</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="s">&#39;title&#39;</span><span class="p">:</span> <span class="s">&#39;10.9 Compatibility&#39;</span><span class="p">,</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="s">&#39;not_compatible&#39;</span><span class="p">:</span> <span class="n">not_compatible</span><span class="p">,</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="s">&#39;page&#39;</span><span class="p">:</span> <span class="n">page</span><span class="p">,</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="s">&#39;theid&#39;</span><span class="p">:</span> <span class="n">theid</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="p">&#x7d;)</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="mi">3</span></div></div></pre></div></figure>

<p>Skip to line 20 - this is where the real work starts. All we’re doing is taking the machines we were passed and first off finding the machines that have the condition we’re looking for. We then want to remove those that contain 10.9 in that data.</p>

<h2 id="templates">Templates</h2>

<p>Then it’s just a case of passing those variables to our template. As we aren’t linking our buttons to anything for now, both of our templates will be the same, but we will still make two separate ones as we’re going to need them next time.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">grahamgilbert/mavcompatibility/templates/front.html</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">&quot;span3&quot;</span><span class="nt">&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;legend&gt;</span><span class="cp">&#x7b;&#x7b;</span> <span class="nv">title</span> <span class="cp">&#x7d;&#x7d;</span><span class="nt">&lt;/legend&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;#&quot;</span> <span class="na">class=</span><span class="s">&quot;btn btn-danger&quot;</span><span class="nt">&gt;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nt">&lt;span</span> <span class="na">class=</span><span class="s">&quot;bigger&quot;</span><span class="nt">&gt;</span> <span class="cp">&#x7b;&#x7b;</span> <span class="nv">not_compatible</span> <span class="cp">&#x7d;&#x7d;</span> <span class="nt">&lt;/span&gt;&lt;br</span> <span class="nt">/&gt;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">            Not Compatible
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;/a&gt;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/div&gt;</span></div></div></pre></div></figure>

<p>Make a file in <code>templates</code> called <code>id.html</code> with the same content for now - we’ll make them different in part two.</p>

<p>We return our plugin on line 28 of <code>mavcompatibility.py</code>. First we render the appropriate template, passing it our data, and we return how wide our plugin is - in this case it will take up three columns.</p>

<p>That’s it for a basic plugin - we’ve taken a bunch of machines, filtered them based on a Munki condition, and we’ve returned the data. But this obviously is lacking - the button doesn’t do anything and we still see a big fat zero when all of our machines are 10.9 capable. Anyway, you can get the code so far in my <a href="https://github.com/grahamgilbert/sal-plugins/tree/master/mavcompatibility">sal-plugins repository</a>.</p>

<p>Tune in to part two for the thrilling conclusion!</p>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://grahamgilbert.com/blog/2014/01/26/writing-plugins-for-sal-part-1/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://grahamgilbert.com/blog/2014/01/26/writing-plugins-for-sal-part-1/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://grahamgilbert.com/blog/2014/01/26/writing-plugins-for-sal-part-1/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>Writing plugins for Sal: Part 1</strong> was published on <time datetime="2014-01-26T10:01:26+00:00">January 26, 2014</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://grahamgilbert.com/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://grahamgilbert.com/blog/2015/11/23/releasing-changes-with-sharding/" title="Releasing Changes With Sharding">Releasing Changes With Sharding</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2015/11/12/mactech-2015-hands-on-with-imagr/" title="MacTech 2015: Hands on with Imagr">MacTech 2015: Hands on with Imagr</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2015/10/15/detecting-when-a-munki-client-is-on-the-corporate-network/" title="Detecting when a Munki client is on the corporate network">Detecting when a Munki client is on the corporate network</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    <span>&copy; 2015 Graham Gilbert. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a> theme.</span>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://grahamgilbert.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://grahamgilbert.com/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-27233739-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'grahamgilbert'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</body>
</html>
