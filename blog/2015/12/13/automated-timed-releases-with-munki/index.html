<div class="post">
  <h1 class="post-title">Automated timed releases with Munki</h1>
  <span class="post-date">13 Dec 2015</span>
  <p>In my environment, we have software that needs to be deployed at the same time across all of our sites. Previously, this meant someone had to pull their computer out on a Sunday and promote the item from the testing catalog to the production catalog. Which is fine, but to be honest I’d rather be doing something else on a Sunday!</p>

<p>So I started looking at how to automate this process. First I looked at <a href="https://github.com/munki/munki/wiki/Pkginfo-Files#force-install-after-date"><code>force_install_after_date</code></a>, but this install the item at a specified time in the client’s local time - I needed this to be installed at the same time globally. Next was <a href="https://github.com/munki/munki/wiki/Conditional-Items#built-in-conditions">Munki’s <code>date</code> condition</a> and using <code>installable_conditon</code> in the item’s pkgsinfo file similarly to how we <a href="http://grahamgilbert.com/blog/2015/11/23/releasing-changes-with-sharding/">shard our updates</a> - but despite the time object looking like it’s UTC, it’s still just the client’s local time. <!-- more --></p>

<h2 id="what-can-we-do">What can we do?</h2>

<p>I wrote a <a href="https://github.com/grahamgilbert/macscripts/tree/master/Munki/Condtion%20Packages/utctime">simple condition script</a> that will give us both the date and time in UTC and the current unix timestamp - the number of seconds since January 1st 1970. Using the unix timestamp makes it nice and easy to do comparisons on. For example, let’s say we want to deploy an item at 8am on Sunday 13th December 2015:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;key&gt;</span>installable_condition<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;string&gt;</span>timestamp <span class="ni">&amp;lt;</span>= 1449993600<span class="nt">&lt;/string&gt;</span></div></div></pre></div></figure>

<p>And let’s have a look at the script:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/usr/local/munki/conditions/utctime</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#!/usr/bin/env python</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">subprocess</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">os</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">plistlib</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">time</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">Foundation</span> <span class="kn">import</span> <span class="n">CFPreferencesCopyAppValue</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># Read the location of the ManagedInstallDir from ManagedInstall.plist</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">BUNDLE_ID</span> <span class="o">=</span> <span class="s">&#39;ManagedInstalls&#39;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">pref_name</span> <span class="o">=</span> <span class="s">&#39;ManagedInstallDir&#39;</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">managedinstalldir</span> <span class="o">=</span> <span class="n">CFPreferencesCopyAppValue</span><span class="p">(</span><span class="n">pref_name</span><span class="p">,</span> <span class="n">BUNDLE_ID</span><span class="p">)</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># Make sure we&#39;re outputting our information to &quot;ConditionalItems.plist&quot;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">conditionalitemspath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">managedinstalldir</span><span class="p">,</span> <span class="s">&#39;ConditionalItems.plist&#39;</span><span class="p">)</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">newdict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">utctime</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span> <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()))</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># CRITICAL!</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">conditionalitemspath</span><span class="p">):</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="c"># &quot;ConditionalItems.plist&quot; exists, so read it FIRST (existing_dict)</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">existing_dict</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlist</span><span class="p">(</span><span class="n">conditionalitemspath</span><span class="p">)</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="c"># Create output_dict which joins new data generated in this script with existing data</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">output_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">existing_dict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="o">+</span> <span class="n">newdict</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="c"># &quot;ConditionalItems.plist&quot; does not exist,</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="c"># output only consists of data generated in this script</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">output_dict</span> <span class="o">=</span> <span class="n">newdict</span>
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># Write out data to &quot;ConditionalItems.plist&quot;</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">plistlib</span><span class="o">.</span><span class="n">writePlist</span><span class="p">(</span><span class="n">output_dict</span><span class="p">,</span> <span class="n">conditionalitemspath</span><span class="p">)</span>
</div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">main</span><span class="p">()</span></div></div></pre></div></figure>

<p>Just deploy that to <code>/usr/local/munki/conditions/utctime</code> and you’re good to go - if you’d like to use a pre-built package, you’ll find one up on <a href="https://github.com/grahamgilbert/macscripts/tree/master/Munki/Condtion%20Packages/utctime">GitHub</a>.</p>

</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//grahamgilbert.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2017/01/19/pocket-mac-admins-guide-to-london/">
            Pocket Mac admin's guide to London
            <small>19 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2017/01/11/imagr-with-target-disk-mode/">
            Imagr with target disk mode
            <small>11 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/12/15/enable-sip-with-munki/">
            Enable SIP with Munki
            <small>15 Dec 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>
