<!DOCTYPE html>
<html lang="en-us">

  <head>
  <script type="text/javascript">
    var host = "grahamgilbert.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Dynamic first boot scripts with Imagr and Flask&#58; Part 4 &middot; graham gilbert
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <!--link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico"-->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
  <link href='/stylesheets/all-b18cc7d6d5710987503b687ec013f838.css' media='all' rel='stylesheet' type='text/css'>
  <link type="application/atom+xml" rel="alternate" href="https://grahamgilbert.com//atom.xml" title="graham gilbert" />
  <style>
  .clear{
    clear:both
  }
  .float-left {
    float:left;
    padding-right:25px;
    padding-bottom:25px;
  }

  .float-right {
    float:right;
    padding-left:25px;
    padding-bottom:25px;
  }
  </style>
</head>

  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          graham gilbert
        </a>
      </h1>
      <p class="lead">A Mac admin, automating the hell out of things.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/talks/">Talks</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
      
      </nav>
      <p>

      <a href="https://twitter.com/grahamgilbert"><img style="display:inline;" src="/images/social/twitter.png" /></a> <a href="https://github.com/grahamgilbert"><img style="display:inline;" src="/images/social/github.png" /></a> <a href="https://www.linkedin.com/in/grahamgilbert"><img style="display:inline;" src="/images/social/linkedin.png" /></a>
      </p>

    <p>
      <small>The opinions on this site are my own, and are not necessarily shared by my employer.</small>
    </p>

  </div>
</div>

    <div class="content container">
      <div class="post">
  <h1 class="post-title">Dynamic first boot scripts with Imagr and Flask&#58; Part 4</h1>
  <span class="post-date">20 Jan 2016</span>
  <p>If you are just starting with this series, it is highly recommended you start with <a href="http://grahamgilbert.com/blog/2016/01/05/dynamic-first-boot-scripts-with-imagr-and-flask/">Part 1</a>.</p>

<p>The last part of this series is making it work in a Docker container. This is <strong>not</strong> a Docker tutorial - please head over to Docker’s <a href="https://docs.docker.com/mac/">getting started</a> pages to get yourself set up with the Docker Toolbox.</p>

<p>All done? Let’s crack on with first creating our Dockerfile. <!-- more --></p>

<p>In the same <code>~/src/boostrapapp</code> directory as your main script, create a new file called <code>Dockerfile</code> with the following contents:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/Dockerfile</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">FROM</span> python:2.7-slim
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">ENV</span> <span class="nv">BOOTSTRAP_DEBUG</span><span class="o">=</span><span class="nb">false </span><span class="nv">BOOTSTRAP_USERNAME</span><span class="o">=</span>admin <span class="nv">BOOTSTRAP_PASSWORD</span><span class="o">=</span>secret <span class="nv">BOOTSTRAP_URL</span><span class="o">=</span><span class="s2">&quot;http://localhost:5000&quot;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">COPY requirements.txt /requirements.txt
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">COPY gunicorn_config.py /gunicorn_config.py
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">COPY bootstrap.py /bootstrap.py
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">RUN</span> pip install -r /requirements.txt <span class="o">&amp;&amp;</span> <span class="err">\</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    rm /requirements.txt <span class="o">&amp;&amp;</span> <span class="err">\</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    pip install gunicorn futures
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">CMD</span> gunicorn -c gunicorn_config.py bootstrap:app
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">EXPOSE</span> <span class="m">5000</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">VOLUME</span> <span class="o">[</span><span class="s2">&quot;/munki_repo&quot;</span><span class="o">]</span></div></div></pre></div></figure>

<p>In the Dockerfile we copied a couple of files. The first is the requirements file - this will install the bits into python we need to run our app. Fortunately, this is incredibly easy to generate:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span><span class="nb">source</span> ~/virtualenvs/bootstrapapp/bin/activate
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span><span class="nb">cd</span> ~/src/bootstrapapp
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span>pip freeze &gt; requirements.txt</div></div></pre></div></figure>

<p>And now for <code>gunicorn_config.py</code>. Up until now we have been using Flask’s built in web server. This is fine for development, but in production it is better to use a more robust server. You would normally put an app running with Gunicorn behind a proxy server (you could use my <a href="http://grahamgilbert.com/blog/2015/08/26/using-a-proxy-container-with-docker-for-virtualhosts/">Proxy image</a>), but this time we won’t for the sake of simplicity.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">multiprocessing</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">getenv</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">bind</span> <span class="o">=</span> <span class="s">&#39;0.0.0.0:5000&#39;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">workers</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">timeout</span> <span class="o">=</span> <span class="mi">600</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">threads</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">max_requests</span> <span class="o">=</span> <span class="mi">600</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">max_requests_jitter</span> <span class="o">=</span> <span class="mi">50</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">errorlog</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">accesslog</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">loglevel</span> <span class="o">=</span> <span class="s">&#39;warning&#39;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># Read the DEBUG setting from env var</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_DEBUG&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">loglevel</span> <span class="o">=</span> <span class="s">&#39;debug&#39;</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">pass</span></div></div></pre></div></figure>

<p>Our last step before building the image is to replace a few parts that we’ve hardcoded into <code>bootstrap.py</code> with environment variables so they can be customised when the Docker image is run.</p>

<p>First off we have our username and password for HTTP authentication. Change:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="s">&#39;admin&#39;</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="s">&#39;secret&#39;</span></div></div></pre></div></figure>

<p>To look like:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_USERNAME&#39;</span><span class="p">,</span> <span class="s">&#39;admin&#39;</span><span class="p">)</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="s">&#39;admin&#39;</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_PASSWORD&#39;</span><span class="p">,</span> <span class="s">&#39;secret&#39;</span><span class="p">)</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="s">&#39;secret&#39;</span></div></div></pre></div></figure>

<p>Running our app in debug mode is useful during development, but can pose a security risk in production - let’s be able to turn that on and off. Replace <code>DEBUG = True</code> at the top of <code>boostrap.py</code> with:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/bootstrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_DEBUG&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span></div></div></pre></div></figure>

<p>One last part is to be able to set our URL that the app is served on - we return this in the script that is sent to our clients, so we need to tell the container about it. Replace your <code>def index</code> section with:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/bootstrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nd">@requires_auth</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">build</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-bootstrap-build&#39;</span><span class="p">)</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">site</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-bootstrap-site&#39;</span><span class="p">)</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_URL&#39;</span><span class="p">,</span> <span class="s">&#39;http://localhost:5000&#39;</span><span class="p">)</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">script</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;#!/usr/bin/python</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">import subprocess</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">import re</span>
</div></div><div data-line="10" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">import urllib</span>
</div></div><div data-line="11" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">import os</span>
</div></div><div data-line="12" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="13" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">site=&#39;&#x7b;0&#x7d;&#39;</span>
</div></div><div data-line="14" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">build=&#39;&#x7b;1&#x7d;&#39;</span>
</div></div><div data-line="15" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">username=&#39;&#x7b;2&#x7d;&#39;</span>
</div></div><div data-line="16" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">password=&#39;&#x7b;3&#x7d;&#39;</span>
</div></div><div data-line="17" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">url=&#39;&#x7b;4&#x7d;&#39;</span>
</div></div><div data-line="18" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">def get_hardware_info():</span>
</div></div><div data-line="20" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    cmd = [&#39;/usr/sbin/system_profiler&#39;, &#39;SPHardwareDataType&#39;, &#39;-xml&#39;]</span>
</div></div><div data-line="21" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    proc = subprocess.Popen(cmd, shell=False, bufsize=-1,</span>
</div></div><div data-line="22" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">                            stdin=subprocess.PIPE,</span>
</div></div><div data-line="23" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">                            stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span>
</div></div><div data-line="24" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    (output, unused_error) = proc.communicate()</span>
</div></div><div data-line="25" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    try:</span>
</div></div><div data-line="26" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        plist = FoundationPlist.readPlistFromString(output)</span>
</div></div><div data-line="27" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        # system_profiler xml is an array</span>
</div></div><div data-line="28" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        sp_dict = plist[0]</span>
</div></div><div data-line="29" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        items = sp_dict[&#39;_items&#39;]</span>
</div></div><div data-line="30" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        sp_hardware_dict = items[0]</span>
</div></div><div data-line="31" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        return sp_hardware_dict</span>
</div></div><div data-line="32" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    except Exception:</span>
</div></div><div data-line="33" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        return &#x7b;&#x7b;&#x7d;&#x7d;</span>
</div></div><div data-line="34" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="35" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">hardware_info = get_hardware_info()</span>
</div></div><div data-line="36" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="37" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">serial = hardware_info.get(&#39;serial_number&#39;, &#39;UNKNOWN&#39;)</span>
</div></div><div data-line="38" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">serial = re.sub(&#39;[^A-Za-z0-9]+&#39;, &#39;&#39;, serial)</span>
</div></div><div data-line="39" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">serial_lower = serial.lower()</span>
</div></div><div data-line="40" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">username_and_password = username+&#39;:&#39;+password</span>
</div></div><div data-line="41" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">data = &#x7b;&#x7b;</span>
</div></div><div data-line="42" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#39;serial&#39;: serial,</span>
</div></div><div data-line="43" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#39;site&#39;: site,</span>
</div></div><div data-line="44" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#39;build&#39;: build</span>
</div></div><div data-line="45" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#x7d;&#x7d;</span>
</div></div><div data-line="46" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="47" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">cmd = [&#39;/usr/bin/curl&#39;, &#39;-u&#39;, username_and_password, &#39;--data&#39;, urllib.urlencode(data), url+&#39;/gen_manifest&#39;]</span>
</div></div><div data-line="48" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">task = subprocess.Popen(cmd, stdout=subprocess.PIPE).communicate()[0]</span>
</div></div><div data-line="49" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="50" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">build</span><span class="p">,</span> <span class="n">my_username</span><span class="p">,</span> <span class="n">my_password</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</div></div><div data-line="51" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="n">script</span></div></div></pre></div></figure>

<h2 id="prepare-the-build">Prepare the build</h2>

<p>Now we’re ready to build our Docker image. Make sure your  Docker Machine VM is running and that you’ve run all the commands the Docker guide told you to and:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">docker build -t bootstrapapp .</div></div></pre></div></figure>

<p>You’ll see the base image being downloaded (if you don’t already have it) and then each step of your Dockerfile being run. Now we’ve got an image built, let’s run it. Assuming your VM’s IP address is <code>172.16.155.136</code> (you can get yours by running <code>docker-machine ip YOURVMNAME</code>):</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>docker run -d --name<span class="o">=</span>bootstrap <span class="se">\</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -e <span class="nv">BOOTSTRAP_URL</span><span class="o">=</span><span class="s1">&#39;http://172.16.155.136:5000&#39;</span> <span class="se">\</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -e <span class="nv">BOOTSTRAP_USERNAME</span><span class="o">=</span>myadmin <span class="se">\</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -e <span class="nv">BOOTSTRAP_PASSWORD</span><span class="o">=</span>mypassword <span class="se">\</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -v /Users/grahamgilbert/src/bootstrapapp/munki_repo:/munki_repo <span class="se">\</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -p 5000:5000 <span class="se">\</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    bootstrapapp</div></div></pre></div></figure>

<p>Obviously replace <code>/Users/grahamgilbert</code> with your own home directory.</p>

<h2 id="will-it-blend">Will it blend?</h2>

<p>Let’s try pulling the script down:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">curl --user <span class="s2">&quot;myadmin:mypassword&quot;</span> --header <span class="s2">&quot;X-bootstrap-build: build&quot;</span> --header <span class="s2">&quot;X-bootstrap-site: site&quot;</span> http://172.16.155.136:5000</div></div></pre></div></figure>

<p>Let’s test manifest creation:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span>curl --user <span class="s2">&quot;myadmin:mypassword&quot;</span> --data <span class="s1">&#39;serial=xyz789&amp;site=london&amp;build=somebuild&#39;</span> http://172.16.155.136:5000/gen_manifest</div></div></pre></div></figure>

<p>You should see your manifest being created on your Mac’s filesystem.</p>

<p>And you can also see what your container is doing:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">docker logs bootstrap</div></div></pre></div></figure>

<h2 id="using-it-with-imagr">Using it with Imagr</h2>

<p>Now to last part - using the thing. Let’s generate the hash of your chosen username and password:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>python -c <span class="s1">&#39;import base64; print &quot;Authorization: Basic %s&quot; % base64.b64encode(&quot;USERNAME:PASSWORD&quot;)&#39;</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">Authorization: Basic <span class="nv">VVNFUk5BTUU6UEFTU1dPUkQ</span><span class="o">=</span></div></div></pre></div></figure>

<p>And add the following component to your Imagr workflow, substituting the output of the previous command:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>additional_headers<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;array&gt;</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>Authorization: Basic VVNFUk5BTUU6UEFTU1dPUkQ=<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>X-enrolment-build: some_build<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>X-enrolment-site: test_site<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;/array&gt;</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>type<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>script<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="10" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>url<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="11" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>http://172.16.155.136:5000<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="12" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nt">&lt;/dict&gt;</span></div></div></pre></div></figure>

<h2 id="whats-next">What’s next?</h2>

<p>You could now <a href="https://docs.docker.com/engine/userguide/dockerrepos/">push this image to the Docker Hub</a>, or you could build it on your server. If you want to see the completed project, I’ve posted it on <a href="https://github.com/grahamgilbert/bootstrapapp">GitHub</a>, and I’ve set up an <a href="https://hub.docker.com/r/grahamgilbert/bootstrapapp">automated build on the Docker Hub</a> if you want to use it and be lazy ;)</p>

<h2 id="fin">Fin</h2>

<p>Congratulations - you’ve build a web app using the Flask framework, dynamically served scripts to Imagr, made your manifests for Munki on the fly and wrapped it all up into a Docker image.</p>

</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//grahamgilbert.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2017/02/08/something-something-commercial-something-something-opensource/">
            Something something commercial, something something opensource
            <small>08 Feb 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2017/01/19/pocket-mac-admins-guide-to-london/">
            Pocket Mac admin's guide to London
            <small>19 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2017/01/11/imagr-with-target-disk-mode/">
            Imagr with target disk mode
            <small>11 Jan 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27233739-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
