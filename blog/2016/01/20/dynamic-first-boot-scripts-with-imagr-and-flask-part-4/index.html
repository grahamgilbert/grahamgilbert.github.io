<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Dynamic first boot scripts with Imagr and Flask&#58; Part 4 &#8211; graham gilbert dot com</title>
<meta name="description" content="If you are just starting with this series, it is highly recommended you start with Part 1.

The last part of this series is making it work in a Docker container. This is not a Docker tutorial - please head over to Docker’s getting started pages to get yourself set up with the Docker Toolbox.

All done? Let’s crack on with first creating our Dockerfile.

">
<meta name="keywords" content="">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Dynamic first boot scripts with Imagr and Flask&#58; Part 4">
<meta name="twitter:description" content="If you are just starting with this series, it is highly recommended you start with Part 1.

The last part of this series is making it work in a Docker container. This is not a Docker tutorial - please head over to Docker’s getting started pages to get yourself set up with the Docker Toolbox.

All done? Let’s crack on with first creating our Dockerfile.

">
<meta name="twitter:site" content="@grahamgilbert">
<meta name="twitter:creator" content="@grahamgilbert">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://grahamgilbert.com/images/about.jpg">

<!-- Open Graph -->
<meta property="og:locale" content="en_GB">
<meta property="og:type" content="article">
<meta property="og:title" content="Dynamic first boot scripts with Imagr and Flask&#58; Part 4">
<meta property="og:description" content="If you are just starting with this series, it is highly recommended you start with Part 1.

The last part of this series is making it work in a Docker container. This is not a Docker tutorial - please head over to Docker’s getting started pages to get yourself set up with the Docker Toolbox.

All done? Let’s crack on with first creating our Dockerfile.

">
<meta property="og:url" content="http://grahamgilbert.com/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/">
<meta property="og:site_name" content="graham gilbert dot com">

<meta property="og:image" content="http://grahamgilbert.com/images/about.jpg">





<link rel="canonical" href="http://grahamgilbert.com/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/">
<link href="http://grahamgilbert.com/atom.xml" type="application/atom+xml" rel="alternate" title="graham gilbert dot com Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://grahamgilbert.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://grahamgilbert.com/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://grahamgilbert.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://grahamgilbert.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<link href='/stylesheets/all-e0260dc5ae0daef003df9eded89731d4.css' media='all' rel='stylesheet' type='text/css'>
</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<input type="text" class="st-default-search-input" style="width: 150px;">
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/" >Home</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/about/" >About</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/talks/" >Talks</a></li>
				
				    
				        
				        
				    <li><a href="http://twitter.com/grahamgilbert" target="_blank">Twitter</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/posts/" >Archives</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    <div itemscope itemtype="http://schema.org/Person">

	<img src="http://grahamgilbert.com/images/about.jpg" class="bio-photo" alt="Graham Gilbert bio photo">


  <h3 itemprop="name">Graham Gilbert</h3>
  <p>A Mac admin, automating the hell out of things in London.<br /><br />The opinions on this site are my own, and are not necessarily shared by my employer.</p>
  <a href="http://twitter.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  <a href="http://linkedin.com/in/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
  
  
  
  <a href="http://github.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>
  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://grahamgilbert.com/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/" rel="bookmark" title="Dynamic first boot scripts with Imagr and Flask&#58; Part 4">Dynamic first boot scripts with Imagr and Flask&#58; Part 4</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>If you are just starting with this series, it is highly recommended you start with <a href="http://grahamgilbert.com/blog/2016/01/05/dynamic-first-boot-scripts-with-imagr-and-flask/">Part 1</a>.</p>

<p>The last part of this series is making it work in a Docker container. This is <strong>not</strong> a Docker tutorial - please head over to Docker’s <a href="https://docs.docker.com/mac/">getting started</a> pages to get yourself set up with the Docker Toolbox.</p>

<p>All done? Let’s crack on with first creating our Dockerfile. <!-- more --></p>

<p>In the same <code>~/src/boostrapapp</code> directory as your main script, create a new file called <code>Dockerfile</code> with the following contents:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/Dockerfile</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">FROM</span> python:2.7-slim
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">ENV</span> <span class="nv">BOOTSTRAP_DEBUG</span><span class="o">=</span><span class="nb">false </span><span class="nv">BOOTSTRAP_USERNAME</span><span class="o">=</span>admin <span class="nv">BOOTSTRAP_PASSWORD</span><span class="o">=</span>secret <span class="nv">BOOTSTRAP_URL</span><span class="o">=</span><span class="s2">&quot;http://localhost:5000&quot;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">COPY requirements.txt /requirements.txt
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">COPY gunicorn_config.py /gunicorn_config.py
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">COPY bootstrap.py /bootstrap.py
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">RUN</span> pip install -r /requirements.txt <span class="o">&amp;&amp;</span> <span class="err">\</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    rm /requirements.txt <span class="o">&amp;&amp;</span> <span class="err">\</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    pip install gunicorn futures
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">CMD</span> gunicorn -c gunicorn_config.py bootstrap:app
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">EXPOSE</span> <span class="m">5000</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">VOLUME</span> <span class="o">[</span><span class="s2">&quot;/munki_repo&quot;</span><span class="o">]</span></div></div></pre></div></figure>

<p>In the Dockerfile we copied a couple of files. The first is the requirements file - this will install the bits into python we need to run our app. Fortunately, this is incredibly easy to generate:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span><span class="nb">source</span> ~/virtualenvs/bootstrapapp/bin/activate
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span><span class="nb">cd</span> ~/src/bootstrapapp
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span>pip freeze &gt; requirements.txt</div></div></pre></div></figure>

<p>And now for <code>gunicorn_config.py</code>. Up until now we have been using Flask’s built in web server. This is fine for development, but in production it is better to use a more robust server. You would normally put an app running with Gunicorn behind a proxy server (you could use my <a href="http://grahamgilbert.com/blog/2015/08/26/using-a-proxy-container-with-docker-for-virtualhosts/">Proxy image</a>), but this time we won’t for the sake of simplicity.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">multiprocessing</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">getenv</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">bind</span> <span class="o">=</span> <span class="s">&#39;0.0.0.0:5000&#39;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">workers</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">timeout</span> <span class="o">=</span> <span class="mi">600</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">threads</span> <span class="o">=</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> <span class="o">*</span> <span class="mi">2</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">max_requests</span> <span class="o">=</span> <span class="mi">600</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">max_requests_jitter</span> <span class="o">=</span> <span class="mi">50</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">errorlog</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">accesslog</span> <span class="o">=</span> <span class="s">&#39;-&#39;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">loglevel</span> <span class="o">=</span> <span class="s">&#39;warning&#39;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># Read the DEBUG setting from env var</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_DEBUG&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">loglevel</span> <span class="o">=</span> <span class="s">&#39;debug&#39;</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">pass</span></div></div></pre></div></figure>

<p>Our last step before building the image is to replace a few parts that we’ve hardcoded into <code>bootstrap.py</code> with environment variables so they can be customised when the Docker image is run.</p>

<p>First off we have our username and password for HTTP authentication. Change:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="s">&#39;admin&#39;</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="s">&#39;secret&#39;</span></div></div></pre></div></figure>

<p>To look like:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_USERNAME&#39;</span><span class="p">,</span> <span class="s">&#39;admin&#39;</span><span class="p">)</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="s">&#39;admin&#39;</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_PASSWORD&#39;</span><span class="p">,</span> <span class="s">&#39;secret&#39;</span><span class="p">)</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="s">&#39;secret&#39;</span></div></div></pre></div></figure>

<p>Running our app in debug mode is useful during development, but can pose a security risk in production - let’s be able to turn that on and off. Replace <code>DEBUG = True</code> at the top of <code>boostrap.py</code> with:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/bootstrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_DEBUG&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;true&#39;</span><span class="p">:</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">False</span></div></div></pre></div></figure>

<p>One last part is to be able to set our URL that the app is served on - we return this in the script that is sent to our clients, so we need to tell the container about it. Replace your <code>def index</code> section with:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/bootstrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nd">@requires_auth</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">build</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-bootstrap-build&#39;</span><span class="p">)</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">site</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-bootstrap-site&#39;</span><span class="p">)</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s">&#39;BOOTSTRAP_URL&#39;</span><span class="p">,</span> <span class="s">&#39;http://localhost:5000&#39;</span><span class="p">)</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">script</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;#!/usr/bin/python</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">import subprocess</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">import re</span>
</div></div><div data-line="10" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">import urllib</span>
</div></div><div data-line="11" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">import os</span>
</div></div><div data-line="12" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="13" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">site=&#39;&#x7b;0&#x7d;&#39;</span>
</div></div><div data-line="14" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">build=&#39;&#x7b;1&#x7d;&#39;</span>
</div></div><div data-line="15" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">username=&#39;&#x7b;2&#x7d;&#39;</span>
</div></div><div data-line="16" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">password=&#39;&#x7b;3&#x7d;&#39;</span>
</div></div><div data-line="17" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">url=&#39;&#x7b;4&#x7d;&#39;</span>
</div></div><div data-line="18" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">def get_hardware_info():</span>
</div></div><div data-line="20" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    cmd = [&#39;/usr/sbin/system_profiler&#39;, &#39;SPHardwareDataType&#39;, &#39;-xml&#39;]</span>
</div></div><div data-line="21" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    proc = subprocess.Popen(cmd, shell=False, bufsize=-1,</span>
</div></div><div data-line="22" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">                            stdin=subprocess.PIPE,</span>
</div></div><div data-line="23" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">                            stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span>
</div></div><div data-line="24" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    (output, unused_error) = proc.communicate()</span>
</div></div><div data-line="25" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    try:</span>
</div></div><div data-line="26" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        plist = FoundationPlist.readPlistFromString(output)</span>
</div></div><div data-line="27" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        # system_profiler xml is an array</span>
</div></div><div data-line="28" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        sp_dict = plist[0]</span>
</div></div><div data-line="29" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        items = sp_dict[&#39;_items&#39;]</span>
</div></div><div data-line="30" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        sp_hardware_dict = items[0]</span>
</div></div><div data-line="31" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        return sp_hardware_dict</span>
</div></div><div data-line="32" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">    except Exception:</span>
</div></div><div data-line="33" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">        return &#x7b;&#x7b;&#x7d;&#x7d;</span>
</div></div><div data-line="34" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="35" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">hardware_info = get_hardware_info()</span>
</div></div><div data-line="36" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="37" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">serial = hardware_info.get(&#39;serial_number&#39;, &#39;UNKNOWN&#39;)</span>
</div></div><div data-line="38" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">serial = re.sub(&#39;[^A-Za-z0-9]+&#39;, &#39;&#39;, serial)</span>
</div></div><div data-line="39" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">serial_lower = serial.lower()</span>
</div></div><div data-line="40" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">username_and_password = username+&#39;:&#39;+password</span>
</div></div><div data-line="41" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">data = &#x7b;&#x7b;</span>
</div></div><div data-line="42" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#39;serial&#39;: serial,</span>
</div></div><div data-line="43" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#39;site&#39;: site,</span>
</div></div><div data-line="44" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#39;build&#39;: build</span>
</div></div><div data-line="45" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#x7d;&#x7d;</span>
</div></div><div data-line="46" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="47" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">cmd = [&#39;/usr/bin/curl&#39;, &#39;-u&#39;, username_and_password, &#39;--data&#39;, urllib.urlencode(data), url+&#39;/gen_manifest&#39;]</span>
</div></div><div data-line="48" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">task = subprocess.Popen(cmd, stdout=subprocess.PIPE).communicate()[0]</span>
</div></div><div data-line="49" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="50" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="s">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">build</span><span class="p">,</span> <span class="n">my_username</span><span class="p">,</span> <span class="n">my_password</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
</div></div><div data-line="51" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="n">script</span></div></div></pre></div></figure>

<h2 id="prepare-the-build">Prepare the build</h2>

<p>Now we’re ready to build our Docker image. Make sure your  Docker Machine VM is running and that you’ve run all the commands the Docker guide told you to and:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">docker build -t bootstrapapp .</div></div></pre></div></figure>

<p>You’ll see the base image being downloaded (if you don’t already have it) and then each step of your Dockerfile being run. Now we’ve got an image built, let’s run it. Assuming your VM’s IP address is <code>172.16.155.136</code> (you can get yours by running <code>docker-machine ip YOURVMNAME</code>):</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>docker run -d --name<span class="o">=</span>bootstrap <span class="se">\</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -e <span class="nv">BOOTSTRAP_URL</span><span class="o">=</span><span class="s1">&#39;http://172.16.155.136:5000&#39;</span> <span class="se">\</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -e <span class="nv">BOOTSTRAP_USERNAME</span><span class="o">=</span>myadmin <span class="se">\</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -e <span class="nv">BOOTSTRAP_PASSWORD</span><span class="o">=</span>mypassword <span class="se">\</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -v /Users/grahamgilbert/src/bootstrapapp/munki_repo:/munki_repo <span class="se">\</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line">    -p 5000:5000 <span class="se">\</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    bootstrapapp</div></div></pre></div></figure>

<p>Obviously replace <code>/Users/grahamgilbert</code> with your own home directory.</p>

<h2 id="will-it-blend">Will it blend?</h2>

<p>Let’s try pulling the script down:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">curl --user <span class="s2">&quot;myadmin:mypassword&quot;</span> --header <span class="s2">&quot;X-bootstrap-build: build&quot;</span> --header <span class="s2">&quot;X-bootstrap-site: site&quot;</span> http://172.16.155.136:5000</div></div></pre></div></figure>

<p>Let’s test manifest creation:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span>curl --user <span class="s2">&quot;myadmin:mypassword&quot;</span> --data <span class="s1">&#39;serial=xyz789&amp;site=london&amp;build=somebuild&#39;</span> http://172.16.155.136:5000/gen_manifest</div></div></pre></div></figure>

<p>You should see your manifest being created on your Mac’s filesystem.</p>

<p>And you can also see what your container is doing:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">docker logs bootstrap</div></div></pre></div></figure>

<h2 id="using-it-with-imagr">Using it with Imagr</h2>

<p>Now to last part - using the thing. Let’s generate the hash of your chosen username and password:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>python -c <span class="s1">&#39;import base64; print &quot;Authorization: Basic %s&quot; % base64.b64encode(&quot;USERNAME:PASSWORD&quot;)&#39;</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">Authorization: Basic <span class="nv">VVNFUk5BTUU6UEFTU1dPUkQ</span><span class="o">=</span></div></div></pre></div></figure>

<p>And add the following component to your Imagr workflow, substituting the output of the previous command:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>additional_headers<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;array&gt;</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>Authorization: Basic VVNFUk5BTUU6UEFTU1dPUkQ=<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>X-enrolment-build: some_build<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>X-enrolment-site: test_site<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;/array&gt;</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>type<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>script<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="10" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>url<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="11" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>http://172.16.155.136:5000<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="12" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nt">&lt;/dict&gt;</span></div></div></pre></div></figure>

<h2 id="whats-next">What’s next?</h2>

<p>You could now <a href="https://docs.docker.com/engine/userguide/dockerrepos/">push this image to the Docker Hub</a>, or you could build it on your server. If you want to see the completed project, I’ve posted it on <a href="https://github.com/grahamgilbert/bootstrapapp">GitHub</a>, and I’ve set up an <a href="https://hub.docker.com/r/grahamgilbert/bootstrapapp">automated build on the Docker Hub</a> if you want to use it and be lazy ;)</p>

<h2 id="fin">Fin</h2>

<p>Congratulations - you’ve build a web app using the Flask framework, dynamically served scripts to Imagr, made your manifests for Munki on the fly and wrapped it all up into a Docker image.</p>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://grahamgilbert.com/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://grahamgilbert.com/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://grahamgilbert.com/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>Dynamic first boot scripts with Imagr and Flask&#58; Part 4</strong> was published on <time datetime="2016-01-20T05:49:05+00:00">January 20, 2016</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://grahamgilbert.com/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://grahamgilbert.com/blog/2016/01/14/imagr-1-0-0-released/" title="Imagr 1.0.0 Released">Imagr 1.0.0 Released</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2016/01/13/dynamic-first-boot-scripts-with-imagr-and-flask-part-3/" title="Dynamic first boot scripts with Imagr and Flask&#58; Part 3">Dynamic first boot scripts with Imagr and Flask&#58; Part 3</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2016/01/07/dynamic-first-boot-scripts-with-imagr-and-flask-part-2/" title="Dynamic first boot scripts with Imagr and Flask&#58; Part 2">Dynamic first boot scripts with Imagr and Flask&#58; Part 2</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    <span>&copy; 2016 Graham Gilbert.</span>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://grahamgilbert.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://grahamgilbert.com/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-27233739-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','sFQe2UApMaKvCdHMFL6r','2.0.0');
</script>
          


  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'grahamgilbert'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</body>
</html>
