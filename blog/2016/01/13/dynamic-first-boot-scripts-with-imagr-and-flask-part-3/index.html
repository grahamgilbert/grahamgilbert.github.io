<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Dynamic first boot scripts with Imagr and Flask&#58; Part 3 &#8211; graham gilbert dot com</title>
<meta name="description" content="If you are just starting with this series, it is highly recommended you start with Part 1.

Last time around we got our app returning something useful to Imagr. This time around we’ll make our second endpoint - the one that will create the machine’s individual Munki manifest on the server.

Our fictional setup is making use of the default manifests Munki looks for - eventually it will request the machine’s serial number if no client identifier is set. Our manifest will contain three other included manifests:


  One for the site where the machine is located.
  One for the machine’s build.
  A general one for all machines (the site default).


">
<meta name="keywords" content="">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Dynamic first boot scripts with Imagr and Flask&#58; Part 3">
<meta name="twitter:description" content="If you are just starting with this series, it is highly recommended you start with Part 1.

Last time around we got our app returning something useful to Imagr. This time around we’ll make our second endpoint - the one that will create the machine’s individual Munki manifest on the server.

Our fictional setup is making use of the default manifests Munki looks for - eventually it will request the machine’s serial number if no client identifier is set. Our manifest will contain three other included manifests:


  One for the site where the machine is located.
  One for the machine’s build.
  A general one for all machines (the site default).


">
<meta name="twitter:site" content="@grahamgilbert">
<meta name="twitter:creator" content="@grahamgilbert">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://grahamgilbert.com/images/about.jpg">

<!-- Open Graph -->
<meta property="og:locale" content="en_GB">
<meta property="og:type" content="article">
<meta property="og:title" content="Dynamic first boot scripts with Imagr and Flask&#58; Part 3">
<meta property="og:description" content="If you are just starting with this series, it is highly recommended you start with Part 1.

Last time around we got our app returning something useful to Imagr. This time around we’ll make our second endpoint - the one that will create the machine’s individual Munki manifest on the server.

Our fictional setup is making use of the default manifests Munki looks for - eventually it will request the machine’s serial number if no client identifier is set. Our manifest will contain three other included manifests:


  One for the site where the machine is located.
  One for the machine’s build.
  A general one for all machines (the site default).


">
<meta property="og:url" content="http://grahamgilbert.com/blog/2016/01/13/dynamic-first-boot-scripts-with-imagr-and-flask-part-3/">
<meta property="og:site_name" content="graham gilbert dot com">

<meta property="og:image" content="http://grahamgilbert.com/images/about.jpg">





<link rel="canonical" href="http://grahamgilbert.com/blog/2016/01/13/dynamic-first-boot-scripts-with-imagr-and-flask-part-3/">
<link href="http://grahamgilbert.com/atom.xml" type="application/atom+xml" rel="alternate" title="graham gilbert dot com Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://grahamgilbert.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://grahamgilbert.com/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://grahamgilbert.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://grahamgilbert.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<link href='/stylesheets/all-e0260dc5ae0daef003df9eded89731d4.css' media='all' rel='stylesheet' type='text/css'>
<style>
article a {
    text-decoration: underline;
}
</style>
</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<input type="text" class="st-default-search-input" style="width: 150px;">
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/" >Home</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/about/" >About</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/talks/" >Talks</a></li>
				
				    
				        
				        
				    <li><a href="http://twitter.com/grahamgilbert" target="_blank">Twitter</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/posts/" >Archives</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    <div itemscope itemtype="http://schema.org/Person">

	<img src="http://grahamgilbert.com/images/about.jpg" class="bio-photo" alt="Graham Gilbert bio photo">


  <h3 itemprop="name">Graham Gilbert</h3>
  <p>A Mac admin, automating the hell out of things in London.<br /><br />The opinions on this site are my own, and are not necessarily shared by my employer.</p>
  <a href="http://twitter.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  <a href="http://linkedin.com/in/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
  
  
  
  <a href="http://github.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>
  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://grahamgilbert.com/blog/2016/01/13/dynamic-first-boot-scripts-with-imagr-and-flask-part-3/" rel="bookmark" title="Dynamic first boot scripts with Imagr and Flask&#58; Part 3">Dynamic first boot scripts with Imagr and Flask&#58; Part 3</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>If you are just starting with this series, it is highly recommended you start with <a href="http://grahamgilbert.com/blog/2016/01/05/dynamic-first-boot-scripts-with-imagr-and-flask/">Part 1</a>.</p>

<p>Last time around we got our app returning something useful to Imagr. This time around we’ll make our second endpoint - the one that will create the machine’s individual Munki manifest on the server.</p>

<p>Our fictional setup is making use of the default manifests Munki looks for - eventually it will request the machine’s serial number if no client identifier is set. Our manifest will contain three other included manifests:</p>

<ul>
  <li>One for the site where the machine is located.</li>
  <li>One for the machine’s build.</li>
  <li>A general one for all machines (the site default).<!-- more --></li>
</ul>

<p>The first job is to import the <code>plistlib</code> module. Python has built in support for handling plists, but we need to tell it about them. Put the following line in <code>bootstrap.py</code> after your other imports at the top:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/bootstrapapp/boostrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">plistlib</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">os</span></div></div></pre></div></figure>

<p>In our final Docker image, we’ll be expecting to mount our production Munki repo into it, but for now we’ll assume it’s in the same directory as <code>bootstrap.py</code>. The following code will:</p>

<ul>
  <li>Check to see if the machine already has a manifest.</li>
  <li>If it doesn’t, it will be added to the <code>production</code> catalog. If it does, it will keep it’s current catalog.</li>
  <li>It will add the included manifests mentioned above to the manifest.</li>
</ul>

<p>Now for the code that will actually make our Munki manifest. Replace the section that looks like:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/gen_manifest&#39;</span><span class="p">)</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">gen_manifest</span><span class="p">():</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="s">&#39;hello&#39;</span></div></div></pre></div></figure>

<p>with:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/gen_manifest&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
</div></div><div data-line="2" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nd">@requires_auth</span>
</div></div><div data-line="3" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">gen_manifest</span><span class="p">():</span>
</div></div><div data-line="4" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">build</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;build&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div></div><div data-line="5" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">site</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;site&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div></div><div data-line="6" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">serial</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;serial&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div></div><div data-line="7" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="c"># If we&#39;re re-imaging, these are required</span>
</div></div><div data-line="8" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">build</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">site</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">serial</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
</div></div><div data-line="9" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
</div></div><div data-line="10" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="11" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="c"># Currently we&#39;re assuming it&#39;s in the same directory as this script</span>
</div></div><div data-line="12" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">munki_repo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span>
</div></div><div data-line="13" class="code-highlight-row unnumbered"><div class="code-highlight-line">                                            <span class="s">&#39;munki_repo&#39;</span><span class="p">)</span>
</div></div><div data-line="14" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">manifest_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">munki_repo</span><span class="p">,</span> <span class="s">&#39;manifests&#39;</span><span class="p">,</span> <span class="n">serial</span><span class="p">)</span>
</div></div><div data-line="15" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="c"># if the manifest doesn&#39;t already exist set the catalog</span>
</div></div><div data-line="16" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">):</span>
</div></div><div data-line="17" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">manifest</span> <span class="o">=</span> <span class="p">&#x7b;&#x7d;</span>
</div></div><div data-line="18" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;catalogs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;production&#39;</span><span class="p">]</span>
</div></div><div data-line="19" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="20" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">manifest</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlist</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">)</span>
</div></div><div data-line="21" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;included_manifests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;site_default&#39;</span><span class="p">]</span>
</div></div><div data-line="22" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">site</span><span class="p">:</span>
</div></div><div data-line="23" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">site_manifest</span> <span class="o">=</span> <span class="s">&#39;included_manifests/sites/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">site</span>
</div></div><div data-line="24" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;included_manifests&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site_manifest</span><span class="p">)</span>
</div></div><div data-line="25" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">build</span><span class="p">:</span>
</div></div><div data-line="26" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">build_manifest</span> <span class="o">=</span> <span class="s">&#39;included_manifests/builds/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">build</span>
</div></div><div data-line="27" class="code-highlight-row unnumbered"><div class="code-highlight-line">        <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;included_manifests&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build_manifest</span><span class="p">)</span>
</div></div><div data-line="28" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="n">plistlib</span><span class="o">.</span><span class="n">writePlist</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">manifest_file</span><span class="p">)</span>
</div></div><div data-line="29" class="code-highlight-row unnumbered"><div class="code-highlight-line"> </div></div><div data-line="30" class="code-highlight-row unnumbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="s">&#39;Manifest saved&#39;</span></div></div></pre></div></figure>

<p>Let’s make sure there aren’t any errors. Make sure you’ve activated the virtualenv we made in the first part and run the debug server:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span><span class="nb">source</span> ~/virtualenvs/bootstrapapp/bin/activate
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span><span class="nb">cd</span> ~/src/bootstrapapp
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span>python bootstrap.py admin secret</div></div></pre></div></figure>

<p>Make sure there are <code>munki_repo</code> and <code>manifests</code> directories in <code>~/src/bootstrapapp</code> (so you have <code>~/src/boostrapapp/munki_repo/manifests</code>) and try curling your second script:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nv">$ </span>curl --user <span class="s2">&quot;admin:secret&quot;</span> --data <span class="s1">&#39;serial=abc123&amp;site=london&amp;build=somebuild&#39;</span> http://localhost:5000/gen_manifest</div></div></pre></div></figure>

<p>All being well, you will see your manifest being made in the right place.</p>

<p>And for the sake of completeness, here’s <code>bootstrap.py</code> after the end of part 3.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/boostrapapp/bootstrap.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">Response</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">sys</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">plistlib</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">os</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">DEBUG</span> <span class="o">=</span> <span class="bp">True</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">my_username</span> <span class="o">=</span> <span class="s">&#39;admin&#39;</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">try</span><span class="p">:</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">except</span><span class="p">:</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">my_password</span> <span class="o">=</span> <span class="s">&#39;secret&#39;</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="sd">&quot;&quot;&quot;This function is called to check if a username /</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">    password combination is valid.</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">    &quot;&quot;&quot;</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="n">username</span> <span class="o">==</span> <span class="n">my_username</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="n">my_password</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">authenticate</span><span class="p">():</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="sd">&quot;&quot;&quot;Sends a 401 response that enables basic auth&quot;&quot;&quot;</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="s">&#39;Could not verify your access level for that URL.</span><span class="se">\n</span><span class="s">&#39;</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="s">&#39;You have to login with proper credentials&#39;</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7b;</span><span class="s">&#39;WWW-Authenticate&#39;</span><span class="p">:</span> <span class="s">&#39;Basic realm=&quot;Login Required&quot;&#39;</span><span class="p">&#x7d;)</span>
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">requires_auth</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
</div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">check_auth</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">auth</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">return</span> <span class="n">authenticate</span><span class="p">()</span>
</div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="n">decorated</span>
</div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/gen_manifest&#39;</span><span class="p">,</span> <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;GET&#39;</span><span class="p">,</span> <span class="s">&#39;POST&#39;</span><span class="p">])</span>
</div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nd">@requires_auth</span>
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">gen_manifest</span><span class="p">():</span>
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">build</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;build&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div></div><div data-line="45" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">site</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;site&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div></div><div data-line="46" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">serial</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;serial&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
</div></div><div data-line="47" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># If we&#39;re re-imaging, these are required</span>
</div></div><div data-line="48" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">build</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">site</span> <span class="o">==</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">serial</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
</div></div><div data-line="49" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>
</div></div><div data-line="50" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="51" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># Currently we&#39;re assuming it&#39;s in the same directory as this script</span>
</div></div><div data-line="52" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">munki_repo</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">__file__</span><span class="p">)),</span>
</div></div><div data-line="53" class="code-highlight-row numbered"><div class="code-highlight-line">                                            <span class="s">&#39;munki_repo&#39;</span><span class="p">)</span>
</div></div><div data-line="54" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">manifest_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">munki_repo</span><span class="p">,</span> <span class="s">&#39;manifests&#39;</span><span class="p">,</span> <span class="n">serial</span><span class="p">)</span>
</div></div><div data-line="55" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="56" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># if the manifests dir doesn&#39;t exist, make it</span>
</div></div><div data-line="57" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">munki_repo</span><span class="p">,</span> <span class="s">&#39;manifests&#39;</span><span class="p">)):</span>
</div></div><div data-line="58" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">munki_repo</span><span class="p">,</span> <span class="s">&#39;manifests&#39;</span><span class="p">))</span>
</div></div><div data-line="59" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="60" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># if the manifest doesn&#39;t already exist set the catalog</span>
</div></div><div data-line="61" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">):</span>
</div></div><div data-line="62" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">manifest</span> <span class="o">=</span> <span class="p">&#x7b;&#x7d;</span>
</div></div><div data-line="63" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;catalogs&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;production&#39;</span><span class="p">]</span>
</div></div><div data-line="64" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="65" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">manifest</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlist</span><span class="p">(</span><span class="n">manifest_file</span><span class="p">)</span>
</div></div><div data-line="66" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;included_manifests&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;site_default&#39;</span><span class="p">]</span>
</div></div><div data-line="67" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">site</span><span class="p">:</span>
</div></div><div data-line="68" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">site_manifest</span> <span class="o">=</span> <span class="s">&#39;included_manifests/sites/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">site</span>
</div></div><div data-line="69" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;included_manifests&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">site_manifest</span><span class="p">)</span>
</div></div><div data-line="70" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">if</span> <span class="n">build</span><span class="p">:</span>
</div></div><div data-line="71" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">build_manifest</span> <span class="o">=</span> <span class="s">&#39;included_manifests/builds/</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">build</span>
</div></div><div data-line="72" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">manifest</span><span class="p">[</span><span class="s">&#39;included_manifests&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">build_manifest</span><span class="p">)</span>
</div></div><div data-line="73" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">plistlib</span><span class="o">.</span><span class="n">writePlist</span><span class="p">(</span><span class="n">manifest</span><span class="p">,</span> <span class="n">manifest_file</span><span class="p">)</span>
</div></div><div data-line="74" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="75" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="s">&#39;Manifest saved&#39;</span>
</div></div><div data-line="76" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="77" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nd">@app.route</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span>
</div></div><div data-line="78" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nd">@requires_auth</span>
</div></div><div data-line="79" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
</div></div><div data-line="80" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">build</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-bootstrap-build&#39;</span><span class="p">)</span>
</div></div><div data-line="81" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">site</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;X-bootstrap-site&#39;</span><span class="p">)</span>
</div></div><div data-line="82" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="83" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">script</span> <span class="o">=</span> <span class="s">&#39;&#39;&#39;#!/usr/bin/python</span>
</div></div><div data-line="84" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">import subprocess</span>
</div></div><div data-line="85" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">import re</span>
</div></div><div data-line="86" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">import urllib</span>
</div></div><div data-line="87" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">import os</span>
</div></div><div data-line="88" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="89" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">site=&#39;&#x7b;0&#x7d;&#39;</span>
</div></div><div data-line="90" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">build=&#39;&#x7b;1&#x7d;&#39;</span>
</div></div><div data-line="91" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">username=&#39;&#x7b;2&#x7d;&#39;</span>
</div></div><div data-line="92" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">password=&#39;&#x7b;3&#x7d;&#39;</span>
</div></div><div data-line="93" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="94" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">def get_hardware_info():</span>
</div></div><div data-line="95" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">    cmd = [&#39;/usr/sbin/system_profiler&#39;, &#39;SPHardwareDataType&#39;, &#39;-xml&#39;]</span>
</div></div><div data-line="96" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">    proc = subprocess.Popen(cmd, shell=False, bufsize=-1,</span>
</div></div><div data-line="97" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">                            stdin=subprocess.PIPE,</span>
</div></div><div data-line="98" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">                            stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span>
</div></div><div data-line="99" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">    (output, unused_error) = proc.communicate()</span>
</div></div><div data-line="100" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">    try:</span>
</div></div><div data-line="101" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">        plist = FoundationPlist.readPlistFromString(output)</span>
</div></div><div data-line="102" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">        # system_profiler xml is an array</span>
</div></div><div data-line="103" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">        sp_dict = plist[0]</span>
</div></div><div data-line="104" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">        items = sp_dict[&#39;_items&#39;]</span>
</div></div><div data-line="105" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">        sp_hardware_dict = items[0]</span>
</div></div><div data-line="106" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">        return sp_hardware_dict</span>
</div></div><div data-line="107" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">    except Exception:</span>
</div></div><div data-line="108" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">        return &#x7b;&#x7b;&#x7d;&#x7d;</span>
</div></div><div data-line="109" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="110" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">hardware_info = get_hardware_info()</span>
</div></div><div data-line="111" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="112" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">serial = hardware_info.get(&#39;serial_number&#39;, &#39;UNKNOWN&#39;)</span>
</div></div><div data-line="113" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">serial = re.sub(&#39;[^A-Za-z0-9]+&#39;, &#39;&#39;, serial)</span>
</div></div><div data-line="114" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">serial_lower = serial.lower()</span>
</div></div><div data-line="115" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">username_and_password = username+&#39;:&#39;+password</span>
</div></div><div data-line="116" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">data = &#x7b;&#x7b;</span>
</div></div><div data-line="117" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">&#39;serial&#39;: serial,</span>
</div></div><div data-line="118" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">&#39;site&#39;: site,</span>
</div></div><div data-line="119" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">&#39;build&#39;: build</span>
</div></div><div data-line="120" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">&#x7d;&#x7d;</span>
</div></div><div data-line="121" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="122" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">cmd = [&#39;/usr/bin/curl&#39;, &#39;-u&#39;, username_and_password, &#39;--data&#39;, urllib.urlencode(data), &#39;http://localhost:5000/gen_manifest/&#39;]</span>
</div></div><div data-line="123" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">task = subprocess.Popen(cmd, stdout=subprocess.PIPE).communicate()[0]</span>
</div></div><div data-line="124" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="125" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="s">&#39;&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">build</span><span class="p">,</span> <span class="n">my_username</span><span class="p">,</span> <span class="n">my_password</span><span class="p">)</span>
</div></div><div data-line="126" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">return</span> <span class="n">script</span>
</div></div><div data-line="127" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="128" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
</div></div><div data-line="129" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s">&#39;0.0.0.0&#39;</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="n">DEBUG</span><span class="p">)</span></div></div></pre></div></figure>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://grahamgilbert.com/blog/2016/01/13/dynamic-first-boot-scripts-with-imagr-and-flask-part-3/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://grahamgilbert.com/blog/2016/01/13/dynamic-first-boot-scripts-with-imagr-and-flask-part-3/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://grahamgilbert.com/blog/2016/01/13/dynamic-first-boot-scripts-with-imagr-and-flask-part-3/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>Dynamic first boot scripts with Imagr and Flask&#58; Part 3</strong> was published on <time datetime="2016-01-13T08:51:26+00:00">January 13, 2016</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://grahamgilbert.com/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://grahamgilbert.com/blog/2016/02/10/macad-uk-2016-puppet-on-os-x/" title="MacAD.UK 2016&#58; Puppet on OS X">MacAD.UK 2016&#58; Puppet on OS X</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/" title="Dynamic first boot scripts with Imagr and Flask&#58; Part 4">Dynamic first boot scripts with Imagr and Flask&#58; Part 4</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2016/01/14/imagr-1-0-0-released/" title="Imagr 1.0.0 Released">Imagr 1.0.0 Released</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    <span>&copy; 2016 Graham Gilbert.</span>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://grahamgilbert.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://grahamgilbert.com/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-27233739-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');

  _st('install','sFQe2UApMaKvCdHMFL6r','2.0.0');
</script>
          


  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'grahamgilbert'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</body>
</html>
