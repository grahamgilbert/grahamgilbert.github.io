<!DOCTYPE html>
<html lang="en-us">

  <head>
  <script type="text/javascript">
    var host = "grahamgilbert.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Managing OS X Profiles with Puppet &middot; graham gilbert
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <!--link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico"-->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
  <link href='/stylesheets/all-c8369cf731585eb98eef0098877bca87.css' media='all' rel='stylesheet' type='text/css'>
  <link type="application/atom+xml" rel="alternate" href="https://grahamgilbert.com/atom.xml" title="graham gilbert" />
  <style>
  .clear{
    clear:both
  }
  .float-left {
    float:left;
    padding-right:25px;
    padding-bottom:25px;
  }

  .float-right {
    float:right;
    padding-left:25px;
    padding-bottom:25px;
  }
  </style>
</head>

  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          graham gilbert
        </a>
      </h1>
      <p class="lead">A Mac admin, automating the hell out of things.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/talks/">Talks</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
      </nav>
      <p>

      <a href="https://twitter.com/grahamgilbert"><img style="display:inline;" src="/images/social/twitter.png" /></a> <a href="https://github.com/grahamgilbert"><img style="display:inline;" src="/images/social/github.png" /></a> <a href="https://www.linkedin.com/in/grahamgilbert"><img style="display:inline;" src="/images/social/linkedin.png" /></a>
      </p>

    <p>
      <small>The opinions on this site are my own, and are not necessarily shared by my employer.</small>
    </p>

  </div>
</div>

    <div class="content container">
      <div class="post">
  <h1 class="post-title">Managing OS X Profiles with Puppet</h1>
  <span class="post-date">29 Mar 2016</span>
  <p>There are many ways of managing configuration profiles on OS X - you can use MDM, Munki or any one of the other many great tools. My preferred method however is using Puppet.</p>

<p>By using Puppet, I get access to it’s templating features, and I can let others in my team adjust exposed settings through Hiera.</p>

<p>This post will walk you through the development of a a simple Puppet module and how to test it on an OS X virtual machine.<!-- more --></p>

<h2 id="prep">Prep</h2>

<p>Before you do anything, you’re going to need a profile. There are <a href="https://github.com/nmcspadden/Profiles">plenty</a> <a href="https://github.com/gregneagle/profiles">of</a> <a href="https://github.com/golbiga/Profiles">the</a> <a href="https://github.com/rtrouton/profiles">things</a> on Github, or you could run Profile Manager in a VM (please don’t use it for anything more than this, it should never be managing your devices directly), or in the future you’ll be able to use Erik Berglund’s <a href="https://github.com/ProfileCreator/ProfileCreator">ProfileCreator</a>.</p>

<p>Today I’m going to be an evil admin and enforce a desktop picture on my users - there are a couple of profiles on the repositories I linked to above that have an example of this.</p>

<p>We are going to keep our module in git - we’ll use GitHub today, as you can get a free repository and the GUI app is really simple. This is not a git tutorial, so all you will need to do it ‘commit’ your code and sync it to Github. Go ahead and get the <a href="https://desktop.github.com">application</a> and create a new git repository (File -&gt; New in the app once you’ve logged in). It doesn’t matter what you call the repo, but I like to keep my Puppet modules prefixed with <code>puppet-</code> so they line up nicely in the Finder.</p>

<p>There is one other thing you will need for today: an OS X VM to test in that has Puppet Agent installed. You can find installers over on the <a href="http://downloads.puppetlabs.com/mac/">Puppetlabs downloads site</a> (<a href="http://downloads.puppetlabs.com/mac/10.11/PC1/x86_64/">10.11 direct link</a>). You should use the ‘Puppet Collection’ versions in the directories marked <code>10.9</code>, <code>10.10</code> and <code>10.11</code> - these contain Puppet 4, which is the current version of Puppet.</p>

<h2 id="the-module">The module</h2>

<p>Now we’re ready to start writing our module. Open up the directory you just made for your git repo, and create directories called <code>manifests</code> and <code>templates</code> inside.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">~/src/puppet-desktop_picture</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">.
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">├── manifests
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">└── templates</div></div></pre></div></figure>

<p>The first file we’re going to create is our profile template. It will be just the same as any profile you’ve worked with before, but we’re putting in a placeholder where you’d normally put in the path to the image you want to be used for the desktop picture. You should probably replace the reverse domain (<code>com.grahamgilbert</code>) with <code>com.yourcompany</code>.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">templates/com.grahamgilbert.config.desktop.mobileconfig.erb</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadContent<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;array&gt;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">		<span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>PayloadDisplayName<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span>Desktop<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>PayloadEnabled<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;true/&gt;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>PayloadIdentifier<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span>com.grahamgilbert.config.desktop<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>PayloadType<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span>com.apple.desktop<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>PayloadUUID<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span>9EFB0A0A-F64A-4FF4-9477-101295DE7353<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>PayloadVersion<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;integer&gt;</span>1<span class="nt">&lt;/integer&gt;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>locked<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;true/&gt;</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">			<span class="nt">&lt;key&gt;</span>override-picture-path<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="23" class="code-highlight-row numbered marked-line start-marked-line end-marked-line"><div class="code-highlight-line">			<span class="nt">&lt;string&gt;</span><span class="err">&lt;</span>%= @path -%&gt;<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">		<span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;/array&gt;</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadDescription<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>Sets Desktop Picture<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadDisplayName<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>Desktop Background<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadIdentifier<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>com.grahamgilbert.config.desktop<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadOrganization<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>Your Organization<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadRemovalDisallowed<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;true/&gt;</span>
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadScope<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>System<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadType<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>Configuration<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadUUID<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>C7E78A8D-F0E3-4EDC-9BA7-8163E10BA847<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>PayloadVersion<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;integer&gt;</span>1<span class="nt">&lt;/integer&gt;</span>
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="45" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/plist&gt;</span></div></div></pre></div></figure>

<p>That’s our profile template completely finished. If you’ve seen a profile before, it will be familiar - the only change we’ve made is on line 23 where we have replaced what would normally be a path to your desired image with <code>&lt;%= @path -%&gt;</code>. This is an erb tag that will be replaced with our path by Puppet.</p>

<p>Now for the manifest. We’re going to make use of Sam Keeley’s fork of <a href="https://github.com/keeleysam/puppet-mac_profiles_handler">mac_profiles_handler</a> to handle the installation of our profile. Our module will allow the path to the image we want set as the desktop picture, so we have that as an option at the top of the class. The rest is just telling <code>mac_profiles_handler</code> to install our profile.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">manifests/init.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">class</span> <span class="na">desktop_picture</span> <span class="p">(</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nv">$path</span> <span class="o">=</span> <span class="s">&#39;/Library/Desktop Pictures/El Capitan.jpg&#39;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">)</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7b;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="na">mac_profiles_handler</span><span class="p">::</span><span class="na">manage</span> <span class="p">&#x7b;</span> <span class="s">&#39;com.grahamgilbert.config.desktop&#39;</span><span class="p">:</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="na">ensure</span>      <span class="o">=&gt;</span> <span class="s">&#39;present&#39;</span><span class="p">,</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="na">file_source</span> <span class="o">=&gt;</span> <span class="k">template</span><span class="p">(</span><span class="s">&#39;desktop_picture/com.grahamgilbert.config.desktop.mobileconfig.erb&#39;</span><span class="p">),</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="na">type</span>        <span class="o">=&gt;</span> <span class="s">&#39;template&#39;</span><span class="p">,</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>That’s it for our module - you should open up the Github app and commit your code up to Github, creating a repo when the app asks.</p>

<h2 id="testing-it-out">Testing it out</h2>

<p>We’re going to use a tool called r10k to deploy our code. It uses git to make sure your code is all in the right place and up to date. Hop over to your VM and open up Terminal.app and bash in:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>git --version</div></div></pre></div></figure>

<p>If you are prompted to install the Xcode command line tools, do so. If you are just told which version of git you have, you’re all done.</p>

<p>Next we need to get r10k installed.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>sudo gem install r10k</div></div></pre></div></figure>

<p>And now we need to make our Puppetfile. The Puppetfile simply tells r10k which modules to install. Replace <code>https://github.com/grahamgilbert/puppet-desktop_picture.git</code> with the HTTPS URL of your git repository for your newly created module. Your Puppetfile can go anywhere on your test VM (in production, you would use something called a <a href="http://technoblogic.io/blog/2014/05/16/r10k-control-repos/">control repo</a> to manage this).</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">Puppetfile</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c1"># This is a hack so we can deploy locally without using a control repo</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">moduledir</span> <span class="s2">&quot;/etc/puppetlabs/code/environments/production/modules&quot;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">mod</span> <span class="s2">&quot;desktop_picture&quot;</span><span class="p">,</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">&quot;https://github.com/grahamgilbert/puppet-desktop_picture.git&quot;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">mod</span> <span class="s2">&quot;mac_profiles_handler&quot;</span><span class="p">,</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">&quot;https://github.com/keeleysam/puppet-mac_profiles_handler.git&quot;</span><span class="p">,</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="ss">:ref</span> <span class="o">=&gt;</span> <span class="s1">&#39;fc1af5beb3e0d2b6ff577648ef8352e6bb5a6e32&#39;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">mod</span> <span class="s2">&quot;stdlib&quot;</span><span class="p">,</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="ss">:git</span> <span class="o">=&gt;</span> <span class="s2">&quot;https://github.com/puppetlabs/puppetlabs-stdlib.git&quot;</span><span class="p">,</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="ss">:ref</span> <span class="o">=&gt;</span> <span class="s1">&#39;c5486aba6284664ae87a65beaa011211c70ea03e&#39;</span></div></div></pre></div></figure>

<p>Assuming you saved your Puppetfile on the VM’s desktop:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>sudo r10k puppetfile install ~/Desktop/Puppetfile -v</div></div></pre></div></figure>

<p>Now all that’s left is to create your <code>site.pp</code> with a default node that has your class applied to it. You’ll need to do this as root (<code>sudo nano</code> for example).</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/puppetlabs/code/environments/production/manifests/site.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">node</span> <span class="k">default</span> <span class="p">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">include</span> <span class="na">desktop_picture</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>Let’s test it:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>sudo /opt/puppetlabs/bin/puppet apply /etc/puppetlabs/code/environments/production/manifests/site.pp</div></div></pre></div></figure>

<p>You should see your profile being applied to your test VM, and if you try to change the desktop picture, you will be prevented from doing so. But what happens if your users need something different?</p>

<p>You have two choices. You could edit your <code>site.pp</code> to look something like:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/puppetlabs/code/environments/production/manifests/site.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">node</span> <span class="k">default</span> <span class="p">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">class</span> <span class="p">&#x7b;</span><span class="s">&#39;desktop_picture&#39;</span><span class="p">:</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="na">path</span> <span class="o">=&gt;</span> <span class="s">&#39;/Library/Desktop Pictures/Grass Blades.jpg&#39;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>But that’s just messy. We should be using a better tool for this job: Hiera. As root:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">/etc/puppetlabs/code/environments/production/hieradata/common.yaml</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nn">---</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="l-Scalar-Plain">desktop_picture::path</span><span class="p-Indicator">:</span> <span class="s">&#39;/Library/Desktop</span><span class="nv"> </span><span class="s">Pictures/Grass</span><span class="nv"> </span><span class="s">Blades.jpg&#39;</span></div></div></pre></div></figure>

<p>One final <code>puppet apply</code>:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row unnumbered"><div class="code-highlight-line"><span class="nv">$ </span>sudo /opt/puppetlabs/bin/puppet apply /etc/puppetlabs/code/environments/production/manifests/site.pp</div></div></pre></div></figure>

<h2 id="wrap-up">Wrap up</h2>

<p>We’ve created a module that will apply a profile to our Macs. We’ve set up a quick test environment, deployed our module and it’s dependencies and passed configuration to our module via Hiera. Remember this setup should only be used for testing, as I said before you should be using a control repo with r10k.</p>

<p>If you’d like to see the simple module I made for this post, you can <a href="https://github.com/grahamgilbert/puppet-desktop_picture">find it up on Github</a>.</p>

</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//grahamgilbert.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2016/12/06/sal-3-0/">
            Sal 3.0
            <small>06 Dec 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/11/04/macad-uk-2017/">
            MacAD.UK 2017
            <small>04 Nov 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/10/06/0-to-imagr-ing-in-45-minutes/">
            0 to Imagr-ing in 45 minutes
            <small>06 Oct 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27233739-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
