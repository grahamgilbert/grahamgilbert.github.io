<!DOCTYPE html>
<html lang="en-us">

  <head>
  <script type="text/javascript">
    var host = "grahamgilbert.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Enable SIP with Munki &middot; graham gilbert
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <!--link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico"-->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
  <link href='/stylesheets/all-b18cc7d6d5710987503b687ec013f838.css' media='all' rel='stylesheet' type='text/css'>
  <link type="application/atom+xml" rel="alternate" href="https://grahamgilbert.com//atom.xml" title="graham gilbert" />
  <style>
  .clear{
    clear:both
  }
  .float-left {
    float:left;
    padding-right:25px;
    padding-bottom:25px;
  }

  .float-right {
    float:right;
    padding-left:25px;
    padding-bottom:25px;
  }
  </style>
</head>

  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          graham gilbert
        </a>
      </h1>
      <p class="lead">A Mac admin, automating the hell out of things.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/talks/">Talks</a>
          
        
      
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
      </nav>
      <p>

      <a href="https://twitter.com/grahamgilbert"><img style="display:inline;" src="/images/social/twitter.png" /></a> <a href="https://github.com/grahamgilbert"><img style="display:inline;" src="/images/social/github.png" /></a> <a href="https://www.linkedin.com/in/grahamgilbert"><img style="display:inline;" src="/images/social/linkedin.png" /></a>
      </p>

    <p>
      <small>The opinions on this site are my own, and are not necessarily shared by my employer.</small>
    </p>

  </div>
</div>

    <div class="content container">
      <div class="post">
  <h1 class="post-title">Enable SIP with Munki</h1>
  <span class="post-date">15 Dec 2016</span>
  <p>When 10.12.2 hit this week, it introduced an awesome new feature - the <a href="https://onemoreadmin.wordpress.com/2016/12/13/system-integrity-protection-sip-changes-in-macos-sierra-10-12-2/">ability to enable SIP</a> without having to be booted into a Recovery like environment (either Recovery HD or a NetInstall). Unfortunately it merely enables SIP on the next reboot.</p>

<p>Fortunately, Munki is pretty good at telling users when they need to reboot, so I wrote the following pkgsinfo file that will check if SIP is enabled, and if it isn’t, will enable it and reboot (fortunately it’s quite a bit easier to do this that it is with <a href="https://babodee.wordpress.com/2016/12/15/ensuring-sip-is-enabled/">other tools</a>. I’ve targeted this update at 10.12.0, because, well, if they’re not updating, I’d like them to. And it’s called ‘Critical Security Update’ so they may actually install it. If you really want them to install it, you can set a <code>force_install_after_date</code> and set it to the past, which will give your users a hour to install it before their machine goes byebye. <!-- more -->Without further ado, here it is:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>RestartAction<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>RequireRestart<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>_metadata<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;key&gt;</span>created_by<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>graham_gilbert<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;key&gt;</span>creation_date<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;date&gt;</span>2016-12-15T20:11:12Z<span class="nt">&lt;/date&gt;</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;key&gt;</span>munki_version<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>2.8.2.2855<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;key&gt;</span>os_version<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>10.12.2<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>autoremove<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;false/&gt;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>catalogs<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;array&gt;</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>production<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;/array&gt;</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>category<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>Security<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>description<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>Resolves critical security issues.<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>developer<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>Apple<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>display_name<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>Critical Security Update<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>installcheck_script<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>#!/usr/bin/python
</div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">import subprocess
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line">import sys
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line">def main():
</div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line">    sip_status = subprocess.check_output([&#39;/usr/bin/csrutil&#39;, &#39;status&#39;])
</div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line">    if &#39;disabled&#39; in sip_status:
</div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line">        sys.exit(0)
</div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line">    else:
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line">        sys.exit(1)
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="45" class="code-highlight-row numbered"><div class="code-highlight-line">if __name__ == &#39;__main__&#39;:
</div></div><div data-line="46" class="code-highlight-row numbered"><div class="code-highlight-line">    main()<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="47" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>installer_type<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="48" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>nopkg<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="49" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>minimum_os_version<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="50" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>10.12.0<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="51" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>name<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="52" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>enable_sip<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="53" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>postinstall_script<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="54" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>#!/bin/bash
</div></div><div data-line="55" class="code-highlight-row numbered"><div class="code-highlight-line">/usr/bin/csrutil clear
</div></div><div data-line="56" class="code-highlight-row numbered"><div class="code-highlight-line">exit 0<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="57" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>version<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="58" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>1.0<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="59" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="60" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/plist&gt;</span></div></div></pre></div></figure>

<p>If you have machines that are below 10.12 (and considering the <a href="http://blog.frizk.net/2016/12/filevault-password-retrieval.html">security issues</a>, you should consider making 10.12 a managed install), you will probably want to add it to a manifest like so:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;key&gt;</span>conditional_items<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;array&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;key&gt;</span>condition<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>os_vers_minor <span class="ni">&amp;gt;</span>= 12<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;key&gt;</span>managed_installs<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;array&gt;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="nt">&lt;string&gt;</span>enable_sip<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;/array&gt;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/array&gt;</span></div></div></pre></div></figure>

</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//grahamgilbert.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2017/02/08/something-something-commercial-something-something-opensource/">
            Something something commercial, something something opensource
            <small>08 Feb 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2017/01/19/pocket-mac-admins-guide-to-london/">
            Pocket Mac admin's guide to London
            <small>19 Jan 2017</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2017/01/11/imagr-with-target-disk-mode/">
            Imagr with target disk mode
            <small>11 Jan 2017</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27233739-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
