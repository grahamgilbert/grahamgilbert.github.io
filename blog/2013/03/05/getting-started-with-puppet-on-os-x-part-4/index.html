<!DOCTYPE html>
<html lang="en-us">

  <head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Getting Started With Puppet on OS X (Part 4) &middot; graham gilbert dot com
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/lanyon.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700%7CPT+Sans:400">

  <!-- Icons -->
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-precomposed.png">
  <link rel="shortcut icon" href="/public/favicon.ico">

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/atom.xml">
</head>

  <body class="theme-base-0d">

    <!-- Target for toggling the sidebar `.sidebar-checkbox` is for regular
     styles, `#sidebar-checkbox` for behavior. -->
<input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox">

<!-- Toggleable sidebar -->
<div class="sidebar" id="sidebar">
  <div class="sidebar-item">
    <p>A Mac admin, automating the hell out of things in London.<br /><br />The opinions on this site are my own, and are not necessarily shared by my employer.</p>
  </div>

  <nav class="sidebar-nav">
    <a class="sidebar-nav-item" href="/">Home</a>

    

    
    
    
      
        
      
    
    
      
        
          <a class="sidebar-nav-item" href="/about/">About</a>
        
      
    
    
      
    
    
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
      
    
    
      
        
          <a class="sidebar-nav-item" href="/talks/">Talks</a>
        
      
    

    <a class="sidebar-nav-item" href="https://twitter.com/grahamgilbert">Twitter</a>
    <a class="sidebar-nav-item" href="https://github.com/grahamgilbert">Github</a>

  </nav>

  <div class="sidebar-item">
    <p>
      &copy; 2016. All rights reserved.
    </p>
  </div>
</div>

    <!-- Wrap is the content to shift when toggling the sidebar. We wrap the
         content to avoid any CSS collisions with our real content. -->
    <div class="wrap">
      <div class="masthead">
        <div class="container">
          <h3 class="masthead-title">
            <a href="/" title="Home">graham gilbert dot com</a>
            <small>Mac administration and assorted nerdity</small>
          </h3>
        </div>
      </div>

      <div class="container content">
        <div class="post">
    <h1 class="post-title">
      <a href="http://grahamgilbert.com/blog/2013/03/05/getting-started-with-puppet-on-os-x-part-4/">
        Getting Started With Puppet on OS X (Part 4)
      </a>
    </h1>
  <span class="post-date">05 Mar 2013</span>
  <p>We’ve made quite a bit of progress with our Puppet install. We’ve already made Puppet do something useful with setting up an admin user, but let’s get back to being lazy - let’s get someone else to write the code.</p>

<p>Before reading this post, you really need to read <a href="http://grahamgilbert.com/blog/2013/01/25/getting-started-with-puppet-part-1/">part 1</a>, <a href="http://grahamgilbert.com/blog/2013/01/27/getting-started-with-puppet-on-os-x-part-2/">part 2</a> and <a href="http://grahamgilbert.com/blog/2013/02/24/getting-started-with-puppet-on-os-x-part-3/">part 3</a> of the series.</p>

<p>Modules are little pre-built bits of Puppet code. They’re a good example of Puppet’s philosophy of convention over configuration - Puppet will assume your modules follow a set pattern. We’ll be using two of the available folders in modules today: files and manifests. Files are static files that Puppet will copy over to our client machine, and manifests will contain the Puppet code we’ve previously been putting into <code>/etc/puppet/manifests/site.pp</code> - whilst it’s been easy to put code into this file, it can become unwieldy when you have a few nodes to manage.</p>

<p>There are also loads of pre-built modules on the <a href="http://forge.puppetlabs.com/">Puppet Forge</a> - it’s one of these modules we’ll be using today.<!-- more --></p>

<p>Assuming you’re still using the Vagrant-based Puppet Master from <a href="http://grahamgilbert.com/blog/2013/02/24/getting-started-with-puppet-on-os-x-part-3/">part 3</a>, cd into the directory you’ve cloned the repository to, issue a <code>vagrant up</code> command. Once you’ve booted the VM, we need to SSH into it.</p>

<pre><code>vagrant ssh
</code></pre>

<p>Puppet provides a handy tool to manage modules - <code>puppet module</code>. To install the <a href="http://forge.puppetlabs.com/rcoleman/mac_profiles_handler">mac_profiles_handler by Ryan Coleman</a>, tap in:</p>

<pre><code>sudo puppet module install rcoleman/mac_profiles_handler
</code></pre>

<p>Pretty straightforward syntax there - the person who wrote the module comes before the slash, and the name of the module after it. You’ll see some bumph about Puppet downloading the module, and if the author has specified any dependency on other modules, they’ll be downloaded as well.</p>

<p>If you switch back to your Mac and look in the folder you cloned the vagrant-puppetmaster git repository into (mine is at <code>~/src/Mine/blog-post</code>), you’ll see the module you just installed in the <code>puppet/modules</code> directory.</p>

<p><img src="/images/posts/2013-03-05/mac_profiles_handler.png" /></p>

<p>Feel free to have a nose around to get the general structure for what a Puppet module can look like. It’s ok, I’ll wait.</p>

<p>Time for us to make our own module. In <code>puppet/modules</code> create a folder called <code>my_super_module</code>. Within that, make <code>files</code> and <code>manifests</code> directories.</p>

<p><img src="/images/posts/2013-03-05/my_super_module.png" /></p>

<p>Next, grab <a href="/images/posts/2013-03-05/com.grahamgilbert.vpn.mobileconfig">this simple configuration profile</a> I made. It configures a VPN connection - it’s unsigned, so you can see what you’re installing on your test Mac if you’d like. Place this .mobileconfig file in <code>puppet/modules/my_super_module/files</code>. Or, if you’d rather, you can make your own for something else - configuring WiFi is pretty handy - I made this one in two minutes using <a href="http://support.apple.com/kb/dl1465">iPhone Configuration Utility</a>, but you can also make them with Profile Manager (I would recommend making them unsigned though, but that’s outside the scope of this article).</p>

<p>For the actual meat of our module, we need some Puppet code. In your favourite text editor (please remember, not TextEdit!), create <code>puppet/modules/my_super_module/init.pp</code>, and make it look like the following:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">puppet/modules/my_super_module/init.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">class</span> <span class="n">my_super_module</span> <span class="p">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">mac_profiles_handler</span><span class="o">::</span><span class="n">manage</span> <span class="p">&#x7b;</span> <span class="s1">&#39;com.grahamgilbert.vpn&#39;</span><span class="p">:</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="k">ensure</span>       <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="n">file_source</span>  <span class="o">=&gt;</span> <span class="s1">&#39;puppet:///modules/my_super_module/com.grahamgilbert.vpn.mobileconfig&#39;</span><span class="p">,</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">&#x7d;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>There are a few bits we’ve not seen before here:</p>

<pre><code>ensure =&gt; present,
</code></pre>

<p>We’re simply telling puppet that we want to make sure this profile is always installed. If it’s missing, re-install it. If we set this to <code>ensure =&gt; absent</code>, we’d be telling Puppet to remove the profile. If we wanted to simply update the profile, we’d just replace the mobileconfig file (this module will be aware of the change and update the installed profile).</p>

<pre><code>file_source  =&gt; 'puppet:///modules/my_super_module/com.grahamgilbert.vpn.mobileconfig',
</code></pre>

<p>This is referring to the file in our module. The important bit is <code>puppet:///</code> with three slashes. That point to the server we’re currently running on (and also makes our module portable to other servers). We don’t need to do any other configuration to get Puppet serving this file now, as it expects to serve static files out of the <code>files</code> directory.</p>

<p>As we are using the built in web server for our Puppet Master, we need to restart the puppetmaster service to let it know about our new module. When you’re on the Mac side, it’s easiest just to reload the whole server:</p>

<pre><code>cd ~/src/wherever/your/code/is
vagrant reload
</code></pre>

<p>Time to test it. Fire up your test Mac or your VM (if you need to configure it, please look at the <a href="http://grahamgilbert.com/blog/2013/02/24/getting-started-with-puppet-on-os-x-part-3/">last post</a>, I’m assuming it’s still set up), and perform a Puppet run:</p>

<pre><code>sudo puppet agent --test
</code></pre>

<p>Wait! Nothing happened. That’s because we’ve not told the Puppet Master to apply this particular module to our client Mac.</p>

<p>Make your <code>puppet/manifests/site.pp</code> look like this:</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">puppet/manifests/site.pp</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">node</span> <span class="n">puppetclient</span> <span class="p">&#x7b;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="kp">include</span> <span class="n">my_super_module</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">&#x7d;</span></div></div></pre></div></figure>

<p>All we’re doing here is telling Puppet to include our module with the default settings (as we didn’t make any settings that can be changed - once again, outside the scope of this post). Splitting your code into modules not only allows you to share them with others if you wish, but also means you only need to change your code once and have it affect all of your applicable nodes.</p>

<p>Anyway, save your <code>site.pp</code> and perform another run on your client:</p>

<pre><code>sudo puppet agent --test
</code></pre>

<p>And now you’ll see something along the lines of:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">Info: Retrieving plugin
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /File[/var/lib/puppet/lib/puppet]/ensure: created
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /File[/var/lib/puppet/lib/puppet/provider]/ensure: created
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /File[/var/lib/puppet/lib/puppet/provider/profile_manager]/ensure: created
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /File[/var/lib/puppet/lib/puppet/provider/profile_manager/osx.rb]/ensure: defined content as '&#x7b;md5&#x7d;48a098b58bf3fdf38f32a0261026fa59'
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /File[/var/lib/puppet/lib/puppet/type]/ensure: created
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /File[/var/lib/puppet/lib/puppet/type/profile_manager.rb]/ensure: defined content as '&#x7b;md5&#x7d;578a75ebe7f9972c7f49f8c5d4e1ad43'
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /File[/var/lib/puppet/lib/facter]/ensure: created
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /File[/var/lib/puppet/lib/facter/profiles.rb]/ensure: defined content as '&#x7b;md5&#x7d;54c12303c601579fb2282304363c8425'
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">Info: Loading facts in /var/lib/puppet/lib/facter/profiles.rb
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">Info: Caching catalog for puppetclient
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">Info: Applying configuration version '1362471535'
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /Stage[main]/My_super_module/Mac_profiles_handler::Manage[com.grahamgilbert.vpn]/File[/var/lib/puppet/mobileconfigs]/ensure: created
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /Stage[main]/My_super_module/Mac_profiles_handler::Manage[com.grahamgilbert.vpn]/File[/var/lib/puppet/mobileconfigs/com.grahamgilbert.vpn]/ensure: defined content as '&#x7b;md5&#x7d;48232db3a25fd851d1b1c7ec7c9557c8'
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">Info: /Stage[main]/My_super_module/Mac_profiles_handler::Manage[com.grahamgilbert.vpn]/File[/var/lib/puppet/mobileconfigs/com.grahamgilbert.vpn]: Scheduling refresh of Exec[remove-profile-com.grahamgilbert.vpn]
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /Stage[main]/My_super_module/Mac_profiles_handler::Manage[com.grahamgilbert.vpn]/Exec[remove-profile-com.grahamgilbert.vpn]: Triggered 'refresh' from 1 events
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: /Stage[main]/My_super_module/Mac_profiles_handler::Manage[com.grahamgilbert.vpn]/Profile_manager[com.grahamgilbert.vpn]/ensure: created
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">Info: Creating state file /var/lib/puppet/state/state.yaml
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">Notice: Finished catalog run in 1.57 seconds</div></div></pre></div></figure>

<p>And if you look in System Preferences, you’ll see the Profiles icon has appeared, and that your profile has been installed.</p>

<p><img src="/images/posts/2013-03-05/profiles.png" /></p>

<p>And in the Network pane, your VPN connection has been configured:</p>

<p><img src="/images/posts/2013-03-05/vpn.png" /></p>

<p>Next time, we’ll look at using Facter to make our code a little more intelligent. As ever, comments, corrections and general abuse is welcome.</p>

<p>(Not the abuse, that’s not nice.)</p>

  <div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//grahamgilbert.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</div>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2016/02/10/macad-uk-2016-puppet-on-os-x/">
            MacAD.UK 2016&#58; Puppet on OS X
            <small>10 Feb 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/01/20/dynamic-first-boot-scripts-with-imagr-and-flask-part-4/">
            Dynamic first boot scripts with Imagr and Flask&#58; Part 4
            <small>20 Jan 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/01/14/imagr-1-0-0-released/">
            Imagr 1.0.0 Released
            <small>14 Jan 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

      </div>
    </div>

    <label for="sidebar-checkbox" class="sidebar-toggle"></label>

    <script>
      (function(document) {
        var toggle = document.querySelector('.sidebar-toggle');
        var sidebar = document.querySelector('#sidebar');
        var checkbox = document.querySelector('#sidebar-checkbox');

        document.addEventListener('click', function(e) {
          var target = e.target;

          if(!checkbox.checked ||
             sidebar.contains(target) ||
             (target === checkbox || target === toggle)) return;

          checkbox.checked = false;
        }, false);
      })(document);
    </script>
  </body>
</html>
