<!DOCTYPE html>
<html lang="en-us">

  <head>
  <script type="text/javascript">
    var host = "grahamgilbert.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Managing the Authorization Database with Munki &middot; graham gilbert
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <!--link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico"-->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
  <link href='/stylesheets/all-c8369cf731585eb98eef0098877bca87.css' media='all' rel='stylesheet' type='text/css'>
  <link type="application/atom+xml" rel="alternate" href="https://grahamgilbert.com/atom.xml" title="graham gilbert" />
  <style>
  .clear{
    clear:both
  }
  .float-left {
    float:left;
    padding-right:25px;
    padding-bottom:25px;
  }

  .float-right {
    float:right;
    padding-left:25px;
    padding-bottom:25px;
  }
  </style>
</head>

  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          graham gilbert
        </a>
      </h1>
      <p class="lead">A Mac admin, automating the hell out of things.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/talks/">Talks</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
      </nav>
      <p>

      <a href="https://twitter.com/grahamgilbert"><img style="display:inline;" src="/images/social/twitter.png" /></a> <a href="https://github.com/grahamgilbert"><img style="display:inline;" src="/images/social/github.png" /></a> <a href="https://www.linkedin.com/in/grahamgilbert"><img style="display:inline;" src="/images/social/linkedin.png" /></a>
      </p>

    <p>
      <small>The opinions on this site are my own, and are not necessarily shared by my employer.</small>
    </p>

  </div>
</div>

    <div class="content container">
      <div class="post">
  <h1 class="post-title">Managing the Authorization Database with Munki</h1>
  <span class="post-date">22 Dec 2013</span>
  <p>Have you ever wished you didn’t have to take calls from your users to unlock various parts of System Preferences? That standard users could unlock Energy Saver or Date and Time preferences? Well dear reader, this is the article for you.</p>

<p>If, for some strange reason you can’t be bothered to read this overly long article (I do love to procrastinate), you can head over to my <a href="https://github.com/grahamgilbert/macscripts/tree/master/Munki">macscripts repo on GitHub</a> for the scripts and resulting pkginfo files I’ve made for this.</p>

<p>Before we start, let’s get one thing out of the way - Munki isn’t at heart a configuration management system. I’ve traditionally preferred Puppet for these tasks, but as there is at the time of writing a <a href="https://projects.puppetlabs.com/issues/22830">bug open</a> on modifying this with Puppet, I took it upon myself to make this work in my environment. I spent a couple of days trying to get my sub-par Ruby skills to match my aspirations, so I moved onto a much more comfortable technology for me: Python and Munki.</p>

<p>To tackle this issue, I’m going to be using the same Philosophy as Puppet:</p>

<ul>
  <li>Check if the resource exists and what it’s current value is</li>
  <li>If required, change the value</li>
  <li>And be able to revert back to how things were</li>
</ul>

<p>These translate quite nicely into <code>installcheck_script</code>, <code>postinstall_script</code> and <code>uninstall_script</code> rolled into a <code>nopkg</code> pkginfo (for a good intro into how nopkg pkginfos work, see how to manage printers with them over on the <a href="https://code.google.com/p/munki/wiki/ManagingPrintersWithMunki">Munki wiki</a>). We could do this with a payload free package and an installcheck_script just as easily, but as we’re already putting code into our pkginfo, we might as well keep it all in one place.</p>

<p>This isn’t intended to be a tutorial on the theory of OS X’s authorization database - there are already <a href="http://mattsmacblog.wordpress.com/2012/01/05/making-use-of-the-etcauthorization-file-in-lion-10-7-x/">excellent resources available</a>.</p>

<h2 id="installcheckscript">installcheck_script</h2>

<p>Our <code>installcheck_script</code> is going to be very basic. To first open up the root <code>system.preferences</code> right, we just need to make sure that the group is set to <code>everyone</code> rather than <code>admin</code>. If you want to use another group, just substitute it in the <code>group</code> variable in the installcheck_script and the postinstall_script.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">installcheck.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#!/usr/bin/env python</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">subprocess</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">sys</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">plistlib</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># Group System Preferences should be opened to</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">group</span> <span class="o">=</span> <span class="s">&#39;everyone&#39;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/security&#39;</span><span class="p">,</span> <span class="s">&#39;authorizationdb&#39;</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="s">&#39;system.preferences&#39;</span><span class="p">]</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">task</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">formatted</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlistFromString</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># if group matches, exit 1 as we don&#39;t need to install</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="n">formatted</span><span class="p">[</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">group</span><span class="p">:</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">else</span><span class="p">:</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># if it doesn&#39;t we&#39;re exiting with 0 as we need to perform the install</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></div></div></pre></div></figure>

<h2 id="postinstallscript">postinstall_script</h2>

<p>The <code>postinstall_script</code> is just an extension of the <code>installcheck_script</code> - but we’re going to make use of Python’s built-in <code>plistlib</code> to modify the plist and feed it back into <code>security authorizationdb</code> to set our desired settings.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">postinstall.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#!/usr/bin/env python</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">subprocess</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">sys</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">plistlib</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># Group System Preferences should be opened to</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">group</span> <span class="o">=</span> <span class="s">&#39;everyone&#39;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/security&#39;</span><span class="p">,</span> <span class="s">&#39;authorizationdb&#39;</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="s">&#39;system.preferences&#39;</span><span class="p">]</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">task</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">formatted</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlistFromString</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># If the group doesn&#39;t match, we&#39;re going to correct it.</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="n">formatted</span><span class="p">[</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">group</span><span class="p">:</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c">#input_plist = &#x7b;&#x7d;</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">formatted</span><span class="p">[</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># Convert back to plist</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">input_plist</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">writePlistToString</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># Write the plist back to the authorizationdb</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/security&#39;</span><span class="p">,</span> <span class="s">&#39;authorizationdb&#39;</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">,</span> <span class="s">&#39;system.preferences&#39;</span><span class="p">]</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">task</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_plist</span><span class="p">)</span></div></div></pre></div></figure>

<h2 id="uninstallscript">uninstall_script</h2>

<p>We should be good admins and clean up after ourselves, so we’ll include an uninstall script.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">uninstall.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#!/usr/bin/env python</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">subprocess</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">sys</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">plistlib</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># Set the group back to admin</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">group</span> <span class="o">=</span> <span class="s">&#39;admin&#39;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/security&#39;</span><span class="p">,</span> <span class="s">&#39;authorizationdb&#39;</span><span class="p">,</span> <span class="s">&#39;read&#39;</span><span class="p">,</span> <span class="s">&#39;system.preferences&#39;</span><span class="p">]</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">task</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">formatted</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">readPlistFromString</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c"># If the group doesn&#39;t match, we&#39;re going to correct it.</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="n">formatted</span><span class="p">[</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">group</span><span class="p">:</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">formatted</span><span class="p">[</span><span class="s">&#39;group&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># Convert back to plist</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">input_plist</span> <span class="o">=</span> <span class="n">plistlib</span><span class="o">.</span><span class="n">writePlistToString</span><span class="p">(</span><span class="n">formatted</span><span class="p">)</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="c"># Write the plist back to the authorizationdb</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/security&#39;</span><span class="p">,</span> <span class="s">&#39;authorizationdb&#39;</span><span class="p">,</span> <span class="s">&#39;write&#39;</span><span class="p">,</span> <span class="s">&#39;system.preferences&#39;</span><span class="p">]</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">task</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">input_plist</span><span class="p">)</span></div></div></pre></div></figure>

<h2 id="getting-it-into-munki">Getting it into Munki</h2>

<p>Now we’ve got our three scripts, we need to get them together into a pkginfo file. Assuming the scripts you’ve just made live in <code>~/src/macscripts/Munki/Auth</code>:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">$ cd ~/src/macscripts/Munki/Auth
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">$ /usr/local/munki/makepkginfo --installcheck_script=installcheck.py --postinstall_script=postinstall.py --uninstall_script=uninstall.py &gt; OpenSysPrefs-1.0.plist</div></div></pre></div></figure>

<p>Which will produce the bare bones of a pkginfo file, but there are a few other things we need to add into it. Modify OpenSysPref-1.0.plist to look like the below. For further documentation on what we’re doing here, have a look at the <a href="https://code.google.com/p/munki/wiki/PkginfoFiles">Munki wiki</a>. The important parts you’ll need to add / modify are:</p>

<ul>
  <li>autoremove</li>
  <li>catalog</li>
  <li>description</li>
  <li>display_name</li>
  <li>name</li>
  <li>installer_type</li>
  <li>minimum_os_version</li>
  <li>version</li>
  <li>unattended_install (if you want it to apply in the background)</li>
  <li>uninstall_method</li>
  <li>uninstallable</li>
</ul>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="cp">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;plist</span> <span class="na">version=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>autoremove<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;false/&gt;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>catalogs<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;array&gt;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="nt">&lt;string&gt;</span>production<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;/array&gt;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>description<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>Opens System Preferences to Everyone<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>display_name<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>Open System Preferences<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>name<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>OpenSysPrefs<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>installer_type<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>nopkg<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>minimum_os_version<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>10.8.0<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>unattended_install<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;true/&gt;</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>version<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>1.0<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>installcheck_script<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>#!/usr/bin/env python
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">import subprocess
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">import sys
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">import plistlib
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line"># Group System Preferences should be opened to
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line">group = &#39;everyone&#39;
</div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">command = [&#39;/usr/bin/security&#39;, &#39;authorizationdb&#39;, &#39;read&#39;, &#39;system.preferences&#39;]
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line">task = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
</div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line">(out, err) = task.communicate()
</div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line">formatted = plistlib.readPlistFromString(out)
</div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line"># if group matches, exit 1 as we don&#39;t need to install
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line">if formatted[&#39;group&#39;] == group:
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line">    sys.exit(1)
</div></div><div data-line="45" class="code-highlight-row numbered"><div class="code-highlight-line">else:
</div></div><div data-line="46" class="code-highlight-row numbered"><div class="code-highlight-line">    # if it doesn&#39;t we&#39;re exiting with 0 as we need to perform the install
</div></div><div data-line="47" class="code-highlight-row numbered"><div class="code-highlight-line">    sys.exit(0)<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="48" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>postinstall_script<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="49" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>#!/usr/bin/env python
</div></div><div data-line="50" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="51" class="code-highlight-row numbered"><div class="code-highlight-line">import subprocess
</div></div><div data-line="52" class="code-highlight-row numbered"><div class="code-highlight-line">import sys
</div></div><div data-line="53" class="code-highlight-row numbered"><div class="code-highlight-line">import plistlib
</div></div><div data-line="54" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="55" class="code-highlight-row numbered"><div class="code-highlight-line"># Group System Preferences should be opened to
</div></div><div data-line="56" class="code-highlight-row numbered"><div class="code-highlight-line">group = &#39;everyone&#39;
</div></div><div data-line="57" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="58" class="code-highlight-row numbered"><div class="code-highlight-line">command = [&#39;/usr/bin/security&#39;, &#39;authorizationdb&#39;, &#39;read&#39;, &#39;system.preferences&#39;]
</div></div><div data-line="59" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="60" class="code-highlight-row numbered"><div class="code-highlight-line">task = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
</div></div><div data-line="61" class="code-highlight-row numbered"><div class="code-highlight-line">(out, err) = task.communicate()
</div></div><div data-line="62" class="code-highlight-row numbered"><div class="code-highlight-line">formatted = plistlib.readPlistFromString(out)
</div></div><div data-line="63" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="64" class="code-highlight-row numbered"><div class="code-highlight-line"># If the group doesn&#39;t match, we&#39;re going to correct it.
</div></div><div data-line="65" class="code-highlight-row numbered"><div class="code-highlight-line">if formatted[&#39;group&#39;] != group:
</div></div><div data-line="66" class="code-highlight-row numbered"><div class="code-highlight-line">    #input_plist = &#x7b;&#x7d;
</div></div><div data-line="67" class="code-highlight-row numbered"><div class="code-highlight-line">    formatted[&#39;group&#39;] = group
</div></div><div data-line="68" class="code-highlight-row numbered"><div class="code-highlight-line">    # Convert back to plist
</div></div><div data-line="69" class="code-highlight-row numbered"><div class="code-highlight-line">    input_plist = plistlib.writePlistToString(formatted)
</div></div><div data-line="70" class="code-highlight-row numbered"><div class="code-highlight-line">    # Write the plist back to the authorizationdb
</div></div><div data-line="71" class="code-highlight-row numbered"><div class="code-highlight-line">    command = [&#39;/usr/bin/security&#39;, &#39;authorizationdb&#39;, &#39;write&#39;, &#39;system.preferences&#39;]
</div></div><div data-line="72" class="code-highlight-row numbered"><div class="code-highlight-line">    task = subprocess.Popen(command, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
</div></div><div data-line="73" class="code-highlight-row numbered"><div class="code-highlight-line">    (out, err) = task.communicate(input=input_plist)<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="74" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="75" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>uninstall_method<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="76" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>uninstall_script<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="77" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>uninstallable<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="78" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;true/&gt;</span>
</div></div><div data-line="79" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;key&gt;</span>uninstall_script<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="80" class="code-highlight-row numbered"><div class="code-highlight-line">	<span class="nt">&lt;string&gt;</span>#!/usr/bin/env python
</div></div><div data-line="81" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="82" class="code-highlight-row numbered"><div class="code-highlight-line">import subprocess
</div></div><div data-line="83" class="code-highlight-row numbered"><div class="code-highlight-line">import sys
</div></div><div data-line="84" class="code-highlight-row numbered"><div class="code-highlight-line">import plistlib
</div></div><div data-line="85" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="86" class="code-highlight-row numbered"><div class="code-highlight-line"># Set the group back to admin
</div></div><div data-line="87" class="code-highlight-row numbered"><div class="code-highlight-line">group = &#39;admin&#39;
</div></div><div data-line="88" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="89" class="code-highlight-row numbered"><div class="code-highlight-line">command = [&#39;/usr/bin/security&#39;, &#39;authorizationdb&#39;, &#39;read&#39;, &#39;system.preferences&#39;]
</div></div><div data-line="90" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="91" class="code-highlight-row numbered"><div class="code-highlight-line">task = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
</div></div><div data-line="92" class="code-highlight-row numbered"><div class="code-highlight-line">(out, err) = task.communicate()
</div></div><div data-line="93" class="code-highlight-row numbered"><div class="code-highlight-line">formatted = plistlib.readPlistFromString(out)
</div></div><div data-line="94" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="95" class="code-highlight-row numbered"><div class="code-highlight-line"># If the group doesn&#39;t match, we&#39;re going to correct it.
</div></div><div data-line="96" class="code-highlight-row numbered"><div class="code-highlight-line">if formatted[&#39;group&#39;] != group:
</div></div><div data-line="97" class="code-highlight-row numbered"><div class="code-highlight-line">    formatted[&#39;group&#39;] = group
</div></div><div data-line="98" class="code-highlight-row numbered"><div class="code-highlight-line">    # Convert back to plist
</div></div><div data-line="99" class="code-highlight-row numbered"><div class="code-highlight-line">    input_plist = plistlib.writePlistToString(formatted)
</div></div><div data-line="100" class="code-highlight-row numbered"><div class="code-highlight-line">    # Write the plist back to the authorizationdb
</div></div><div data-line="101" class="code-highlight-row numbered"><div class="code-highlight-line">    command = [&#39;/usr/bin/security&#39;, &#39;authorizationdb&#39;, &#39;write&#39;, &#39;system.preferences&#39;]
</div></div><div data-line="102" class="code-highlight-row numbered"><div class="code-highlight-line">    task = subprocess.Popen(command, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
</div></div><div data-line="103" class="code-highlight-row numbered"><div class="code-highlight-line">    (out, err) = task.communicate(input=input_plist)<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="104" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="105" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/plist&gt;</span></div></div></pre></div></figure>

<p>At this point, you should be able to add this pkginfo to your Munki repository, include it in a manifest and - well, nothing will happen, as this only unlocks the top level of System Preferences. If you want to do more, you’ll need to unlock additional parts as well - the scripts to do this can be found in my <a href="https://github.com/grahamgilbert/macscripts/tree/master/Munki">macscripts repository</a>. I’ve specified that <code>OpenSysPrefs</code> is required in all of these - this means I can include only the needed modifications in the manifest and not worry about the top level being unlocked.</p>

<p>Also remember that Munki has conditional items built right in - you might only want to unlock the Network pane on laptops so they can install VPN profiles etc using something like this:</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;key&gt;</span>conditional_items<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;array&gt;</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="nt">&lt;dict&gt;</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>condition<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;string&gt;</span>machine_type == &quot;laptop&quot;<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;key&gt;</span>managed_installs<span class="nt">&lt;/key&gt;</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;array&gt;</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line">      <span class="nt">&lt;string&gt;</span>UnlockNetwork<span class="nt">&lt;/string&gt;</span>
</div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="nt">&lt;/array&gt;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line">  <span class="nt">&lt;/dict&gt;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nt">&lt;/array&gt;</span></div></div></pre></div></figure>

</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//grahamgilbert.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2016/12/06/sal-3-0/">
            Sal 3.0
            <small>06 Dec 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/11/04/macad-uk-2017/">
            MacAD.UK 2017
            <small>04 Nov 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/10/06/0-to-imagr-ing-in-45-minutes/">
            0 to Imagr-ing in 45 minutes
            <small>06 Oct 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27233739-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
