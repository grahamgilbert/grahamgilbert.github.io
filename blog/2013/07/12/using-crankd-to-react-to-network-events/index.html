<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Using crankd to react to network events &#8211; graham gilbert dot com</title>
<meta name="description" content="Updated 14/7/2013: After Alister’s suggestion, the script now loops over network interfaces up to en19 (hopefully that’s enough!).

So, you’ve heard of this crankd thing, maybe even had a look at it, but have no idea how to get it going? You’re in the right place. I’m by no means an expert on it, having only been playing with it for less than a week, but I already have it running in production running the simple script below. My initial work, and therefore this post was inspired by Gary Larizza’s two articles on the subject.

What is crankd?

It’s part of the PyMacAdmin set of tools that Chris Adams and Nigel Kersten released a while ago. In a nutshell, it runs in the background via a LaunchDaemon and reacts to events on the Mac by running a script or a Python function, class or method. It has loads of events it knows about (application launches, power events, network events etc), but in this case I wanted to run something when there was a network change. Some of our machines never get turned off (and for some reason the Puppet Launch Daemon has crapped out), or aren’t turned on long enough for Puppet or Munki to run. I wanted a script that would run every time the machine came back onto the network, checking if there was an active connection and run Puppet and Munki.

What do I need to do?

There are a few parts that we need to bring together to make this work:


  The crankd.py executable and the supporting files
  A Launch Daemon to start the thing
  A preferences file to tell crankd what to do
  And finally, our custom code


">
<meta name="keywords" content="">



<!-- Twitter Cards -->
<meta name="twitter:title" content="Using crankd to react to network events">
<meta name="twitter:description" content="Updated 14/7/2013: After Alister’s suggestion, the script now loops over network interfaces up to en19 (hopefully that’s enough!).

So, you’ve heard of this crankd thing, maybe even had a look at it, but have no idea how to get it going? You’re in the right place. I’m by no means an expert on it, having only been playing with it for less than a week, but I already have it running in production running the simple script below. My initial work, and therefore this post was inspired by Gary Larizza’s two articles on the subject.

What is crankd?

It’s part of the PyMacAdmin set of tools that Chris Adams and Nigel Kersten released a while ago. In a nutshell, it runs in the background via a LaunchDaemon and reacts to events on the Mac by running a script or a Python function, class or method. It has loads of events it knows about (application launches, power events, network events etc), but in this case I wanted to run something when there was a network change. Some of our machines never get turned off (and for some reason the Puppet Launch Daemon has crapped out), or aren’t turned on long enough for Puppet or Munki to run. I wanted a script that would run every time the machine came back onto the network, checking if there was an active connection and run Puppet and Munki.

What do I need to do?

There are a few parts that we need to bring together to make this work:


  The crankd.py executable and the supporting files
  A Launch Daemon to start the thing
  A preferences file to tell crankd what to do
  And finally, our custom code


">
<meta name="twitter:site" content="@grahamgilbert">
<meta name="twitter:creator" content="@grahamgilbert">

<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://grahamgilbert.com/images/default-thumb.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_GB">
<meta property="og:type" content="article">
<meta property="og:title" content="Using crankd to react to network events">
<meta property="og:description" content="Updated 14/7/2013: After Alister’s suggestion, the script now loops over network interfaces up to en19 (hopefully that’s enough!).

So, you’ve heard of this crankd thing, maybe even had a look at it, but have no idea how to get it going? You’re in the right place. I’m by no means an expert on it, having only been playing with it for less than a week, but I already have it running in production running the simple script below. My initial work, and therefore this post was inspired by Gary Larizza’s two articles on the subject.

What is crankd?

It’s part of the PyMacAdmin set of tools that Chris Adams and Nigel Kersten released a while ago. In a nutshell, it runs in the background via a LaunchDaemon and reacts to events on the Mac by running a script or a Python function, class or method. It has loads of events it knows about (application launches, power events, network events etc), but in this case I wanted to run something when there was a network change. Some of our machines never get turned off (and for some reason the Puppet Launch Daemon has crapped out), or aren’t turned on long enough for Puppet or Munki to run. I wanted a script that would run every time the machine came back onto the network, checking if there was an active connection and run Puppet and Munki.

What do I need to do?

There are a few parts that we need to bring together to make this work:


  The crankd.py executable and the supporting files
  A Launch Daemon to start the thing
  A preferences file to tell crankd what to do
  And finally, our custom code


">
<meta property="og:url" content="http://grahamgilbert.com/blog/2013/07/12/using-crankd-to-react-to-network-events/">
<meta property="og:site_name" content="graham gilbert dot com">

<meta property="og:image" content="http://grahamgilbert.com/images/default-thumb.png">





<link rel="canonical" href="http://grahamgilbert.com/blog/2013/07/12/using-crankd-to-react-to-network-events/">
<link href="http://grahamgilbert.com/atom.xml" type="application/atom+xml" rel="alternate" title="graham gilbert dot com Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="http://grahamgilbert.com/assets/css/main.css">

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
	<script src="http://grahamgilbert.com/assets/js/vendor/html5shiv.min.js"></script>
	<script src="http://grahamgilbert.com/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="http://grahamgilbert.com/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>

<link href='//fonts.googleapis.com/css?family=PT+Sans+Narrow:400,700%7CPT+Serif:400,700,400italic' rel='stylesheet' type='text/css'>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="http://grahamgilbert.com/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="http://grahamgilbert.com/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="http://grahamgilbert.com/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="http://grahamgilbert.com/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="http://grahamgilbert.com/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="http://grahamgilbert.com/images/apple-touch-icon-144x144-precomposed.png">
<link href='/stylesheets/all-476e6a9e20e90d95691860a993d65b96.css' media='all' rel='stylesheet' type='text/css'>
</head>

<body class="post">

<!--[if lt IE 9]><div class="browser-upgrade alert alert-info">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</div><![endif]-->

<div class="navigation-wrapper">
	<div class="site-name">
		<a href="http://grahamgilbert.com/">graham gilbert dot com</a>
	</div><!-- /.site-name -->
	<div class="top-navigation">
		<nav role="navigation" id="site-nav" class="nav">
		    <ul>
		        
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/about/" >About</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/talks/" >Talks</a></li>
				
				    
				        
				        
				    <li><a href="http://twitter.com/grahamgilbert" target="_blank">Twitter</a></li>
				
				    
				        
				    
				    <li><a href="http://grahamgilbert.com/posts/" >Archives</a></li>
				
		    </ul>
		</nav>
	</div><!-- /.top-navigation -->
</div><!-- /.navigation-wrapper -->



<div id="main" role="main">
  <div class="article-author-side">
    <div itemscope itemtype="http://schema.org/Person">


	<img src="http://grahamgilbert.com/images/about.jpg" class="bio-photo" alt="Graham Gilbert bio photo">


  <h3 itemprop="name">Graham Gilbert</h3>
  <p>A Mac admin, automating the hell out of things in London.<br /><br />The opinions on this site are my own, and are not necessarily shared by my employer.</p>
  <a href="http://twitter.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-twitter-square"></i> Twitter</a>
  
  
  <a href="http://linkedin.com/in/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-linkedin-square"></i> LinkedIn</a>
  
  
  
  <a href="http://github.com/grahamgilbert" class="author-social" target="_blank"><i class="fa fa-fw fa-github"></i> Github</a>
  
  
  
  
  
  
  
  
  
  
  
</div>
  </div>
  <article class="post">
    <div class="headline-wrap">
      
        <h1><a href="http://grahamgilbert.com/blog/2013/07/12/using-crankd-to-react-to-network-events/" rel="bookmark" title="Using crankd to react to network events">Using crankd to react to network events</a></h1>
      
    </div><!--/ .headline-wrap -->
    <div class="article-wrap">
      <p>Updated 14/7/2013: After <a href="https://twitter.com/Sacrilicious/status/355756510535614464">Alister’s suggestion</a>, the script now loops over network interfaces up to en19 (hopefully that’s enough!).</p>

<p>So, you’ve heard of this crankd thing, maybe even had a look at it, but have no idea how to get it going? You’re in the right place. I’m by no means an expert on it, having only been playing with it for less than a week, but I already have it running in production running the simple script below. My initial work, and therefore this post was inspired by Gary Larizza’s <a href="http://web.archive.org/web/20120111031339/http://glarizza.posterous.com/using-crankd-to-react-to-network-events">two</a> <a href="http://garylarizza.com/blog/2011/12/31/using-the-google-macops-crankd-and-facter-code/">articles</a> on the subject.</p>

<h2 id="what-is-crankd">What is crankd?</h2>

<p>It’s part of the <a href="https://github.com/acdha/pymacadmin">PyMacAdmin</a> set of tools that <a href="http://chris.improbable.org/">Chris Adams</a> and <a href="http://explanatorygap.net">Nigel Kersten</a> released a while ago. In a nutshell, it runs in the background via a LaunchDaemon and reacts to events on the Mac by running a script or a Python function, class or method. It has loads of events it knows about (application launches, power events, network events etc), but in this case I wanted to run something when there was a network change. Some of our machines never get turned off (and for some reason the Puppet Launch Daemon has crapped out), or aren’t turned on long enough for Puppet or Munki to run. I wanted a script that would run every time the machine came back onto the network, checking if there was an active connection and run Puppet and Munki.</p>

<h2 id="what-do-i-need-to-do">What do I need to do?</h2>

<p>There are a few parts that we need to bring together to make this work:</p>

<ul>
  <li>The crankd.py executable and the supporting files</li>
  <li>A Launch Daemon to start the thing</li>
  <li>A preferences file to tell crankd what to do</li>
  <li>And finally, our custom code</li>
</ul>

<!-- more -->

<h2 id="get-and-install-crankd">Get and install crankd</h2>

<p>First off, you need to grab the current code from GitHub.</p>

<p><code>
git clone https://github.com/acdha/pymacadmin.git
</code></p>

<p>Then <code>cd</code> into the pymacadmin directory you just cloned and run <code>install-crankd.sh</code>.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">cd</span> ~/src/pymacadmin
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">sudo ./install-crankd.sh</div></div></pre></div></figure>

<p>That will install the crankd.py executable and it’s supporting files, now for the Launch Daemon to make it start at boot. You’ll need to put the following into a file at <code>/Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.plist</code>.</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
	&lt;key&gt;KeepAlive&lt;/key&gt;
	&lt;true/&gt;
	&lt;key&gt;Label&lt;/key&gt;
	&lt;string&gt;com.googlecode.pymacadmin.crankd&lt;/string&gt;
	&lt;key&gt;ProgramArguments&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;/usr/local/sbin/crankd.py&lt;/string&gt;
	&lt;/array&gt;
	&lt;key&gt;RunAtLoad&lt;/key&gt;
	&lt;true/&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></pre>

<p>And set the right ownership and permissions on the plist</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">sudo chmod <span class="m">644</span> /Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.plist
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">sudo chown root:wheel /Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.plist</div></div></pre></div></figure>

<p>So that’s the basics. Now we need to tell crankd what events it should listen to and what it should do.</p>

<p>As we want to call the CrankTools class and the OnNetworkLoad method every time the network changes state, we need to do the following in <code>/Library/Preferences/com.googlecode.pymacadmin.crankd.plist</code>. To see what other events you can use with crankd, head on over to the <a href="https://github.com/acdha/pymacadmin/tree/master/examples/crankd/sample-of-events">GitHub repo</a>.</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
    &lt;dict&gt;
        &lt;key&gt;SystemConfiguration&lt;/key&gt;
        &lt;dict&gt;
            &lt;key&gt;State:/Network/Global/IPv4&lt;/key&gt;
            &lt;dict&gt;
                &lt;key&gt;method&lt;/key&gt;
                    &lt;array&gt;
                        &lt;string&gt;CrankTools&lt;/string&gt;
                        &lt;string&gt;OnNetworkLoad&lt;/string&gt;
                    &lt;/array&gt;
            &lt;/dict&gt;
        &lt;/dict&gt;
    &lt;/dict&gt;
&lt;/plist&gt;
</code></pre>

<p>Now for the actual Python code. This is very heavily inspired by <a href="http://garylarizza.com">Gary Larizza’s</a> work. We’re checking if either en0 or en1 has a valid network connection (as this event is for any network change - both connecting and disconnecting), and if there is a valid connection, run Puppet and then run Munki. This code could easily be modified to run anything you wanted to at the command line (for example a Casper policy). Put the following script in <code>/Library/Application Support/crankd/CrankTools.py</code>.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">CrankTools.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#!/usr/bin/env python</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#    CrankTools.py</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#        The OnNetworkLoad method is called from crankd on a network state change, all other</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#            methods assist it. Modified from Gary Larizza&#39;s script (https://gist.github.com/glarizza/626169).</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#    Last Revised - 10/07/2013</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Graham Gilbert (graham@grahamgilbert.com)&#39;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;0.6&#39;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">syslog</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">subprocess</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">syslog</span><span class="o">.</span><span class="n">openlog</span><span class="p">(</span><span class="s">&quot;CrankD&quot;</span><span class="p">)</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">class</span> <span class="nc">CrankTools</span><span class="p">():</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="sd">&quot;&quot;&quot;The main CrankTools class needed for our crankd config plist&quot;&quot;&quot;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">puppetRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;Checks for an active network connection and calls puppet if it finds one.</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            If the network is NOT active, it logs an error and exits</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments: None</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns:  Nothing</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/puppet&#39;</span><span class="p">,</span><span class="s">&#39;agent&#39;</span><span class="p">,</span><span class="s">&#39;-t&#39;</span><span class="p">]</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LinkState</span><span class="p">():</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="bp">self</span><span class="o">.</span><span class="n">callCmd</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">syslog</span><span class="o">.</span><span class="n">syslog</span><span class="p">(</span><span class="n">syslog</span><span class="o">.</span><span class="n">LOG_ALERT</span><span class="p">,</span> <span class="s">&quot;Internet Connection Not Found, Puppet Run Exiting...&quot;</span><span class="p">)</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">munkiRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;Checks for an active network connection and calls Munki if it finds one.</span>
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            If the network is NOT active, it logs an error and exits</span>
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments: None</span>
</div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns:  Nothing</span>
</div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/local/munki/managedsoftwareupdate&#39;</span><span class="p">,</span><span class="s">&#39;--auto&#39;</span><span class="p">]</span>
</div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LinkState</span><span class="p">():</span>
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="bp">self</span><span class="o">.</span><span class="n">callCmd</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="45" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">syslog</span><span class="o">.</span><span class="n">syslog</span><span class="p">(</span><span class="n">syslog</span><span class="o">.</span><span class="n">LOG_ALERT</span><span class="p">,</span> <span class="s">&quot;Internet Connection Not Found, Munki Run Exiting...&quot;</span><span class="p">)</span>
</div></div><div data-line="46" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="47" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">callCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
</div></div><div data-line="48" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;Simple utility function that calls a command via subprocess</span>
</div></div><div data-line="49" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="50" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments: command - A list of arguments for the command</span>
</div></div><div data-line="51" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns: Nothing</span>
</div></div><div data-line="52" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="53" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">task</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</div></div><div data-line="54" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</div></div><div data-line="55" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="56" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">LinkState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</div></div><div data-line="57" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;This utility returns the status of the passed interface.</span>
</div></div><div data-line="58" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="59" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments:</span>
</div></div><div data-line="60" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            None</span>
</div></div><div data-line="61" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns:</span>
</div></div><div data-line="62" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            status - The return code of the subprocess call</span>
</div></div><div data-line="63" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="64" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="65" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">theState</span> <span class="o">=</span> <span class="bp">False</span>
</div></div><div data-line="66" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="67" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
</div></div><div data-line="68" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">interface</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
</div></div><div data-line="69" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">adapter</span> <span class="o">=</span> <span class="s">&#39;en&#39;</span> <span class="o">+</span> <span class="n">interface</span>
</div></div><div data-line="70" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">print</span> <span class="s">&#39;checking adapter &#39;</span><span class="o">+</span><span class="n">adapter</span>
</div></div><div data-line="71" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">if</span> <span class="ow">not</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">&quot;ipconfig&quot;</span><span class="p">,</span> <span class="s">&quot;getifaddr&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="p">]):</span>
</div></div><div data-line="72" class="code-highlight-row numbered"><div class="code-highlight-line">                <span class="n">theState</span> <span class="o">=</span> <span class="bp">True</span>
</div></div><div data-line="73" class="code-highlight-row numbered"><div class="code-highlight-line">                <span class="k">break</span>
</div></div><div data-line="74" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="75" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">theState</span>
</div></div><div data-line="76" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="77" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">OnNetworkLoad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</div></div><div data-line="78" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;Called from crankd directly on a Network State Change. We sleep for 10 seconds to ensure that</span>
</div></div><div data-line="79" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            an IP address has been cleared or attained, and then perform a Puppet run and a Munki run.</span>
</div></div><div data-line="80" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="81" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments:</span>
</div></div><div data-line="82" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            *args and **kwargs - Catchall arguments coming from crankd</span>
</div></div><div data-line="83" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns:  Nothing</span>
</div></div><div data-line="84" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="85" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</div></div><div data-line="86" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="bp">self</span><span class="o">.</span><span class="n">puppetRun</span><span class="p">()</span>
</div></div><div data-line="87" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="bp">self</span><span class="o">.</span><span class="n">munkiRun</span><span class="p">()</span>
</div></div><div data-line="88" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="89" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</div></div><div data-line="90" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">crank</span> <span class="o">=</span> <span class="n">CrankTools</span><span class="p">()</span>
</div></div><div data-line="91" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">crank</span><span class="o">.</span><span class="n">OnNetworkLoad</span><span class="p">()</span>
</div></div><div data-line="92" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="93" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>  
</div></div><div data-line="94" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">main</span><span class="p">()</span></div></div></pre></div></figure>

<p>It’s ok, we’re nearly there! You just need to set the right owner on <code>CrankTools.py</code> , load the Launch Daemon and we can get testing.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">sudo chown root:wheel /Library/Application Support/crankd/CrankTools.py
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">sudo launchctl load /Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.plist`</div></div></pre></div></figure>

<p>You’re all set. Disconnect your network connection and re-connect. Put your Mac to sleep and wake it up. Each time, there should be a 10 second delay, then a Puppet run followed by a Munki run will happen.</p>

<p>If you’ve modified <code>CrankTools.py</code>, you can test the changes by running the script directly.</p>

<h2 id="whats-next">What’s next?</h2>

<p>Obviously this is not a good way of deploying crankd - I’ve got a method in the works that will build a package to install this (I currently deploy this with Puppet - I’ll put in a pull request on <a href="https://github.com/glarizza/puppetlabs-crankd">Gary’s module</a> with my changes when I get chance). I’m also going to be doing more with crankd - possibly some application use monitoring, almost certainly some scripts fired off when a machine wakes and sleeps.</p>

      <hr />
      <footer role="contentinfo">
        <div class="social-share">
  <h4>Share on</h4>
  <ul>
    <li>
      <a href="https://twitter.com/intent/tweet?text=http://grahamgilbert.com/blog/2013/07/12/using-crankd-to-react-to-network-events/" class="twitter" title="Share on Twitter"><i class="fa fa-twitter"></i><span> Twitter</span></a>
    </li>
    <li>
      <a href="https://www.facebook.com/sharer/sharer.php?u=http://grahamgilbert.com/blog/2013/07/12/using-crankd-to-react-to-network-events/" class="facebook" title="Share on Facebook"><i class="fa fa-facebook"></i><span> Facebook</span></a>
    </li>
    <li>
      <a href="https://plus.google.com/share?url=http://grahamgilbert.com/blog/2013/07/12/using-crankd-to-react-to-network-events/" class="google-plus" title="Share on Google Plus"><i class="fa fa-google-plus"></i><span> Google+</span></a>
    </li>
  </ul>
</div><!-- /.social-share -->
        <p class="byline"><strong>Using crankd to react to network events</strong> was published on <time datetime="2013-07-12T14:04:00+01:00">July 12, 2013</time>.</p>
      </footer>
    </div><!-- /.article-wrap -->
  
    <section id="disqus_thread"></section><!-- /#disqus_thread -->
  
  </article>
</div><!-- /#main -->

<div class="footer-wrap">
  
  <div class="related-articles">
  <h4>You might also enjoy <small class="pull-right">(<a href="http://grahamgilbert.com/posts/">View all posts</a>)</small></h4>
    <ul>
    
      <li><a href="http://grahamgilbert.com/blog/2015/11/23/releasing-changes-with-sharding/" title="Releasing Changes With Sharding">Releasing Changes With Sharding</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2015/11/12/mactech-2015-hands-on-with-imagr/" title="MacTech 2015: Hands on with Imagr">MacTech 2015: Hands on with Imagr</a></li>
    
      <li><a href="http://grahamgilbert.com/blog/2015/10/15/detecting-when-a-munki-client-is-on-the-corporate-network/" title="Detecting when a Munki client is on the corporate network">Detecting when a Munki client is on the corporate network</a></li>
    
    </ul>
    <hr />
  </div><!-- /.related-articles -->
  
  <footer>
    <span>&copy; 2015 Graham Gilbert. Powered by <a href="http://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="http://mademistakes.com/minimal-mistakes/" rel="nofollow">Minimal Mistakes</a> theme.</span>
  </footer>
</div><!-- /.footer-wrap -->

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="http://grahamgilbert.com/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="http://grahamgilbert.com/assets/js/scripts.min.js"></script>

<!-- Asynchronous Google Analytics snippet -->
<script>
  var _gaq = _gaq || [];
  var pluginUrl =
 '//www.google-analytics.com/plugins/ga/inpage_linkid.js';
  _gaq.push(['_require', 'inpage_linkid', pluginUrl]);
  _gaq.push(['_setAccount', 'UA-27233739-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>


  <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'grahamgilbert'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

</body>
</html>
