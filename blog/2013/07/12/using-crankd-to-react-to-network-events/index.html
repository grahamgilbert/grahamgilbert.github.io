<!DOCTYPE html>
<html lang="en-us">

  <head>
  <script type="text/javascript">
    var host = "grahamgilbert.com";
    if ((host == window.location.host) && (window.location.protocol != "https:"))
        window.location.protocol = "https";
  </script>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  <!-- Enable responsiveness on mobile devices-->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>
    
      Using crankd to react to network events &middot; graham gilbert
    
  </title>

  <!-- CSS -->
  <link rel="stylesheet" href="/public/css/poole.css">
  <link rel="stylesheet" href="/public/css/syntax.css">
  <link rel="stylesheet" href="/public/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  <!-- Icons -->
  <!--link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png">
                                 <link rel="shortcut icon" href="/public/favicon.ico"-->

  <!-- RSS -->
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml">
  <link href='/stylesheets/all-c8369cf731585eb98eef0098877bca87.css' media='all' rel='stylesheet' type='text/css'>
  <link type="application/atom+xml" rel="alternate" href="https://grahamgilbert.com/atom.xml" title="graham gilbert" />
  <style>
  .clear{
    clear:both
  }
  .float-left {
    float:left;
    padding-right:25px;
    padding-bottom:25px;
  }

  .float-right {
    float:right;
    padding-left:25px;
    padding-bottom:25px;
  }
  </style>
</head>

  <body class="theme-base-0d">

    <div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1>
        <a href="/">
          graham gilbert
        </a>
      </h1>
      <p class="lead">A Mac admin, automating the hell out of things in London.</p>
    </div>

    <nav class="sidebar-nav">
      <a class="sidebar-nav-item" href="/">Home</a>

      

      
      
        
          
        
      
        
      
        
      
        
          
        
      
        
          
            <a class="sidebar-nav-item" href="/about/">About</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/projects/">Projects</a>
          
        
      
        
          
            <a class="sidebar-nav-item" href="/talks/">Talks</a>
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
        
          
        
      
      </nav>
      <p>

      <a href="https://twitter.com/grahamgilbert"><img style="display:inline;" src="/images/social/twitter.png" /></a> <a href="https://github.com/grahamgilbert"><img style="display:inline;" src="/images/social/github.png" /></a> <a href="https://www.linkedin.com/in/grahamgilbert"><img style="display:inline;" src="/images/social/linkedin.png" /></a>
      </p>

    <p>
      <small>The opinions on this site are my own, and are not necessarily shared by my employer.</small>
    </p>

  </div>
</div>

    <div class="content container">
      <div class="post">
  <h1 class="post-title">Using crankd to react to network events</h1>
  <span class="post-date">12 Jul 2013</span>
  <p>Updated 14/7/2013: After <a href="https://twitter.com/Sacrilicious/status/355756510535614464">Alister’s suggestion</a>, the script now loops over network interfaces up to en19 (hopefully that’s enough!).</p>

<p>So, you’ve heard of this crankd thing, maybe even had a look at it, but have no idea how to get it going? You’re in the right place. I’m by no means an expert on it, having only been playing with it for less than a week, but I already have it running in production running the simple script below. My initial work, and therefore this post was inspired by Gary Larizza’s <a href="http://web.archive.org/web/20120111031339/http://glarizza.posterous.com/using-crankd-to-react-to-network-events">two</a> <a href="http://garylarizza.com/blog/2011/12/31/using-the-google-macops-crankd-and-facter-code/">articles</a> on the subject.</p>

<h2 id="what-is-crankd">What is crankd?</h2>

<p>It’s part of the <a href="https://github.com/acdha/pymacadmin">PyMacAdmin</a> set of tools that <a href="http://chris.improbable.org/">Chris Adams</a> and <a href="http://explanatorygap.net">Nigel Kersten</a> released a while ago. In a nutshell, it runs in the background via a LaunchDaemon and reacts to events on the Mac by running a script or a Python function, class or method. It has loads of events it knows about (application launches, power events, network events etc), but in this case I wanted to run something when there was a network change. Some of our machines never get turned off (and for some reason the Puppet Launch Daemon has crapped out), or aren’t turned on long enough for Puppet or Munki to run. I wanted a script that would run every time the machine came back onto the network, checking if there was an active connection and run Puppet and Munki.</p>

<h2 id="what-do-i-need-to-do">What do I need to do?</h2>

<p>There are a few parts that we need to bring together to make this work:</p>

<ul>
  <li>The crankd.py executable and the supporting files</li>
  <li>A Launch Daemon to start the thing</li>
  <li>A preferences file to tell crankd what to do</li>
  <li>And finally, our custom code</li>
</ul>

<!-- more -->

<h2 id="get-and-install-crankd">Get and install crankd</h2>

<p>First off, you need to grab the current code from GitHub.</p>

<p><code>
git clone https://github.com/acdha/pymacadmin.git
</code></p>

<p>Then <code>cd</code> into the pymacadmin directory you just cloned and run <code>install-crankd.sh</code>.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="nb">cd</span> ~/src/pymacadmin
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">sudo ./install-crankd.sh</div></div></pre></div></figure>

<p>That will install the crankd.py executable and it’s supporting files, now for the Launch Daemon to make it start at boot. You’ll need to put the following into a file at <code>/Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.plist</code>.</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
&lt;dict&gt;
	&lt;key&gt;KeepAlive&lt;/key&gt;
	&lt;true/&gt;
	&lt;key&gt;Label&lt;/key&gt;
	&lt;string&gt;com.googlecode.pymacadmin.crankd&lt;/string&gt;
	&lt;key&gt;ProgramArguments&lt;/key&gt;
	&lt;array&gt;
		&lt;string&gt;/usr/local/sbin/crankd.py&lt;/string&gt;
	&lt;/array&gt;
	&lt;key&gt;RunAtLoad&lt;/key&gt;
	&lt;true/&gt;
&lt;/dict&gt;
&lt;/plist&gt;
</code></pre>

<p>And set the right ownership and permissions on the plist</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">sudo chmod <span class="m">644</span> /Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.plist
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">sudo chown root:wheel /Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.plist</div></div></pre></div></figure>

<p>So that’s the basics. Now we need to tell crankd what events it should listen to and what it should do.</p>

<p>As we want to call the CrankTools class and the OnNetworkLoad method every time the network changes state, we need to do the following in <code>/Library/Preferences/com.googlecode.pymacadmin.crankd.plist</code>. To see what other events you can use with crankd, head on over to the <a href="https://github.com/acdha/pymacadmin/tree/master/examples/crankd/sample-of-events">GitHub repo</a>.</p>

<pre><code>&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
    &lt;dict&gt;
        &lt;key&gt;SystemConfiguration&lt;/key&gt;
        &lt;dict&gt;
            &lt;key&gt;State:/Network/Global/IPv4&lt;/key&gt;
            &lt;dict&gt;
                &lt;key&gt;method&lt;/key&gt;
                    &lt;array&gt;
                        &lt;string&gt;CrankTools&lt;/string&gt;
                        &lt;string&gt;OnNetworkLoad&lt;/string&gt;
                    &lt;/array&gt;
            &lt;/dict&gt;
        &lt;/dict&gt;
    &lt;/dict&gt;
&lt;/plist&gt;
</code></pre>

<p>Now for the actual Python code. This is very heavily inspired by <a href="http://garylarizza.com">Gary Larizza’s</a> work. We’re checking if either en0 or en1 has a valid network connection (as this event is for any network change - both connecting and disconnecting), and if there is a valid connection, run Puppet and then run Munki. This code could easily be modified to run anything you wanted to at the command line (for example a Casper policy). Put the following script in <code>/Library/Application Support/crankd/CrankTools.py</code>.</p>

<figure class="code-highlight-figure"><figcaption class="code-highlight-caption"><span class="code-highlight-caption-title">CrankTools.py</span></figcaption><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#!/usr/bin/env python</span>
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#</span>
</div></div><div data-line="3" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#    CrankTools.py</span>
</div></div><div data-line="4" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#        The OnNetworkLoad method is called from crankd on a network state change, all other</span>
</div></div><div data-line="5" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#            methods assist it. Modified from Gary Larizza&#39;s script (https://gist.github.com/glarizza/626169).</span>
</div></div><div data-line="6" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#</span>
</div></div><div data-line="7" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="c">#    Last Revised - 10/07/2013</span>
</div></div><div data-line="8" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="9" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">__author__</span> <span class="o">=</span> <span class="s">&#39;Graham Gilbert (graham@grahamgilbert.com)&#39;</span>
</div></div><div data-line="10" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">__version__</span> <span class="o">=</span> <span class="s">&#39;0.6&#39;</span>
</div></div><div data-line="11" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="12" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">syslog</span>
</div></div><div data-line="13" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">import</span> <span class="nn">subprocess</span>
</div></div><div data-line="14" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>
</div></div><div data-line="15" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="16" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="n">syslog</span><span class="o">.</span><span class="n">openlog</span><span class="p">(</span><span class="s">&quot;CrankD&quot;</span><span class="p">)</span>
</div></div><div data-line="17" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="18" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">class</span> <span class="nc">CrankTools</span><span class="p">():</span>
</div></div><div data-line="19" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="sd">&quot;&quot;&quot;The main CrankTools class needed for our crankd config plist&quot;&quot;&quot;</span>
</div></div><div data-line="20" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="21" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">puppetRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</div></div><div data-line="22" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;Checks for an active network connection and calls puppet if it finds one.</span>
</div></div><div data-line="23" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            If the network is NOT active, it logs an error and exits</span>
</div></div><div data-line="24" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="25" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments: None</span>
</div></div><div data-line="26" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns:  Nothing</span>
</div></div><div data-line="27" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="28" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/puppet&#39;</span><span class="p">,</span><span class="s">&#39;agent&#39;</span><span class="p">,</span><span class="s">&#39;-t&#39;</span><span class="p">]</span>
</div></div><div data-line="29" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LinkState</span><span class="p">():</span>
</div></div><div data-line="30" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="bp">self</span><span class="o">.</span><span class="n">callCmd</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div></div><div data-line="31" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="32" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">syslog</span><span class="o">.</span><span class="n">syslog</span><span class="p">(</span><span class="n">syslog</span><span class="o">.</span><span class="n">LOG_ALERT</span><span class="p">,</span> <span class="s">&quot;Internet Connection Not Found, Puppet Run Exiting...&quot;</span><span class="p">)</span>
</div></div><div data-line="33" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="34" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">munkiRun</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</div></div><div data-line="35" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;Checks for an active network connection and calls Munki if it finds one.</span>
</div></div><div data-line="36" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            If the network is NOT active, it logs an error and exits</span>
</div></div><div data-line="37" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="38" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments: None</span>
</div></div><div data-line="39" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns:  Nothing</span>
</div></div><div data-line="40" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="41" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/local/munki/managedsoftwareupdate&#39;</span><span class="p">,</span><span class="s">&#39;--auto&#39;</span><span class="p">]</span>
</div></div><div data-line="42" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">LinkState</span><span class="p">():</span>
</div></div><div data-line="43" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="bp">self</span><span class="o">.</span><span class="n">callCmd</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</div></div><div data-line="44" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">else</span><span class="p">:</span>
</div></div><div data-line="45" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">syslog</span><span class="o">.</span><span class="n">syslog</span><span class="p">(</span><span class="n">syslog</span><span class="o">.</span><span class="n">LOG_ALERT</span><span class="p">,</span> <span class="s">&quot;Internet Connection Not Found, Munki Run Exiting...&quot;</span><span class="p">)</span>
</div></div><div data-line="46" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="47" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">callCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
</div></div><div data-line="48" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;Simple utility function that calls a command via subprocess</span>
</div></div><div data-line="49" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="50" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments: command - A list of arguments for the command</span>
</div></div><div data-line="51" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns: Nothing</span>
</div></div><div data-line="52" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="53" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">task</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
</div></div><div data-line="54" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">task</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
</div></div><div data-line="55" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="56" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">LinkState</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</div></div><div data-line="57" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;This utility returns the status of the passed interface.</span>
</div></div><div data-line="58" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="59" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments:</span>
</div></div><div data-line="60" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            None</span>
</div></div><div data-line="61" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns:</span>
</div></div><div data-line="62" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            status - The return code of the subprocess call</span>
</div></div><div data-line="63" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="64" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="65" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">theState</span> <span class="o">=</span> <span class="bp">False</span>
</div></div><div data-line="66" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="67" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">for</span> <span class="n">interface</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">):</span>
</div></div><div data-line="68" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">interface</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">interface</span><span class="p">)</span>
</div></div><div data-line="69" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="n">adapter</span> <span class="o">=</span> <span class="s">&#39;en&#39;</span> <span class="o">+</span> <span class="n">interface</span>
</div></div><div data-line="70" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">print</span> <span class="s">&#39;checking adapter &#39;</span><span class="o">+</span><span class="n">adapter</span>
</div></div><div data-line="71" class="code-highlight-row numbered"><div class="code-highlight-line">            <span class="k">if</span> <span class="ow">not</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">call</span><span class="p">([</span><span class="s">&quot;ipconfig&quot;</span><span class="p">,</span> <span class="s">&quot;getifaddr&quot;</span><span class="p">,</span> <span class="n">adapter</span><span class="p">]):</span>
</div></div><div data-line="72" class="code-highlight-row numbered"><div class="code-highlight-line">                <span class="n">theState</span> <span class="o">=</span> <span class="bp">True</span>
</div></div><div data-line="73" class="code-highlight-row numbered"><div class="code-highlight-line">                <span class="k">break</span>
</div></div><div data-line="74" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="75" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="k">return</span> <span class="n">theState</span>
</div></div><div data-line="76" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="77" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="k">def</span> <span class="nf">OnNetworkLoad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
</div></div><div data-line="78" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="sd">&quot;&quot;&quot;Called from crankd directly on a Network State Change. We sleep for 10 seconds to ensure that</span>
</div></div><div data-line="79" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            an IP address has been cleared or attained, and then perform a Puppet run and a Munki run.</span>
</div></div><div data-line="80" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        ---</span>
</div></div><div data-line="81" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Arguments:</span>
</div></div><div data-line="82" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">            *args and **kwargs - Catchall arguments coming from crankd</span>
</div></div><div data-line="83" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        Returns:  Nothing</span>
</div></div><div data-line="84" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="sd">        &quot;&quot;&quot;</span>
</div></div><div data-line="85" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="n">sleep</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</div></div><div data-line="86" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="bp">self</span><span class="o">.</span><span class="n">puppetRun</span><span class="p">()</span>
</div></div><div data-line="87" class="code-highlight-row numbered"><div class="code-highlight-line">        <span class="bp">self</span><span class="o">.</span><span class="n">munkiRun</span><span class="p">()</span>
</div></div><div data-line="88" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="89" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
</div></div><div data-line="90" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">crank</span> <span class="o">=</span> <span class="n">CrankTools</span><span class="p">()</span>
</div></div><div data-line="91" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">crank</span><span class="o">.</span><span class="n">OnNetworkLoad</span><span class="p">()</span>
</div></div><div data-line="92" class="code-highlight-row numbered"><div class="code-highlight-line"> </div></div><div data-line="93" class="code-highlight-row numbered"><div class="code-highlight-line"><span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>  
</div></div><div data-line="94" class="code-highlight-row numbered"><div class="code-highlight-line">    <span class="n">main</span><span class="p">()</span></div></div></pre></div></figure>

<p>It’s ok, we’re nearly there! You just need to set the right owner on <code>CrankTools.py</code> , load the Launch Daemon and we can get testing.</p>

<figure class="code-highlight-figure"><div class="code-highlight"><pre class="code-highlight-pre"><div data-line="1" class="code-highlight-row numbered"><div class="code-highlight-line">sudo chown root:wheel /Library/Application Support/crankd/CrankTools.py
</div></div><div data-line="2" class="code-highlight-row numbered"><div class="code-highlight-line">sudo launchctl load /Library/LaunchDaemons/com.googlecode.pymacadmin.crankd.plist`</div></div></pre></div></figure>

<p>You’re all set. Disconnect your network connection and re-connect. Put your Mac to sleep and wake it up. Each time, there should be a 10 second delay, then a Puppet run followed by a Munki run will happen.</p>

<p>If you’ve modified <code>CrankTools.py</code>, you can test the changes by running the script directly.</p>

<h2 id="whats-next">What’s next?</h2>

<p>Obviously this is not a good way of deploying crankd - I’ve got a method in the works that will build a package to install this (I currently deploy this with Puppet - I’ll put in a pull request on <a href="https://github.com/glarizza/puppetlabs-crankd">Gary’s module</a> with my changes when I get chance). I’m also going to be doing more with crankd - possibly some application use monitoring, almost certainly some scripts fired off when a machine wakes and sleeps.</p>

</div>

<div id="disqus_thread"></div>
<script>
    /**
     *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
     *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
     */
    /*
    var disqus_config = function () {
        this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
        this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() {  // DON'T EDIT BELOW THIS LINE
        var d = document, s = d.createElement('script');

        s.src = '//grahamgilbert.disqus.com/embed.js';

        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>

<div class="related">
  <h2>Related Posts</h2>
  <ul class="related-posts">
    
      <li>
        <h3>
          <a href="/blog/2016/09/05/return-of-the-yo-notifications/">
            Return of the Yo notifications
            <small>05 Sep 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/08/29/more-notifications-with-yo-the-yo-strikes-back/">
            More notifications with Yo: The Yo Strikes Back
            <small>29 Aug 2016</small>
          </a>
        </h3>
      </li>
    
      <li>
        <h3>
          <a href="/blog/2016/08/23/nicer-notifications-with-yo/">
            Nicer notifications with Yo
            <small>23 Aug 2016</small>
          </a>
        </h3>
      </li>
    
  </ul>
</div>

    </div>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-27233739-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
